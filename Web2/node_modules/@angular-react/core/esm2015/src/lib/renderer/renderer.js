// Copyright (c) Microsoft Corporation. All rights reserved.
// Licensed under the MIT License.
import * as tslib_1 from "tslib";
import { Injectable, RendererStyleFlags2 } from '@angular/core';
import { EventManager, ɵDomRendererFactory2, ɵDomSharedStylesHost } from '@angular/platform-browser';
import { Disguise } from './components/Disguise';
import { ReactContent } from './react-content';
import { isReactNode, ReactNode } from './react-node';
import { registerElement } from './registry';
import './geteventlisteners';
const DEBUG = false;
let AngularReactRendererFactory = class AngularReactRendererFactory extends ɵDomRendererFactory2 {
    constructor(eventManager, sharedStylesHost) {
        super(eventManager, sharedStylesHost, 'app-id');
        // Collection of ReactNodes that can be evaluated and flushed at the
        // end of Render.  This is necessary as the flow of element creation
        // and update goes from "create" > "insert" > "update" property/attribute.
        // React elements cannot be "inserted" and later have their props
        // updated, so the "insert", or React.Render, can only be done once the
        // element has been fully defined.  Only the topmost [root] nodes are added here.
        this.reactRootNodes = new Set();
        // This flag can only be set to true from outside.  It can only be reset
        // to false from inside.  This value is reset on "end" when the pending
        // renders are flushed.
        this.setRenderPendingCallback = () => {
            this.isRenderPending = true;
        };
        // tslint:disable-next-line: no-use-before-declare
        this.defaultReactRenderer = new ReactRenderer(this);
    }
    createRenderer(element, type) {
        if (type && type.styles.length && type.styles[0] === 'react-renderer') {
            return this.defaultReactRenderer;
        }
        return super.createRenderer(element, type);
    }
    begin() { }
    end() {
        if (DEBUG) {
            console.log('RootRenderer > end > isRenderPending:', this.isRenderPending, 'reactRootNodes:', this.reactRootNodes);
        }
        // Flush any pending React element render updates.  This cannot be done
        // earlier (as is done for DOM elements) because React element props
        // are ReadOnly.
        if (this.isRenderPending) {
            // Remove root nodes that are pending destroy after render.
            this.reactRootNodes = new Set(Array.from(this.reactRootNodes).filter(node => !node.render().destroyPending));
            this.isRenderPending = false;
        }
    }
};
AngularReactRendererFactory = tslib_1.__decorate([
    Injectable(),
    tslib_1.__metadata("design:paramtypes", [EventManager, ɵDomSharedStylesHost])
], AngularReactRendererFactory);
export { AngularReactRendererFactory };
export const isReactRendererData = (data) => data && typeof data.addRootNode === 'function';
export class ReactRenderer {
    constructor(rootRenderer) {
        this.rootRenderer = rootRenderer;
        this.data = {
            addRootNode: (node) => {
                this.rootRenderer.reactRootNodes.add(node);
            },
        };
        // These two elements are essential for the whole experience to be smooth for the user - register them from the get-go.
        registerElement('ReactContent', () => ReactContent);
        registerElement('Disguise', () => Disguise);
    }
    destroy() { }
    destroyNode(node) {
        if (DEBUG) {
            console.error('Renderer > destroyNode > node:', node.toString());
        }
        node.destroyNode();
    }
    createElement(name, namespace) {
        if (DEBUG) {
            console.error('Renderer > createElement > name:', name, namespace ? 'namespace:' : '', namespace);
        }
        return new ReactNode(name);
    }
    createComment(value) {
        if (DEBUG) {
            console.error('Renderer > createComment > value:', value.trim());
        }
        return new ReactNode().asComment(value);
    }
    createText(value) {
        if (DEBUG) {
            console.error('Renderer > createText > value:', value.trim());
        }
        return new ReactNode().asText(value);
    }
    appendChild(parent, node) {
        // Only append a child if there is a child to append.
        if (!node) {
            return;
        }
        // Don't append empty text nodes.
        if (!node.shouldRender) {
            return;
        }
        // Provide a parent element reference to the ReactNode.  This will be used later
        // once the ReactNode is fully defined and it is subsequently rendered.
        if (!isReactNode(parent)) {
            if (DEBUG) {
                console.warn('Renderer > appendChild > asDOM > parent:', parent.toString(), 'node:', node.toString());
            }
            node.setRenderPendingCallback = this.rootRenderer.setRenderPendingCallback;
            this.rootRenderer.reactRootNodes.add(node);
            node.parent = parent;
            return;
        }
        if (DEBUG) {
            console.warn('Renderer > appendChild > asReact > parent:', parent.toString(), 'node:', node.toString());
        }
        node.setRenderPendingCallback = () => parent.setRenderPending();
        parent.addChild(node);
        node.parent = parent;
    }
    insertBefore(parent, node, refChild) {
        // Only insert a child if there is a parent.
        if (!parent) {
            return;
        }
        // Provide a parent element reference to the ReactNode.  This will be used later
        // once the ReactNode is fully defined and it is subsequently rendered.  In this
        // case, React cannot "insertBefore".  Instead, we have to create a target element
        // where the ReactNode can be rendered later.
        if (DEBUG) {
            console.warn('Renderer > insertBefore > asDOM > parent:', parent.toString(), 'node:', node.toString(), 'refChild:', refChild.toString());
        }
        const target = document.createElement('div');
        parent.insertBefore(target, refChild);
        node.parent = target;
        node.setRenderPendingCallback = this.rootRenderer.setRenderPendingCallback;
    }
    removeChild(parent, node) {
        // Only insert a child if there is a parent.
        if (!parent) {
            return;
        }
        // Remove a parent element reference from the ReactNode.  This will be later
        // result in the ReactNode unloading itself.
        if (!isReactNode(parent)) {
            if (DEBUG) {
                console.warn('Renderer > removeChild > asDOM > parent:', parent.toString(), 'node:', node.toString());
            }
            node.parent = null;
            return;
        }
        if (DEBUG) {
            console.warn('Renderer > removeChild > asReact > parent:', parent.toString(), 'node:', node.toString());
        }
        parent.removeChild(node);
    }
    selectRootElement(selectorOrNode) {
        if (DEBUG) {
            console.log('NOT IMPLEMENTED - Renderer > selectRootElement > selectorOrNode:', selectorOrNode);
        }
    }
    parentNode(node) {
        if (DEBUG) {
            console.log('NOT IMPLEMENTED - Renderer > parentNode > node:', node.toString());
        }
    }
    nextSibling(node) {
        if (DEBUG) {
            console.log('NOT IMPLEMENTED - Renderer > nextSibling > node:', node.toString());
        }
    }
    setAttribute(node, name, value, namespace) {
        if (DEBUG) {
            console.log('Renderer > setAttribute > node:', node.toString(), 'name:', name, 'value:', value, namespace ? 'namespace:' : '', namespace);
        }
        node.setProperty(name, value);
    }
    removeAttribute(node, name, namespace) {
        if (DEBUG) {
            console.log('Renderer > removeAttribute > node:', node.toString(), 'name:', name, namespace ? 'namespace:' : '', namespace);
        }
        node.removeProperty(name);
    }
    addClass(node, name) {
        if (DEBUG) {
            console.log('Renderer > addClass > node:', node.toString(), 'name:', name);
        }
        // Update the virtual node.
        // TODO: This may only support a single class name, but might work if property name is a single
        //       comma-delimited list of classes...
        node.setProperty('className', name);
    }
    removeClass(node, name) {
        if (DEBUG) {
            console.log('Renderer > removeClass > node:', node.toString(), 'name:', name);
        }
        // Update the virtual node.
        // TODO: This may not work correctly to remove a single name from a comma-delimited list.
        node.removeProperty('className');
    }
    setStyle(node, style, value, flags) {
        // if (DEBUG) { console.log('Renderer > setStyle > node: ', node.toString(), 'style:', style, 'value:', value, 'flags:', flags); }
        if (flags & RendererStyleFlags2.DashCase) {
            node.setProperty('style', { style: value + !!(flags & RendererStyleFlags2.Important) ? ' !important' : '' });
        }
        else {
            node.setProperty('style', { style: value });
        }
    }
    removeStyle(node, style, flags) {
        if (DEBUG) {
            console.log('Renderer > removeStyle > node:', node.toString(), 'style:', style, 'flags:', flags);
        }
        node.removeProperty('style', style);
    }
    setProperty(node, name, value) {
        if (DEBUG) {
            console.log('Renderer > setProperty > node:', node.toString(), 'name:', name, 'value:', value);
        }
        node.setProperty(name, value);
    }
    setValue(node, value) {
        if (DEBUG) {
            console.log('Renderer > setValue > node:', node.toString(), 'value:', value);
        }
        node.setProperty('value', value);
    }
    listen(target, event, callback) {
        if (DEBUG) {
            console.log('Renderer > listen > target:', target, 'event:', event);
        }
        target.setProperty(event, callback);
        // TODO: NEEDS WORK: Implement prevent default callback behavior.
        // return <() => void>this.eventManager.addEventListener(
        //            target, event, decoratePreventDefault(callback)) as() => void;
        // tslint:disable-next-line:no-unused-expression
        return () => null;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVuZGVyZXIuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AYW5ndWxhci1yZWFjdC9jb3JlLyIsInNvdXJjZXMiOlsic3JjL2xpYi9yZW5kZXJlci9yZW5kZXJlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSw0REFBNEQ7QUFDNUQsa0NBQWtDOztBQUVsQyxPQUFPLEVBQUUsVUFBVSxFQUFhLG1CQUFtQixFQUFpQixNQUFNLGVBQWUsQ0FBQztBQUMxRixPQUFPLEVBQUUsWUFBWSxFQUFFLG9CQUFvQixFQUFFLG9CQUFvQixFQUFFLE1BQU0sMkJBQTJCLENBQUM7QUFFckcsT0FBTyxFQUFFLFFBQVEsRUFBRSxNQUFNLHVCQUF1QixDQUFDO0FBQ2pELE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUMvQyxPQUFPLEVBQUUsV0FBVyxFQUFFLFNBQVMsRUFBRSxNQUFNLGNBQWMsQ0FBQztBQUN0RCxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sWUFBWSxDQUFDO0FBQzdDLE9BQU8scUJBQXFCLENBQUM7QUFFN0IsTUFBTSxLQUFLLEdBQUcsS0FBSyxDQUFDO0FBR3BCLElBQWEsMkJBQTJCLEdBQXhDLE1BQWEsMkJBQTRCLFNBQVEsb0JBQW9CO0lBb0JuRSxZQUFZLFlBQTBCLEVBQUUsZ0JBQXNDO1FBQzVFLEtBQUssQ0FBQyxZQUFZLEVBQUUsZ0JBQWdCLEVBQUUsUUFBUSxDQUFDLENBQUM7UUFsQmxELG9FQUFvRTtRQUNwRSxvRUFBb0U7UUFDcEUsMEVBQTBFO1FBQzFFLGlFQUFpRTtRQUNqRSx1RUFBdUU7UUFDdkUsaUZBQWlGO1FBQzFFLG1CQUFjLEdBQW1CLElBQUksR0FBRyxFQUFFLENBQUM7UUFJbEQsd0VBQXdFO1FBQ3hFLHVFQUF1RTtRQUN2RSx1QkFBdUI7UUFDUCw2QkFBd0IsR0FBRyxHQUFHLEVBQUU7WUFDOUMsSUFBSSxDQUFDLGVBQWUsR0FBRyxJQUFJLENBQUM7UUFDOUIsQ0FBQyxDQUFDO1FBS0Esa0RBQWtEO1FBQ2xELElBQUksQ0FBQyxvQkFBb0IsR0FBRyxJQUFJLGFBQWEsQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUN0RCxDQUFDO0lBRUQsY0FBYyxDQUFDLE9BQVksRUFBRSxJQUEwQjtRQUNyRCxJQUFJLElBQUksSUFBSSxJQUFJLENBQUMsTUFBTSxDQUFDLE1BQU0sSUFBSSxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxLQUFLLGdCQUFnQixFQUFFO1lBQ3JFLE9BQU8sSUFBSSxDQUFDLG9CQUFvQixDQUFDO1NBQ2xDO1FBRUQsT0FBTyxLQUFLLENBQUMsY0FBYyxDQUFDLE9BQU8sRUFBRSxJQUFJLENBQUMsQ0FBQztJQUM3QyxDQUFDO0lBRUQsS0FBSyxLQUFJLENBQUM7SUFFVixHQUFHO1FBQ0QsSUFBSSxLQUFLLEVBQUU7WUFDVCxPQUFPLENBQUMsR0FBRyxDQUNULHVDQUF1QyxFQUN2QyxJQUFJLENBQUMsZUFBZSxFQUNwQixpQkFBaUIsRUFDakIsSUFBSSxDQUFDLGNBQWMsQ0FDcEIsQ0FBQztTQUNIO1FBRUQsdUVBQXVFO1FBQ3ZFLG9FQUFvRTtRQUNwRSxnQkFBZ0I7UUFFaEIsSUFBSSxJQUFJLENBQUMsZUFBZSxFQUFFO1lBQ3hCLDJEQUEyRDtZQUMzRCxJQUFJLENBQUMsY0FBYyxHQUFHLElBQUksR0FBRyxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLGNBQWMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFDLGNBQWMsQ0FBQyxDQUFDLENBQUM7WUFDN0csSUFBSSxDQUFDLGVBQWUsR0FBRyxLQUFLLENBQUM7U0FDOUI7SUFDSCxDQUFDO0NBQ0YsQ0FBQTtBQXpEWSwyQkFBMkI7SUFEdkMsVUFBVSxFQUFFOzZDQXFCZSxZQUFZLEVBQW9CLG9CQUFvQjtHQXBCbkUsMkJBQTJCLENBeUR2QztTQXpEWSwyQkFBMkI7QUEyRHhDLE1BQU0sQ0FBQyxNQUFNLG1CQUFtQixHQUFHLENBQUMsSUFBZSxFQUE2QixFQUFFLENBQ2hGLElBQUksSUFBSSxPQUFRLElBQTBCLENBQUMsV0FBVyxLQUFLLFVBQVUsQ0FBQztBQU14RSxNQUFNLE9BQU8sYUFBYTtJQU94QixZQUE0QixZQUF5QztRQUF6QyxpQkFBWSxHQUFaLFlBQVksQ0FBNkI7UUFONUQsU0FBSSxHQUFzQjtZQUNqQyxXQUFXLEVBQUUsQ0FBQyxJQUFlLEVBQUUsRUFBRTtnQkFDL0IsSUFBSSxDQUFDLFlBQVksQ0FBQyxjQUFjLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFDO1lBQzdDLENBQUM7U0FDRixDQUFDO1FBR0EsdUhBQXVIO1FBQ3ZILGVBQWUsQ0FBQyxjQUFjLEVBQUUsR0FBRyxFQUFFLENBQUMsWUFBWSxDQUFDLENBQUM7UUFDcEQsZUFBZSxDQUFDLFVBQVUsRUFBRSxHQUFHLEVBQUUsQ0FBQyxRQUFRLENBQUMsQ0FBQztJQUM5QyxDQUFDO0lBRUQsT0FBTyxLQUFVLENBQUM7SUFFbEIsV0FBVyxDQUFDLElBQWU7UUFDekIsSUFBSSxLQUFLLEVBQUU7WUFDVCxPQUFPLENBQUMsS0FBSyxDQUFDLGdDQUFnQyxFQUFFLElBQUksQ0FBQyxRQUFRLEVBQUUsQ0FBQyxDQUFDO1NBQ2xFO1FBQ0QsSUFBSSxDQUFDLFdBQVcsRUFBRSxDQUFDO0lBQ3JCLENBQUM7SUFFRCxhQUFhLENBQUMsSUFBWSxFQUFFLFNBQWtCO1FBQzVDLElBQUksS0FBSyxFQUFFO1lBQ1QsT0FBTyxDQUFDLEtBQUssQ0FBQyxrQ0FBa0MsRUFBRSxJQUFJLEVBQUUsU0FBUyxDQUFDLENBQUMsQ0FBQyxZQUFZLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxTQUFTLENBQUMsQ0FBQztTQUNuRztRQUNELE9BQU8sSUFBSSxTQUFTLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDN0IsQ0FBQztJQUVELGFBQWEsQ0FBQyxLQUFhO1FBQ3pCLElBQUksS0FBSyxFQUFFO1lBQ1QsT0FBTyxDQUFDLEtBQUssQ0FBQyxtQ0FBbUMsRUFBRSxLQUFLLENBQUMsSUFBSSxFQUFFLENBQUMsQ0FBQztTQUNsRTtRQUNELE9BQU8sSUFBSSxTQUFTLEVBQUUsQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDMUMsQ0FBQztJQUVELFVBQVUsQ0FBQyxLQUFhO1FBQ3RCLElBQUksS0FBSyxFQUFFO1lBQ1QsT0FBTyxDQUFDLEtBQUssQ0FBQyxnQ0FBZ0MsRUFBRSxLQUFLLENBQUMsSUFBSSxFQUFFLENBQUMsQ0FBQztTQUMvRDtRQUNELE9BQU8sSUFBSSxTQUFTLEVBQUUsQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDdkMsQ0FBQztJQUVELFdBQVcsQ0FBQyxNQUErQixFQUFFLElBQWU7UUFDMUQscURBQXFEO1FBQ3JELElBQUksQ0FBQyxJQUFJLEVBQUU7WUFDVCxPQUFPO1NBQ1I7UUFFRCxpQ0FBaUM7UUFDakMsSUFBSSxDQUFDLElBQUksQ0FBQyxZQUFZLEVBQUU7WUFDdEIsT0FBTztTQUNSO1FBRUQsZ0ZBQWdGO1FBQ2hGLHVFQUF1RTtRQUN2RSxJQUFJLENBQUMsV0FBVyxDQUFDLE1BQU0sQ0FBQyxFQUFFO1lBQ3hCLElBQUksS0FBSyxFQUFFO2dCQUNULE9BQU8sQ0FBQyxJQUFJLENBQUMsMENBQTBDLEVBQUUsTUFBTSxDQUFDLFFBQVEsRUFBRSxFQUFFLE9BQU8sRUFBRSxJQUFJLENBQUMsUUFBUSxFQUFFLENBQUMsQ0FBQzthQUN2RztZQUNELElBQUksQ0FBQyx3QkFBd0IsR0FBRyxJQUFJLENBQUMsWUFBWSxDQUFDLHdCQUF3QixDQUFDO1lBRTNFLElBQUksQ0FBQyxZQUFZLENBQUMsY0FBYyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUMzQyxJQUFJLENBQUMsTUFBTSxHQUFHLE1BQU0sQ0FBQztZQUNyQixPQUFPO1NBQ1I7UUFFRCxJQUFJLEtBQUssRUFBRTtZQUNULE9BQU8sQ0FBQyxJQUFJLENBQUMsNENBQTRDLEVBQUUsTUFBTSxDQUFDLFFBQVEsRUFBRSxFQUFFLE9BQU8sRUFBRSxJQUFJLENBQUMsUUFBUSxFQUFFLENBQUMsQ0FBQztTQUN6RztRQUVELElBQUksQ0FBQyx3QkFBd0IsR0FBRyxHQUFHLEVBQUUsQ0FBQyxNQUFNLENBQUMsZ0JBQWdCLEVBQUUsQ0FBQztRQUNoRSxNQUFNLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ3RCLElBQUksQ0FBQyxNQUFNLEdBQUcsTUFBTSxDQUFDO0lBQ3ZCLENBQUM7SUFFRCxZQUFZLENBQUMsTUFBMEIsRUFBRSxJQUFlLEVBQUUsUUFBYTtRQUNyRSw0Q0FBNEM7UUFDNUMsSUFBSSxDQUFDLE1BQU0sRUFBRTtZQUNYLE9BQU87U0FDUjtRQUVELGdGQUFnRjtRQUNoRixnRkFBZ0Y7UUFDaEYsa0ZBQWtGO1FBQ2xGLDZDQUE2QztRQUM3QyxJQUFJLEtBQUssRUFBRTtZQUNULE9BQU8sQ0FBQyxJQUFJLENBQ1YsMkNBQTJDLEVBQzNDLE1BQU0sQ0FBQyxRQUFRLEVBQUUsRUFDakIsT0FBTyxFQUNQLElBQUksQ0FBQyxRQUFRLEVBQUUsRUFDZixXQUFXLEVBQ1gsUUFBUSxDQUFDLFFBQVEsRUFBRSxDQUNwQixDQUFDO1NBQ0g7UUFDRCxNQUFNLE1BQU0sR0FBRyxRQUFRLENBQUMsYUFBYSxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQzdDLE1BQU0sQ0FBQyxZQUFZLENBQUMsTUFBTSxFQUFFLFFBQVEsQ0FBQyxDQUFDO1FBQ3RDLElBQUksQ0FBQyxNQUFNLEdBQUcsTUFBTSxDQUFDO1FBQ3JCLElBQUksQ0FBQyx3QkFBd0IsR0FBRyxJQUFJLENBQUMsWUFBWSxDQUFDLHdCQUF3QixDQUFDO0lBQzdFLENBQUM7SUFFRCxXQUFXLENBQUMsTUFBc0MsRUFBRSxJQUFlO1FBQ2pFLDRDQUE0QztRQUM1QyxJQUFJLENBQUMsTUFBTSxFQUFFO1lBQ1gsT0FBTztTQUNSO1FBRUQsNEVBQTRFO1FBQzVFLDRDQUE0QztRQUM1QyxJQUFJLENBQUMsV0FBVyxDQUFDLE1BQU0sQ0FBQyxFQUFFO1lBQ3hCLElBQUksS0FBSyxFQUFFO2dCQUNULE9BQU8sQ0FBQyxJQUFJLENBQUMsMENBQTBDLEVBQUUsTUFBTSxDQUFDLFFBQVEsRUFBRSxFQUFFLE9BQU8sRUFBRSxJQUFJLENBQUMsUUFBUSxFQUFFLENBQUMsQ0FBQzthQUN2RztZQUNELElBQUksQ0FBQyxNQUFNLEdBQUcsSUFBSSxDQUFDO1lBQ25CLE9BQU87U0FDUjtRQUVELElBQUksS0FBSyxFQUFFO1lBQ1QsT0FBTyxDQUFDLElBQUksQ0FBQyw0Q0FBNEMsRUFBRSxNQUFNLENBQUMsUUFBUSxFQUFFLEVBQUUsT0FBTyxFQUFFLElBQUksQ0FBQyxRQUFRLEVBQUUsQ0FBQyxDQUFDO1NBQ3pHO1FBQ0QsTUFBTSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUMzQixDQUFDO0lBRUQsaUJBQWlCLENBQUMsY0FBNEI7UUFDNUMsSUFBSSxLQUFLLEVBQUU7WUFDVCxPQUFPLENBQUMsR0FBRyxDQUFDLGtFQUFrRSxFQUFFLGNBQWMsQ0FBQyxDQUFDO1NBQ2pHO0lBQ0gsQ0FBQztJQUVELFVBQVUsQ0FBQyxJQUFlO1FBQ3hCLElBQUksS0FBSyxFQUFFO1lBQ1QsT0FBTyxDQUFDLEdBQUcsQ0FBQyxpREFBaUQsRUFBRSxJQUFJLENBQUMsUUFBUSxFQUFFLENBQUMsQ0FBQztTQUNqRjtJQUNILENBQUM7SUFFRCxXQUFXLENBQUMsSUFBUztRQUNuQixJQUFJLEtBQUssRUFBRTtZQUNULE9BQU8sQ0FBQyxHQUFHLENBQUMsa0RBQWtELEVBQUUsSUFBSSxDQUFDLFFBQVEsRUFBRSxDQUFDLENBQUM7U0FDbEY7SUFDSCxDQUFDO0lBRUQsWUFBWSxDQUFDLElBQWUsRUFBRSxJQUFZLEVBQUUsS0FBYSxFQUFFLFNBQWtCO1FBQzNFLElBQUksS0FBSyxFQUFFO1lBQ1QsT0FBTyxDQUFDLEdBQUcsQ0FDVCxpQ0FBaUMsRUFDakMsSUFBSSxDQUFDLFFBQVEsRUFBRSxFQUNmLE9BQU8sRUFDUCxJQUFJLEVBQ0osUUFBUSxFQUNSLEtBQUssRUFDTCxTQUFTLENBQUMsQ0FBQyxDQUFDLFlBQVksQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUM3QixTQUFTLENBQ1YsQ0FBQztTQUNIO1FBQ0QsSUFBSSxDQUFDLFdBQVcsQ0FBQyxJQUFJLEVBQUUsS0FBSyxDQUFDLENBQUM7SUFDaEMsQ0FBQztJQUVELGVBQWUsQ0FBQyxJQUFlLEVBQUUsSUFBWSxFQUFFLFNBQWtCO1FBQy9ELElBQUksS0FBSyxFQUFFO1lBQ1QsT0FBTyxDQUFDLEdBQUcsQ0FDVCxvQ0FBb0MsRUFDcEMsSUFBSSxDQUFDLFFBQVEsRUFBRSxFQUNmLE9BQU8sRUFDUCxJQUFJLEVBQ0osU0FBUyxDQUFDLENBQUMsQ0FBQyxZQUFZLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFDN0IsU0FBUyxDQUNWLENBQUM7U0FDSDtRQUNELElBQUksQ0FBQyxjQUFjLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDNUIsQ0FBQztJQUVELFFBQVEsQ0FBQyxJQUFlLEVBQUUsSUFBWTtRQUNwQyxJQUFJLEtBQUssRUFBRTtZQUNULE9BQU8sQ0FBQyxHQUFHLENBQUMsNkJBQTZCLEVBQUUsSUFBSSxDQUFDLFFBQVEsRUFBRSxFQUFFLE9BQU8sRUFBRSxJQUFJLENBQUMsQ0FBQztTQUM1RTtRQUVELDJCQUEyQjtRQUMzQiwrRkFBK0Y7UUFDL0YsMkNBQTJDO1FBQzNDLElBQUksQ0FBQyxXQUFXLENBQUMsV0FBVyxFQUFFLElBQUksQ0FBQyxDQUFDO0lBQ3RDLENBQUM7SUFFRCxXQUFXLENBQUMsSUFBZSxFQUFFLElBQVk7UUFDdkMsSUFBSSxLQUFLLEVBQUU7WUFDVCxPQUFPLENBQUMsR0FBRyxDQUFDLGdDQUFnQyxFQUFFLElBQUksQ0FBQyxRQUFRLEVBQUUsRUFBRSxPQUFPLEVBQUUsSUFBSSxDQUFDLENBQUM7U0FDL0U7UUFFRCwyQkFBMkI7UUFDM0IseUZBQXlGO1FBQ3pGLElBQUksQ0FBQyxjQUFjLENBQUMsV0FBVyxDQUFDLENBQUM7SUFDbkMsQ0FBQztJQUVELFFBQVEsQ0FBQyxJQUFlLEVBQUUsS0FBYSxFQUFFLEtBQVUsRUFBRSxLQUEwQjtRQUM3RSxrSUFBa0k7UUFDbEksSUFBSSxLQUFLLEdBQUcsbUJBQW1CLENBQUMsUUFBUSxFQUFFO1lBQ3hDLElBQUksQ0FBQyxXQUFXLENBQUMsT0FBTyxFQUFFLEVBQUUsS0FBSyxFQUFFLEtBQUssR0FBRyxDQUFDLENBQUMsQ0FBQyxLQUFLLEdBQUcsbUJBQW1CLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxDQUFDLGFBQWEsQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQztTQUM5RzthQUFNO1lBQ0wsSUFBSSxDQUFDLFdBQVcsQ0FBQyxPQUFPLEVBQUUsRUFBRSxLQUFLLEVBQUUsS0FBSyxFQUFFLENBQUMsQ0FBQztTQUM3QztJQUNILENBQUM7SUFFRCxXQUFXLENBQUMsSUFBZSxFQUFFLEtBQWEsRUFBRSxLQUEwQjtRQUNwRSxJQUFJLEtBQUssRUFBRTtZQUNULE9BQU8sQ0FBQyxHQUFHLENBQUMsZ0NBQWdDLEVBQUUsSUFBSSxDQUFDLFFBQVEsRUFBRSxFQUFFLFFBQVEsRUFBRSxLQUFLLEVBQUUsUUFBUSxFQUFFLEtBQUssQ0FBQyxDQUFDO1NBQ2xHO1FBQ0QsSUFBSSxDQUFDLGNBQWMsQ0FBQyxPQUFPLEVBQUUsS0FBSyxDQUFDLENBQUM7SUFDdEMsQ0FBQztJQUVELFdBQVcsQ0FBQyxJQUFlLEVBQUUsSUFBWSxFQUFFLEtBQVU7UUFDbkQsSUFBSSxLQUFLLEVBQUU7WUFDVCxPQUFPLENBQUMsR0FBRyxDQUFDLGdDQUFnQyxFQUFFLElBQUksQ0FBQyxRQUFRLEVBQUUsRUFBRSxPQUFPLEVBQUUsSUFBSSxFQUFFLFFBQVEsRUFBRSxLQUFLLENBQUMsQ0FBQztTQUNoRztRQUNELElBQUksQ0FBQyxXQUFXLENBQUMsSUFBSSxFQUFFLEtBQUssQ0FBQyxDQUFDO0lBQ2hDLENBQUM7SUFFRCxRQUFRLENBQUMsSUFBZSxFQUFFLEtBQWE7UUFDckMsSUFBSSxLQUFLLEVBQUU7WUFDVCxPQUFPLENBQUMsR0FBRyxDQUFDLDZCQUE2QixFQUFFLElBQUksQ0FBQyxRQUFRLEVBQUUsRUFBRSxRQUFRLEVBQUUsS0FBSyxDQUFDLENBQUM7U0FDOUU7UUFDRCxJQUFJLENBQUMsV0FBVyxDQUFDLE9BQU8sRUFBRSxLQUFLLENBQUMsQ0FBQztJQUNuQyxDQUFDO0lBRUQsTUFBTSxDQUFDLE1BQWlCLEVBQUUsS0FBYSxFQUFFLFFBQWlDO1FBQ3hFLElBQUksS0FBSyxFQUFFO1lBQ1QsT0FBTyxDQUFDLEdBQUcsQ0FBQyw2QkFBNkIsRUFBRSxNQUFNLEVBQUUsUUFBUSxFQUFFLEtBQUssQ0FBQyxDQUFDO1NBQ3JFO1FBQ0QsTUFBTSxDQUFDLFdBQVcsQ0FBQyxLQUFLLEVBQUUsUUFBUSxDQUFDLENBQUM7UUFFcEMsaUVBQWlFO1FBQ2pFLHlEQUF5RDtRQUN6RCw0RUFBNEU7UUFFNUUsZ0RBQWdEO1FBQ2hELE9BQU8sR0FBRyxFQUFFLENBQUMsSUFBSSxDQUFDO0lBQ3BCLENBQUM7Q0FDRiIsInNvdXJjZXNDb250ZW50IjpbIi8vIENvcHlyaWdodCAoYykgTWljcm9zb2Z0IENvcnBvcmF0aW9uLiBBbGwgcmlnaHRzIHJlc2VydmVkLlxyXG4vLyBMaWNlbnNlZCB1bmRlciB0aGUgTUlUIExpY2Vuc2UuXHJcblxyXG5pbXBvcnQgeyBJbmplY3RhYmxlLCBSZW5kZXJlcjIsIFJlbmRlcmVyU3R5bGVGbGFnczIsIFJlbmRlcmVyVHlwZTIgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgRXZlbnRNYW5hZ2VyLCDJtURvbVJlbmRlcmVyRmFjdG9yeTIsIMm1RG9tU2hhcmVkU3R5bGVzSG9zdCB9IGZyb20gJ0Bhbmd1bGFyL3BsYXRmb3JtLWJyb3dzZXInO1xyXG5pbXBvcnQgeyBTdHJpbmdNYXAgfSBmcm9tICcuLi9kZWNsYXJhdGlvbnMvc3RyaW5nLW1hcCc7XHJcbmltcG9ydCB7IERpc2d1aXNlIH0gZnJvbSAnLi9jb21wb25lbnRzL0Rpc2d1aXNlJztcclxuaW1wb3J0IHsgUmVhY3RDb250ZW50IH0gZnJvbSAnLi9yZWFjdC1jb250ZW50JztcclxuaW1wb3J0IHsgaXNSZWFjdE5vZGUsIFJlYWN0Tm9kZSB9IGZyb20gJy4vcmVhY3Qtbm9kZSc7XHJcbmltcG9ydCB7IHJlZ2lzdGVyRWxlbWVudCB9IGZyb20gJy4vcmVnaXN0cnknO1xyXG5pbXBvcnQgJy4vZ2V0ZXZlbnRsaXN0ZW5lcnMnO1xyXG5cclxuY29uc3QgREVCVUcgPSBmYWxzZTtcclxuXHJcbkBJbmplY3RhYmxlKClcclxuZXhwb3J0IGNsYXNzIEFuZ3VsYXJSZWFjdFJlbmRlcmVyRmFjdG9yeSBleHRlbmRzIMm1RG9tUmVuZGVyZXJGYWN0b3J5MiB7XHJcbiAgcHJpdmF0ZSByZWFkb25seSBkZWZhdWx0UmVhY3RSZW5kZXJlcjogUmVhY3RSZW5kZXJlcjtcclxuXHJcbiAgLy8gQ29sbGVjdGlvbiBvZiBSZWFjdE5vZGVzIHRoYXQgY2FuIGJlIGV2YWx1YXRlZCBhbmQgZmx1c2hlZCBhdCB0aGVcclxuICAvLyBlbmQgb2YgUmVuZGVyLiAgVGhpcyBpcyBuZWNlc3NhcnkgYXMgdGhlIGZsb3cgb2YgZWxlbWVudCBjcmVhdGlvblxyXG4gIC8vIGFuZCB1cGRhdGUgZ29lcyBmcm9tIFwiY3JlYXRlXCIgPiBcImluc2VydFwiID4gXCJ1cGRhdGVcIiBwcm9wZXJ0eS9hdHRyaWJ1dGUuXHJcbiAgLy8gUmVhY3QgZWxlbWVudHMgY2Fubm90IGJlIFwiaW5zZXJ0ZWRcIiBhbmQgbGF0ZXIgaGF2ZSB0aGVpciBwcm9wc1xyXG4gIC8vIHVwZGF0ZWQsIHNvIHRoZSBcImluc2VydFwiLCBvciBSZWFjdC5SZW5kZXIsIGNhbiBvbmx5IGJlIGRvbmUgb25jZSB0aGVcclxuICAvLyBlbGVtZW50IGhhcyBiZWVuIGZ1bGx5IGRlZmluZWQuICBPbmx5IHRoZSB0b3Btb3N0IFtyb290XSBub2RlcyBhcmUgYWRkZWQgaGVyZS5cclxuICBwdWJsaWMgcmVhY3RSb290Tm9kZXM6IFNldDxSZWFjdE5vZGU+ID0gbmV3IFNldCgpO1xyXG5cclxuICBwcml2YXRlIGlzUmVuZGVyUGVuZGluZzogYm9vbGVhbjtcclxuXHJcbiAgLy8gVGhpcyBmbGFnIGNhbiBvbmx5IGJlIHNldCB0byB0cnVlIGZyb20gb3V0c2lkZS4gIEl0IGNhbiBvbmx5IGJlIHJlc2V0XHJcbiAgLy8gdG8gZmFsc2UgZnJvbSBpbnNpZGUuICBUaGlzIHZhbHVlIGlzIHJlc2V0IG9uIFwiZW5kXCIgd2hlbiB0aGUgcGVuZGluZ1xyXG4gIC8vIHJlbmRlcnMgYXJlIGZsdXNoZWQuXHJcbiAgcHVibGljIHJlYWRvbmx5IHNldFJlbmRlclBlbmRpbmdDYWxsYmFjayA9ICgpID0+IHtcclxuICAgIHRoaXMuaXNSZW5kZXJQZW5kaW5nID0gdHJ1ZTtcclxuICB9O1xyXG5cclxuICBjb25zdHJ1Y3RvcihldmVudE1hbmFnZXI6IEV2ZW50TWFuYWdlciwgc2hhcmVkU3R5bGVzSG9zdDogybVEb21TaGFyZWRTdHlsZXNIb3N0KSB7XHJcbiAgICBzdXBlcihldmVudE1hbmFnZXIsIHNoYXJlZFN0eWxlc0hvc3QsICdhcHAtaWQnKTtcclxuXHJcbiAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6IG5vLXVzZS1iZWZvcmUtZGVjbGFyZVxyXG4gICAgdGhpcy5kZWZhdWx0UmVhY3RSZW5kZXJlciA9IG5ldyBSZWFjdFJlbmRlcmVyKHRoaXMpO1xyXG4gIH1cclxuXHJcbiAgY3JlYXRlUmVuZGVyZXIoZWxlbWVudDogYW55LCB0eXBlOiBSZW5kZXJlclR5cGUyIHwgbnVsbCk6IFJlbmRlcmVyMiB7XHJcbiAgICBpZiAodHlwZSAmJiB0eXBlLnN0eWxlcy5sZW5ndGggJiYgdHlwZS5zdHlsZXNbMF0gPT09ICdyZWFjdC1yZW5kZXJlcicpIHtcclxuICAgICAgcmV0dXJuIHRoaXMuZGVmYXVsdFJlYWN0UmVuZGVyZXI7XHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuIHN1cGVyLmNyZWF0ZVJlbmRlcmVyKGVsZW1lbnQsIHR5cGUpO1xyXG4gIH1cclxuXHJcbiAgYmVnaW4oKSB7fVxyXG5cclxuICBlbmQoKSB7XHJcbiAgICBpZiAoREVCVUcpIHtcclxuICAgICAgY29uc29sZS5sb2coXHJcbiAgICAgICAgJ1Jvb3RSZW5kZXJlciA+IGVuZCA+IGlzUmVuZGVyUGVuZGluZzonLFxyXG4gICAgICAgIHRoaXMuaXNSZW5kZXJQZW5kaW5nLFxyXG4gICAgICAgICdyZWFjdFJvb3ROb2RlczonLFxyXG4gICAgICAgIHRoaXMucmVhY3RSb290Tm9kZXNcclxuICAgICAgKTtcclxuICAgIH1cclxuXHJcbiAgICAvLyBGbHVzaCBhbnkgcGVuZGluZyBSZWFjdCBlbGVtZW50IHJlbmRlciB1cGRhdGVzLiAgVGhpcyBjYW5ub3QgYmUgZG9uZVxyXG4gICAgLy8gZWFybGllciAoYXMgaXMgZG9uZSBmb3IgRE9NIGVsZW1lbnRzKSBiZWNhdXNlIFJlYWN0IGVsZW1lbnQgcHJvcHNcclxuICAgIC8vIGFyZSBSZWFkT25seS5cclxuXHJcbiAgICBpZiAodGhpcy5pc1JlbmRlclBlbmRpbmcpIHtcclxuICAgICAgLy8gUmVtb3ZlIHJvb3Qgbm9kZXMgdGhhdCBhcmUgcGVuZGluZyBkZXN0cm95IGFmdGVyIHJlbmRlci5cclxuICAgICAgdGhpcy5yZWFjdFJvb3ROb2RlcyA9IG5ldyBTZXQoQXJyYXkuZnJvbSh0aGlzLnJlYWN0Um9vdE5vZGVzKS5maWx0ZXIobm9kZSA9PiAhbm9kZS5yZW5kZXIoKS5kZXN0cm95UGVuZGluZykpO1xyXG4gICAgICB0aGlzLmlzUmVuZGVyUGVuZGluZyA9IGZhbHNlO1xyXG4gICAgfVxyXG4gIH1cclxufVxyXG5cclxuZXhwb3J0IGNvbnN0IGlzUmVhY3RSZW5kZXJlckRhdGEgPSAoZGF0YTogU3RyaW5nTWFwKTogZGF0YSBpcyBSZWFjdFJlbmRlcmVyRGF0YSA9PlxyXG4gIGRhdGEgJiYgdHlwZW9mIChkYXRhIGFzIFJlYWN0UmVuZGVyZXJEYXRhKS5hZGRSb290Tm9kZSA9PT0gJ2Z1bmN0aW9uJztcclxuXHJcbmV4cG9ydCBpbnRlcmZhY2UgUmVhY3RSZW5kZXJlckRhdGEge1xyXG4gIHJlYWRvbmx5IGFkZFJvb3ROb2RlOiAobm9kZTogUmVhY3ROb2RlKSA9PiB2b2lkO1xyXG59XHJcblxyXG5leHBvcnQgY2xhc3MgUmVhY3RSZW5kZXJlciBpbXBsZW1lbnRzIFJlbmRlcmVyMiB7XHJcbiAgcmVhZG9ubHkgZGF0YTogUmVhY3RSZW5kZXJlckRhdGEgPSB7XHJcbiAgICBhZGRSb290Tm9kZTogKG5vZGU6IFJlYWN0Tm9kZSkgPT4ge1xyXG4gICAgICB0aGlzLnJvb3RSZW5kZXJlci5yZWFjdFJvb3ROb2Rlcy5hZGQobm9kZSk7XHJcbiAgICB9LFxyXG4gIH07XHJcblxyXG4gIGNvbnN0cnVjdG9yKHB1YmxpYyByZWFkb25seSByb290UmVuZGVyZXI6IEFuZ3VsYXJSZWFjdFJlbmRlcmVyRmFjdG9yeSkge1xyXG4gICAgLy8gVGhlc2UgdHdvIGVsZW1lbnRzIGFyZSBlc3NlbnRpYWwgZm9yIHRoZSB3aG9sZSBleHBlcmllbmNlIHRvIGJlIHNtb290aCBmb3IgdGhlIHVzZXIgLSByZWdpc3RlciB0aGVtIGZyb20gdGhlIGdldC1nby5cclxuICAgIHJlZ2lzdGVyRWxlbWVudCgnUmVhY3RDb250ZW50JywgKCkgPT4gUmVhY3RDb250ZW50KTtcclxuICAgIHJlZ2lzdGVyRWxlbWVudCgnRGlzZ3Vpc2UnLCAoKSA9PiBEaXNndWlzZSk7XHJcbiAgfVxyXG5cclxuICBkZXN0cm95KCk6IHZvaWQge31cclxuXHJcbiAgZGVzdHJveU5vZGUobm9kZTogUmVhY3ROb2RlKTogdm9pZCB7XHJcbiAgICBpZiAoREVCVUcpIHtcclxuICAgICAgY29uc29sZS5lcnJvcignUmVuZGVyZXIgPiBkZXN0cm95Tm9kZSA+IG5vZGU6Jywgbm9kZS50b1N0cmluZygpKTtcclxuICAgIH1cclxuICAgIG5vZGUuZGVzdHJveU5vZGUoKTtcclxuICB9XHJcblxyXG4gIGNyZWF0ZUVsZW1lbnQobmFtZTogc3RyaW5nLCBuYW1lc3BhY2U/OiBzdHJpbmcpOiBSZWFjdE5vZGUge1xyXG4gICAgaWYgKERFQlVHKSB7XHJcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ1JlbmRlcmVyID4gY3JlYXRlRWxlbWVudCA+IG5hbWU6JywgbmFtZSwgbmFtZXNwYWNlID8gJ25hbWVzcGFjZTonIDogJycsIG5hbWVzcGFjZSk7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gbmV3IFJlYWN0Tm9kZShuYW1lKTtcclxuICB9XHJcblxyXG4gIGNyZWF0ZUNvbW1lbnQodmFsdWU6IHN0cmluZyk6IFJlYWN0Tm9kZSB7XHJcbiAgICBpZiAoREVCVUcpIHtcclxuICAgICAgY29uc29sZS5lcnJvcignUmVuZGVyZXIgPiBjcmVhdGVDb21tZW50ID4gdmFsdWU6JywgdmFsdWUudHJpbSgpKTtcclxuICAgIH1cclxuICAgIHJldHVybiBuZXcgUmVhY3ROb2RlKCkuYXNDb21tZW50KHZhbHVlKTtcclxuICB9XHJcblxyXG4gIGNyZWF0ZVRleHQodmFsdWU6IHN0cmluZyk6IFJlYWN0Tm9kZSB7XHJcbiAgICBpZiAoREVCVUcpIHtcclxuICAgICAgY29uc29sZS5lcnJvcignUmVuZGVyZXIgPiBjcmVhdGVUZXh0ID4gdmFsdWU6JywgdmFsdWUudHJpbSgpKTtcclxuICAgIH1cclxuICAgIHJldHVybiBuZXcgUmVhY3ROb2RlKCkuYXNUZXh0KHZhbHVlKTtcclxuICB9XHJcblxyXG4gIGFwcGVuZENoaWxkKHBhcmVudDogSFRNTEVsZW1lbnQgfCBSZWFjdE5vZGUsIG5vZGU6IFJlYWN0Tm9kZSk6IHZvaWQge1xyXG4gICAgLy8gT25seSBhcHBlbmQgYSBjaGlsZCBpZiB0aGVyZSBpcyBhIGNoaWxkIHRvIGFwcGVuZC5cclxuICAgIGlmICghbm9kZSkge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcblxyXG4gICAgLy8gRG9uJ3QgYXBwZW5kIGVtcHR5IHRleHQgbm9kZXMuXHJcbiAgICBpZiAoIW5vZGUuc2hvdWxkUmVuZGVyKSB7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuXHJcbiAgICAvLyBQcm92aWRlIGEgcGFyZW50IGVsZW1lbnQgcmVmZXJlbmNlIHRvIHRoZSBSZWFjdE5vZGUuICBUaGlzIHdpbGwgYmUgdXNlZCBsYXRlclxyXG4gICAgLy8gb25jZSB0aGUgUmVhY3ROb2RlIGlzIGZ1bGx5IGRlZmluZWQgYW5kIGl0IGlzIHN1YnNlcXVlbnRseSByZW5kZXJlZC5cclxuICAgIGlmICghaXNSZWFjdE5vZGUocGFyZW50KSkge1xyXG4gICAgICBpZiAoREVCVUcpIHtcclxuICAgICAgICBjb25zb2xlLndhcm4oJ1JlbmRlcmVyID4gYXBwZW5kQ2hpbGQgPiBhc0RPTSA+IHBhcmVudDonLCBwYXJlbnQudG9TdHJpbmcoKSwgJ25vZGU6Jywgbm9kZS50b1N0cmluZygpKTtcclxuICAgICAgfVxyXG4gICAgICBub2RlLnNldFJlbmRlclBlbmRpbmdDYWxsYmFjayA9IHRoaXMucm9vdFJlbmRlcmVyLnNldFJlbmRlclBlbmRpbmdDYWxsYmFjaztcclxuXHJcbiAgICAgIHRoaXMucm9vdFJlbmRlcmVyLnJlYWN0Um9vdE5vZGVzLmFkZChub2RlKTtcclxuICAgICAgbm9kZS5wYXJlbnQgPSBwYXJlbnQ7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuXHJcbiAgICBpZiAoREVCVUcpIHtcclxuICAgICAgY29uc29sZS53YXJuKCdSZW5kZXJlciA+IGFwcGVuZENoaWxkID4gYXNSZWFjdCA+IHBhcmVudDonLCBwYXJlbnQudG9TdHJpbmcoKSwgJ25vZGU6Jywgbm9kZS50b1N0cmluZygpKTtcclxuICAgIH1cclxuXHJcbiAgICBub2RlLnNldFJlbmRlclBlbmRpbmdDYWxsYmFjayA9ICgpID0+IHBhcmVudC5zZXRSZW5kZXJQZW5kaW5nKCk7XHJcbiAgICBwYXJlbnQuYWRkQ2hpbGQobm9kZSk7XHJcbiAgICBub2RlLnBhcmVudCA9IHBhcmVudDtcclxuICB9XHJcblxyXG4gIGluc2VydEJlZm9yZShwYXJlbnQ6IEhUTUxFbGVtZW50IHwgdm9pZCwgbm9kZTogUmVhY3ROb2RlLCByZWZDaGlsZDogYW55KTogdm9pZCB7XHJcbiAgICAvLyBPbmx5IGluc2VydCBhIGNoaWxkIGlmIHRoZXJlIGlzIGEgcGFyZW50LlxyXG4gICAgaWYgKCFwYXJlbnQpIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIFByb3ZpZGUgYSBwYXJlbnQgZWxlbWVudCByZWZlcmVuY2UgdG8gdGhlIFJlYWN0Tm9kZS4gIFRoaXMgd2lsbCBiZSB1c2VkIGxhdGVyXHJcbiAgICAvLyBvbmNlIHRoZSBSZWFjdE5vZGUgaXMgZnVsbHkgZGVmaW5lZCBhbmQgaXQgaXMgc3Vic2VxdWVudGx5IHJlbmRlcmVkLiAgSW4gdGhpc1xyXG4gICAgLy8gY2FzZSwgUmVhY3QgY2Fubm90IFwiaW5zZXJ0QmVmb3JlXCIuICBJbnN0ZWFkLCB3ZSBoYXZlIHRvIGNyZWF0ZSBhIHRhcmdldCBlbGVtZW50XHJcbiAgICAvLyB3aGVyZSB0aGUgUmVhY3ROb2RlIGNhbiBiZSByZW5kZXJlZCBsYXRlci5cclxuICAgIGlmIChERUJVRykge1xyXG4gICAgICBjb25zb2xlLndhcm4oXHJcbiAgICAgICAgJ1JlbmRlcmVyID4gaW5zZXJ0QmVmb3JlID4gYXNET00gPiBwYXJlbnQ6JyxcclxuICAgICAgICBwYXJlbnQudG9TdHJpbmcoKSxcclxuICAgICAgICAnbm9kZTonLFxyXG4gICAgICAgIG5vZGUudG9TdHJpbmcoKSxcclxuICAgICAgICAncmVmQ2hpbGQ6JyxcclxuICAgICAgICByZWZDaGlsZC50b1N0cmluZygpXHJcbiAgICAgICk7XHJcbiAgICB9XHJcbiAgICBjb25zdCB0YXJnZXQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTtcclxuICAgIHBhcmVudC5pbnNlcnRCZWZvcmUodGFyZ2V0LCByZWZDaGlsZCk7XHJcbiAgICBub2RlLnBhcmVudCA9IHRhcmdldDtcclxuICAgIG5vZGUuc2V0UmVuZGVyUGVuZGluZ0NhbGxiYWNrID0gdGhpcy5yb290UmVuZGVyZXIuc2V0UmVuZGVyUGVuZGluZ0NhbGxiYWNrO1xyXG4gIH1cclxuXHJcbiAgcmVtb3ZlQ2hpbGQocGFyZW50OiBIVE1MRWxlbWVudCB8IFJlYWN0Tm9kZSB8IHZvaWQsIG5vZGU6IFJlYWN0Tm9kZSk6IHZvaWQge1xyXG4gICAgLy8gT25seSBpbnNlcnQgYSBjaGlsZCBpZiB0aGVyZSBpcyBhIHBhcmVudC5cclxuICAgIGlmICghcGFyZW50KSB7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuXHJcbiAgICAvLyBSZW1vdmUgYSBwYXJlbnQgZWxlbWVudCByZWZlcmVuY2UgZnJvbSB0aGUgUmVhY3ROb2RlLiAgVGhpcyB3aWxsIGJlIGxhdGVyXHJcbiAgICAvLyByZXN1bHQgaW4gdGhlIFJlYWN0Tm9kZSB1bmxvYWRpbmcgaXRzZWxmLlxyXG4gICAgaWYgKCFpc1JlYWN0Tm9kZShwYXJlbnQpKSB7XHJcbiAgICAgIGlmIChERUJVRykge1xyXG4gICAgICAgIGNvbnNvbGUud2FybignUmVuZGVyZXIgPiByZW1vdmVDaGlsZCA+IGFzRE9NID4gcGFyZW50OicsIHBhcmVudC50b1N0cmluZygpLCAnbm9kZTonLCBub2RlLnRvU3RyaW5nKCkpO1xyXG4gICAgICB9XHJcbiAgICAgIG5vZGUucGFyZW50ID0gbnVsbDtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG5cclxuICAgIGlmIChERUJVRykge1xyXG4gICAgICBjb25zb2xlLndhcm4oJ1JlbmRlcmVyID4gcmVtb3ZlQ2hpbGQgPiBhc1JlYWN0ID4gcGFyZW50OicsIHBhcmVudC50b1N0cmluZygpLCAnbm9kZTonLCBub2RlLnRvU3RyaW5nKCkpO1xyXG4gICAgfVxyXG4gICAgcGFyZW50LnJlbW92ZUNoaWxkKG5vZGUpO1xyXG4gIH1cclxuXHJcbiAgc2VsZWN0Um9vdEVsZW1lbnQoc2VsZWN0b3JPck5vZGU6IHN0cmluZyB8IGFueSk6IGFueSB7XHJcbiAgICBpZiAoREVCVUcpIHtcclxuICAgICAgY29uc29sZS5sb2coJ05PVCBJTVBMRU1FTlRFRCAtIFJlbmRlcmVyID4gc2VsZWN0Um9vdEVsZW1lbnQgPiBzZWxlY3Rvck9yTm9kZTonLCBzZWxlY3Rvck9yTm9kZSk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBwYXJlbnROb2RlKG5vZGU6IFJlYWN0Tm9kZSk6IGFueSB7XHJcbiAgICBpZiAoREVCVUcpIHtcclxuICAgICAgY29uc29sZS5sb2coJ05PVCBJTVBMRU1FTlRFRCAtIFJlbmRlcmVyID4gcGFyZW50Tm9kZSA+IG5vZGU6Jywgbm9kZS50b1N0cmluZygpKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIG5leHRTaWJsaW5nKG5vZGU6IGFueSk6IGFueSB7XHJcbiAgICBpZiAoREVCVUcpIHtcclxuICAgICAgY29uc29sZS5sb2coJ05PVCBJTVBMRU1FTlRFRCAtIFJlbmRlcmVyID4gbmV4dFNpYmxpbmcgPiBub2RlOicsIG5vZGUudG9TdHJpbmcoKSk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBzZXRBdHRyaWJ1dGUobm9kZTogUmVhY3ROb2RlLCBuYW1lOiBzdHJpbmcsIHZhbHVlOiBzdHJpbmcsIG5hbWVzcGFjZT86IHN0cmluZyk6IHZvaWQge1xyXG4gICAgaWYgKERFQlVHKSB7XHJcbiAgICAgIGNvbnNvbGUubG9nKFxyXG4gICAgICAgICdSZW5kZXJlciA+IHNldEF0dHJpYnV0ZSA+IG5vZGU6JyxcclxuICAgICAgICBub2RlLnRvU3RyaW5nKCksXHJcbiAgICAgICAgJ25hbWU6JyxcclxuICAgICAgICBuYW1lLFxyXG4gICAgICAgICd2YWx1ZTonLFxyXG4gICAgICAgIHZhbHVlLFxyXG4gICAgICAgIG5hbWVzcGFjZSA/ICduYW1lc3BhY2U6JyA6ICcnLFxyXG4gICAgICAgIG5hbWVzcGFjZVxyXG4gICAgICApO1xyXG4gICAgfVxyXG4gICAgbm9kZS5zZXRQcm9wZXJ0eShuYW1lLCB2YWx1ZSk7XHJcbiAgfVxyXG5cclxuICByZW1vdmVBdHRyaWJ1dGUobm9kZTogUmVhY3ROb2RlLCBuYW1lOiBzdHJpbmcsIG5hbWVzcGFjZT86IHN0cmluZyk6IHZvaWQge1xyXG4gICAgaWYgKERFQlVHKSB7XHJcbiAgICAgIGNvbnNvbGUubG9nKFxyXG4gICAgICAgICdSZW5kZXJlciA+IHJlbW92ZUF0dHJpYnV0ZSA+IG5vZGU6JyxcclxuICAgICAgICBub2RlLnRvU3RyaW5nKCksXHJcbiAgICAgICAgJ25hbWU6JyxcclxuICAgICAgICBuYW1lLFxyXG4gICAgICAgIG5hbWVzcGFjZSA/ICduYW1lc3BhY2U6JyA6ICcnLFxyXG4gICAgICAgIG5hbWVzcGFjZVxyXG4gICAgICApO1xyXG4gICAgfVxyXG4gICAgbm9kZS5yZW1vdmVQcm9wZXJ0eShuYW1lKTtcclxuICB9XHJcblxyXG4gIGFkZENsYXNzKG5vZGU6IFJlYWN0Tm9kZSwgbmFtZTogc3RyaW5nKTogdm9pZCB7XHJcbiAgICBpZiAoREVCVUcpIHtcclxuICAgICAgY29uc29sZS5sb2coJ1JlbmRlcmVyID4gYWRkQ2xhc3MgPiBub2RlOicsIG5vZGUudG9TdHJpbmcoKSwgJ25hbWU6JywgbmFtZSk7XHJcbiAgICB9XHJcblxyXG4gICAgLy8gVXBkYXRlIHRoZSB2aXJ0dWFsIG5vZGUuXHJcbiAgICAvLyBUT0RPOiBUaGlzIG1heSBvbmx5IHN1cHBvcnQgYSBzaW5nbGUgY2xhc3MgbmFtZSwgYnV0IG1pZ2h0IHdvcmsgaWYgcHJvcGVydHkgbmFtZSBpcyBhIHNpbmdsZVxyXG4gICAgLy8gICAgICAgY29tbWEtZGVsaW1pdGVkIGxpc3Qgb2YgY2xhc3Nlcy4uLlxyXG4gICAgbm9kZS5zZXRQcm9wZXJ0eSgnY2xhc3NOYW1lJywgbmFtZSk7XHJcbiAgfVxyXG5cclxuICByZW1vdmVDbGFzcyhub2RlOiBSZWFjdE5vZGUsIG5hbWU6IHN0cmluZyk6IHZvaWQge1xyXG4gICAgaWYgKERFQlVHKSB7XHJcbiAgICAgIGNvbnNvbGUubG9nKCdSZW5kZXJlciA+IHJlbW92ZUNsYXNzID4gbm9kZTonLCBub2RlLnRvU3RyaW5nKCksICduYW1lOicsIG5hbWUpO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIFVwZGF0ZSB0aGUgdmlydHVhbCBub2RlLlxyXG4gICAgLy8gVE9ETzogVGhpcyBtYXkgbm90IHdvcmsgY29ycmVjdGx5IHRvIHJlbW92ZSBhIHNpbmdsZSBuYW1lIGZyb20gYSBjb21tYS1kZWxpbWl0ZWQgbGlzdC5cclxuICAgIG5vZGUucmVtb3ZlUHJvcGVydHkoJ2NsYXNzTmFtZScpO1xyXG4gIH1cclxuXHJcbiAgc2V0U3R5bGUobm9kZTogUmVhY3ROb2RlLCBzdHlsZTogc3RyaW5nLCB2YWx1ZTogYW55LCBmbGFnczogUmVuZGVyZXJTdHlsZUZsYWdzMik6IHZvaWQge1xyXG4gICAgLy8gaWYgKERFQlVHKSB7IGNvbnNvbGUubG9nKCdSZW5kZXJlciA+IHNldFN0eWxlID4gbm9kZTogJywgbm9kZS50b1N0cmluZygpLCAnc3R5bGU6Jywgc3R5bGUsICd2YWx1ZTonLCB2YWx1ZSwgJ2ZsYWdzOicsIGZsYWdzKTsgfVxyXG4gICAgaWYgKGZsYWdzICYgUmVuZGVyZXJTdHlsZUZsYWdzMi5EYXNoQ2FzZSkge1xyXG4gICAgICBub2RlLnNldFByb3BlcnR5KCdzdHlsZScsIHsgc3R5bGU6IHZhbHVlICsgISEoZmxhZ3MgJiBSZW5kZXJlclN0eWxlRmxhZ3MyLkltcG9ydGFudCkgPyAnICFpbXBvcnRhbnQnIDogJycgfSk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICBub2RlLnNldFByb3BlcnR5KCdzdHlsZScsIHsgc3R5bGU6IHZhbHVlIH0pO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgcmVtb3ZlU3R5bGUobm9kZTogUmVhY3ROb2RlLCBzdHlsZTogc3RyaW5nLCBmbGFnczogUmVuZGVyZXJTdHlsZUZsYWdzMik6IHZvaWQge1xyXG4gICAgaWYgKERFQlVHKSB7XHJcbiAgICAgIGNvbnNvbGUubG9nKCdSZW5kZXJlciA+IHJlbW92ZVN0eWxlID4gbm9kZTonLCBub2RlLnRvU3RyaW5nKCksICdzdHlsZTonLCBzdHlsZSwgJ2ZsYWdzOicsIGZsYWdzKTtcclxuICAgIH1cclxuICAgIG5vZGUucmVtb3ZlUHJvcGVydHkoJ3N0eWxlJywgc3R5bGUpO1xyXG4gIH1cclxuXHJcbiAgc2V0UHJvcGVydHkobm9kZTogUmVhY3ROb2RlLCBuYW1lOiBzdHJpbmcsIHZhbHVlOiBhbnkpOiB2b2lkIHtcclxuICAgIGlmIChERUJVRykge1xyXG4gICAgICBjb25zb2xlLmxvZygnUmVuZGVyZXIgPiBzZXRQcm9wZXJ0eSA+IG5vZGU6Jywgbm9kZS50b1N0cmluZygpLCAnbmFtZTonLCBuYW1lLCAndmFsdWU6JywgdmFsdWUpO1xyXG4gICAgfVxyXG4gICAgbm9kZS5zZXRQcm9wZXJ0eShuYW1lLCB2YWx1ZSk7XHJcbiAgfVxyXG5cclxuICBzZXRWYWx1ZShub2RlOiBSZWFjdE5vZGUsIHZhbHVlOiBzdHJpbmcpOiB2b2lkIHtcclxuICAgIGlmIChERUJVRykge1xyXG4gICAgICBjb25zb2xlLmxvZygnUmVuZGVyZXIgPiBzZXRWYWx1ZSA+IG5vZGU6Jywgbm9kZS50b1N0cmluZygpLCAndmFsdWU6JywgdmFsdWUpO1xyXG4gICAgfVxyXG4gICAgbm9kZS5zZXRQcm9wZXJ0eSgndmFsdWUnLCB2YWx1ZSk7XHJcbiAgfVxyXG5cclxuICBsaXN0ZW4odGFyZ2V0OiBSZWFjdE5vZGUsIGV2ZW50OiBzdHJpbmcsIGNhbGxiYWNrOiAoZXZlbnQ6IGFueSkgPT4gYm9vbGVhbik6ICgpID0+IHZvaWQge1xyXG4gICAgaWYgKERFQlVHKSB7XHJcbiAgICAgIGNvbnNvbGUubG9nKCdSZW5kZXJlciA+IGxpc3RlbiA+IHRhcmdldDonLCB0YXJnZXQsICdldmVudDonLCBldmVudCk7XHJcbiAgICB9XHJcbiAgICB0YXJnZXQuc2V0UHJvcGVydHkoZXZlbnQsIGNhbGxiYWNrKTtcclxuXHJcbiAgICAvLyBUT0RPOiBORUVEUyBXT1JLOiBJbXBsZW1lbnQgcHJldmVudCBkZWZhdWx0IGNhbGxiYWNrIGJlaGF2aW9yLlxyXG4gICAgLy8gcmV0dXJuIDwoKSA9PiB2b2lkPnRoaXMuZXZlbnRNYW5hZ2VyLmFkZEV2ZW50TGlzdGVuZXIoXHJcbiAgICAvLyAgICAgICAgICAgIHRhcmdldCwgZXZlbnQsIGRlY29yYXRlUHJldmVudERlZmF1bHQoY2FsbGJhY2spKSBhcygpID0+IHZvaWQ7XHJcblxyXG4gICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm5vLXVudXNlZC1leHByZXNzaW9uXHJcbiAgICByZXR1cm4gKCkgPT4gbnVsbDtcclxuICB9XHJcbn1cclxuIl19