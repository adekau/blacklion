// Copyright (c) Microsoft Corporation. All rights reserved.
// Licensed under the MIT License.
import * as React from 'react';
import * as ReactDOM from 'react-dom';
import { throttleTime } from 'rxjs/operators';
const DEBUG = false;
const TEMPLATE_DETECT_CHANGES_THROTTLE_MS = 250;
/**
 * Creates a new `ReactTemplate` element.
 * @param templateRef The template to render.
 * @param context The context to inject the template.
 * @param ngZone A zone used for tracking changes in the template.
 * @param additionalProps _Optional_. @see `ReactTemplateProps`.
 */
export function createReactTemplateElement(templateRef, context, ngZone, additionalProps) {
    return React.createElement(ReactTemplate, Object.assign({ ngZone, templateRef, context }, additionalProps));
}
/**
 * Render an `ng-template` as a child of a React component.
 * Supports two rendering modes:
 *  1. `legacy` - append `<react-content>` as the root, and nest the `children-to-append` underneath it.
 *  2. `new` (**default**) - append the `children-to-append` to the parent of this component, and hide the `<react-content>` element.
 *     (similar to how `router-outlet` behaves in Angular).
 */
export class ReactTemplate extends React.Component {
    componentDidUpdate() {
        // Context has changes, trigger change detection after pushing the new context in
        if (this.props.context != null && this._embeddedViewRef.context != null) {
            Object.assign(this._embeddedViewRef.context, this.props.context);
        }
        this._embeddedViewRef.detectChanges();
    }
    componentDidMount() {
        const { context, ngZone, templateRef } = this.props;
        this._embeddedViewRef = templateRef.createEmbeddedView(context);
        const element = ReactDOM.findDOMNode(this);
        if (DEBUG) {
            console.warn('ReactTemplate Component > componentDidMount > childrenToAppend:', {
                rootNodes: this._embeddedViewRef.rootNodes,
            });
        }
        const hostElement = this.props.legacyRenderMode ? element : element.parentElement;
        this._embeddedViewRef.rootNodes.forEach(child => hostElement.appendChild(child));
        // Detect the first cycle's changes, and then subscribe for subsequent ones.
        this._embeddedViewRef.detectChanges();
        // Throttling the detect changes to an empirically selected value so we don't overload too much work.
        // TODO: This needs some better solution to listen to changes to the binding sources of the template.
        this._ngZoneSubscription = ngZone.onStable
            .pipe(throttleTime(TEMPLATE_DETECT_CHANGES_THROTTLE_MS, undefined, { leading: true, trailing: true }))
            .subscribe(() => {
            this._embeddedViewRef.detectChanges();
        });
    }
    componentWillUnmount() {
        this._ngZoneSubscription.unsubscribe();
        if (this._embeddedViewRef) {
            this._embeddedViewRef.destroy();
        }
    }
    render() {
        // TODO: See if we can just render React.Fragment and the children within it, having no extra DOM nodes.
        return React.createElement('react-template', !this.props.legacyRenderMode && { style: { display: 'none' } });
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVhY3QtdGVtcGxhdGUuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AYW5ndWxhci1yZWFjdC9jb3JlLyIsInNvdXJjZXMiOlsic3JjL2xpYi9yZW5kZXJlci9yZWFjdC10ZW1wbGF0ZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSw0REFBNEQ7QUFDNUQsa0NBQWtDO0FBR2xDLE9BQU8sS0FBSyxLQUFLLE1BQU0sT0FBTyxDQUFDO0FBQy9CLE9BQU8sS0FBSyxRQUFRLE1BQU0sV0FBVyxDQUFDO0FBRXRDLE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUU5QyxNQUFNLEtBQUssR0FBRyxLQUFLLENBQUM7QUFDcEIsTUFBTSxtQ0FBbUMsR0FBRyxHQUFHLENBQUM7QUFnQmhEOzs7Ozs7R0FNRztBQUNILE1BQU0sVUFBVSwwQkFBMEIsQ0FDeEMsV0FBa0MsRUFDbEMsT0FBaUIsRUFDakIsTUFBYyxFQUNkLGVBQW9DO0lBRXBDLE9BQU8sS0FBSyxDQUFDLGFBQWEsQ0FBQyxhQUFhLGtCQUFJLE1BQU0sRUFBRSxXQUFXLEVBQUUsT0FBTyxJQUFLLGVBQWUsRUFBRyxDQUFDO0FBQ2xHLENBQUM7QUFXRDs7Ozs7O0dBTUc7QUFDSCxNQUFNLE9BQU8sYUFBOEMsU0FBUSxLQUFLLENBQUMsU0FFeEU7SUFJQyxrQkFBa0I7UUFDaEIsaUZBQWlGO1FBQ2pGLElBQUksSUFBSSxDQUFDLEtBQUssQ0FBQyxPQUFPLElBQUksSUFBSSxJQUFJLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxPQUFPLElBQUksSUFBSSxFQUFFO1lBQ3ZFLE1BQU0sQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLGdCQUFnQixDQUFDLE9BQU8sRUFBRSxJQUFJLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxDQUFDO1NBQ2xFO1FBQ0QsSUFBSSxDQUFDLGdCQUFnQixDQUFDLGFBQWEsRUFBRSxDQUFDO0lBQ3hDLENBQUM7SUFFRCxpQkFBaUI7UUFDZixNQUFNLEVBQUUsT0FBTyxFQUFFLE1BQU0sRUFBRSxXQUFXLEVBQUUsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDO1FBRXBELElBQUksQ0FBQyxnQkFBZ0IsR0FBRyxXQUFXLENBQUMsa0JBQWtCLENBQUMsT0FBTyxDQUFDLENBQUM7UUFDaEUsTUFBTSxPQUFPLEdBQUcsUUFBUSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUMzQyxJQUFJLEtBQUssRUFBRTtZQUNULE9BQU8sQ0FBQyxJQUFJLENBQUMsaUVBQWlFLEVBQUU7Z0JBQzlFLFNBQVMsRUFBRSxJQUFJLENBQUMsZ0JBQWdCLENBQUMsU0FBUzthQUMzQyxDQUFDLENBQUM7U0FDSjtRQUVELE1BQU0sV0FBVyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsZ0JBQWdCLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLGFBQWEsQ0FBQztRQUVsRixJQUFJLENBQUMsZ0JBQWdCLENBQUMsU0FBUyxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUFDLFdBQVcsQ0FBQyxXQUFXLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQztRQUVqRiw0RUFBNEU7UUFDNUUsSUFBSSxDQUFDLGdCQUFnQixDQUFDLGFBQWEsRUFBRSxDQUFDO1FBRXRDLHFHQUFxRztRQUNyRyxxR0FBcUc7UUFDckcsSUFBSSxDQUFDLG1CQUFtQixHQUFHLE1BQU0sQ0FBQyxRQUFRO2FBQ3ZDLElBQUksQ0FBQyxZQUFZLENBQUMsbUNBQW1DLEVBQUUsU0FBUyxFQUFFLEVBQUUsT0FBTyxFQUFFLElBQUksRUFBRSxRQUFRLEVBQUUsSUFBSSxFQUFFLENBQUMsQ0FBQzthQUNyRyxTQUFTLENBQUMsR0FBRyxFQUFFO1lBQ2QsSUFBSSxDQUFDLGdCQUFnQixDQUFDLGFBQWEsRUFBRSxDQUFDO1FBQ3hDLENBQUMsQ0FBQyxDQUFDO0lBQ1AsQ0FBQztJQUVELG9CQUFvQjtRQUNsQixJQUFJLENBQUMsbUJBQW1CLENBQUMsV0FBVyxFQUFFLENBQUM7UUFFdkMsSUFBSSxJQUFJLENBQUMsZ0JBQWdCLEVBQUU7WUFDekIsSUFBSSxDQUFDLGdCQUFnQixDQUFDLE9BQU8sRUFBRSxDQUFDO1NBQ2pDO0lBQ0gsQ0FBQztJQUVELE1BQU07UUFDSix3R0FBd0c7UUFDeEcsT0FBTyxLQUFLLENBQUMsYUFBYSxDQUFDLGdCQUFnQixFQUFFLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxnQkFBZ0IsSUFBSSxFQUFFLEtBQUssRUFBRSxFQUFFLE9BQU8sRUFBRSxNQUFNLEVBQUUsRUFBRSxDQUFDLENBQUM7SUFDL0csQ0FBQztDQUNGIiwic291cmNlc0NvbnRlbnQiOlsiLy8gQ29weXJpZ2h0IChjKSBNaWNyb3NvZnQgQ29ycG9yYXRpb24uIEFsbCByaWdodHMgcmVzZXJ2ZWQuXHJcbi8vIExpY2Vuc2VkIHVuZGVyIHRoZSBNSVQgTGljZW5zZS5cclxuXHJcbmltcG9ydCB7IEVtYmVkZGVkVmlld1JlZiwgTmdab25lLCBUZW1wbGF0ZVJlZiB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgKiBhcyBSZWFjdCBmcm9tICdyZWFjdCc7XHJcbmltcG9ydCAqIGFzIFJlYWN0RE9NIGZyb20gJ3JlYWN0LWRvbSc7XHJcbmltcG9ydCB7IFN1YnNjcmlwdGlvbiB9IGZyb20gJ3J4anMnO1xyXG5pbXBvcnQgeyB0aHJvdHRsZVRpbWUgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XHJcblxyXG5jb25zdCBERUJVRyA9IGZhbHNlO1xyXG5jb25zdCBURU1QTEFURV9ERVRFQ1RfQ0hBTkdFU19USFJPVFRMRV9NUyA9IDI1MDtcclxuXHJcbi8qKlxyXG4gKiBAaW50ZXJuYWxcclxuICovXHJcbmV4cG9ydCBpbnRlcmZhY2UgUmVhY3RUZW1wbGF0ZVByb3BzIHtcclxuICAvKipcclxuICAgKiBVc2UgdGhlIGxlZ2FjeSByZW5kZXJpbmcgbW9kZS5cclxuICAgKlxyXG4gICAqIFVzZXMgYSBzaW1pbGFyIGFwcHJvYWNoIHRvIGByb3V0ZXItb3V0bGV0YCwgd2hlcmUgdGhlIGNoaWxkIGVsZW1lbnRzIGFyZSBhZGRlZCB0byB0aGUgcGFyZW50LCBpbnN0ZWFkIG9mIHRoaXMgbm9kZSwgYW5kIHRoaXMgaXMgaGlkZGVuLlxyXG4gICAqXHJcbiAgICogQGRlZmF1bHQgZmFsc2VcclxuICAgKi9cclxuICBsZWdhY3lSZW5kZXJNb2RlPzogYm9vbGVhbjtcclxufVxyXG5cclxuLyoqXHJcbiAqIENyZWF0ZXMgYSBuZXcgYFJlYWN0VGVtcGxhdGVgIGVsZW1lbnQuXHJcbiAqIEBwYXJhbSB0ZW1wbGF0ZVJlZiBUaGUgdGVtcGxhdGUgdG8gcmVuZGVyLlxyXG4gKiBAcGFyYW0gY29udGV4dCBUaGUgY29udGV4dCB0byBpbmplY3QgdGhlIHRlbXBsYXRlLlxyXG4gKiBAcGFyYW0gbmdab25lIEEgem9uZSB1c2VkIGZvciB0cmFja2luZyBjaGFuZ2VzIGluIHRoZSB0ZW1wbGF0ZS5cclxuICogQHBhcmFtIGFkZGl0aW9uYWxQcm9wcyBfT3B0aW9uYWxfLiBAc2VlIGBSZWFjdFRlbXBsYXRlUHJvcHNgLlxyXG4gKi9cclxuZXhwb3J0IGZ1bmN0aW9uIGNyZWF0ZVJlYWN0VGVtcGxhdGVFbGVtZW50PFRDb250ZXh0IGV4dGVuZHMgb2JqZWN0IHwgdm9pZD4oXHJcbiAgdGVtcGxhdGVSZWY6IFRlbXBsYXRlUmVmPFRDb250ZXh0PixcclxuICBjb250ZXh0OiBUQ29udGV4dCxcclxuICBuZ1pvbmU6IE5nWm9uZSxcclxuICBhZGRpdGlvbmFsUHJvcHM/OiBSZWFjdFRlbXBsYXRlUHJvcHNcclxuKSB7XHJcbiAgcmV0dXJuIFJlYWN0LmNyZWF0ZUVsZW1lbnQoUmVhY3RUZW1wbGF0ZSwgeyBuZ1pvbmUsIHRlbXBsYXRlUmVmLCBjb250ZXh0LCAuLi5hZGRpdGlvbmFsUHJvcHMgfSk7XHJcbn1cclxuXHJcbi8qKlxyXG4gKiBAaW50ZXJuYWxcclxuICovXHJcbmludGVyZmFjZSBJbnRlcm5hbFJlYWN0VGVtcGxhdGVQcm9wczxUQ29udGV4dCBleHRlbmRzIG9iamVjdCB8IHZvaWQ+IGV4dGVuZHMgUmVhY3RUZW1wbGF0ZVByb3BzIHtcclxuICBuZ1pvbmU6IE5nWm9uZTtcclxuICB0ZW1wbGF0ZVJlZjogVGVtcGxhdGVSZWY8VENvbnRleHQ+O1xyXG4gIGNvbnRleHQ6IFRDb250ZXh0O1xyXG59XHJcblxyXG4vKipcclxuICogUmVuZGVyIGFuIGBuZy10ZW1wbGF0ZWAgYXMgYSBjaGlsZCBvZiBhIFJlYWN0IGNvbXBvbmVudC5cclxuICogU3VwcG9ydHMgdHdvIHJlbmRlcmluZyBtb2RlczpcclxuICogIDEuIGBsZWdhY3lgIC0gYXBwZW5kIGA8cmVhY3QtY29udGVudD5gIGFzIHRoZSByb290LCBhbmQgbmVzdCB0aGUgYGNoaWxkcmVuLXRvLWFwcGVuZGAgdW5kZXJuZWF0aCBpdC5cclxuICogIDIuIGBuZXdgICgqKmRlZmF1bHQqKikgLSBhcHBlbmQgdGhlIGBjaGlsZHJlbi10by1hcHBlbmRgIHRvIHRoZSBwYXJlbnQgb2YgdGhpcyBjb21wb25lbnQsIGFuZCBoaWRlIHRoZSBgPHJlYWN0LWNvbnRlbnQ+YCBlbGVtZW50LlxyXG4gKiAgICAgKHNpbWlsYXIgdG8gaG93IGByb3V0ZXItb3V0bGV0YCBiZWhhdmVzIGluIEFuZ3VsYXIpLlxyXG4gKi9cclxuZXhwb3J0IGNsYXNzIFJlYWN0VGVtcGxhdGU8VENvbnRleHQgZXh0ZW5kcyBvYmplY3QgfCB2b2lkPiBleHRlbmRzIFJlYWN0LkNvbXBvbmVudDxcclxuICBJbnRlcm5hbFJlYWN0VGVtcGxhdGVQcm9wczxUQ29udGV4dD5cclxuPiB7XHJcbiAgcHJpdmF0ZSBfZW1iZWRkZWRWaWV3UmVmOiBFbWJlZGRlZFZpZXdSZWY8VENvbnRleHQ+O1xyXG4gIHByaXZhdGUgX25nWm9uZVN1YnNjcmlwdGlvbjogU3Vic2NyaXB0aW9uO1xyXG5cclxuICBjb21wb25lbnREaWRVcGRhdGUoKSB7XHJcbiAgICAvLyBDb250ZXh0IGhhcyBjaGFuZ2VzLCB0cmlnZ2VyIGNoYW5nZSBkZXRlY3Rpb24gYWZ0ZXIgcHVzaGluZyB0aGUgbmV3IGNvbnRleHQgaW5cclxuICAgIGlmICh0aGlzLnByb3BzLmNvbnRleHQgIT0gbnVsbCAmJiB0aGlzLl9lbWJlZGRlZFZpZXdSZWYuY29udGV4dCAhPSBudWxsKSB7XHJcbiAgICAgIE9iamVjdC5hc3NpZ24odGhpcy5fZW1iZWRkZWRWaWV3UmVmLmNvbnRleHQsIHRoaXMucHJvcHMuY29udGV4dCk7XHJcbiAgICB9XHJcbiAgICB0aGlzLl9lbWJlZGRlZFZpZXdSZWYuZGV0ZWN0Q2hhbmdlcygpO1xyXG4gIH1cclxuXHJcbiAgY29tcG9uZW50RGlkTW91bnQoKSB7XHJcbiAgICBjb25zdCB7IGNvbnRleHQsIG5nWm9uZSwgdGVtcGxhdGVSZWYgfSA9IHRoaXMucHJvcHM7XHJcblxyXG4gICAgdGhpcy5fZW1iZWRkZWRWaWV3UmVmID0gdGVtcGxhdGVSZWYuY3JlYXRlRW1iZWRkZWRWaWV3KGNvbnRleHQpO1xyXG4gICAgY29uc3QgZWxlbWVudCA9IFJlYWN0RE9NLmZpbmRET01Ob2RlKHRoaXMpO1xyXG4gICAgaWYgKERFQlVHKSB7XHJcbiAgICAgIGNvbnNvbGUud2FybignUmVhY3RUZW1wbGF0ZSBDb21wb25lbnQgPiBjb21wb25lbnREaWRNb3VudCA+IGNoaWxkcmVuVG9BcHBlbmQ6Jywge1xyXG4gICAgICAgIHJvb3ROb2RlczogdGhpcy5fZW1iZWRkZWRWaWV3UmVmLnJvb3ROb2RlcyxcclxuICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgY29uc3QgaG9zdEVsZW1lbnQgPSB0aGlzLnByb3BzLmxlZ2FjeVJlbmRlck1vZGUgPyBlbGVtZW50IDogZWxlbWVudC5wYXJlbnRFbGVtZW50O1xyXG5cclxuICAgIHRoaXMuX2VtYmVkZGVkVmlld1JlZi5yb290Tm9kZXMuZm9yRWFjaChjaGlsZCA9PiBob3N0RWxlbWVudC5hcHBlbmRDaGlsZChjaGlsZCkpO1xyXG5cclxuICAgIC8vIERldGVjdCB0aGUgZmlyc3QgY3ljbGUncyBjaGFuZ2VzLCBhbmQgdGhlbiBzdWJzY3JpYmUgZm9yIHN1YnNlcXVlbnQgb25lcy5cclxuICAgIHRoaXMuX2VtYmVkZGVkVmlld1JlZi5kZXRlY3RDaGFuZ2VzKCk7XHJcblxyXG4gICAgLy8gVGhyb3R0bGluZyB0aGUgZGV0ZWN0IGNoYW5nZXMgdG8gYW4gZW1waXJpY2FsbHkgc2VsZWN0ZWQgdmFsdWUgc28gd2UgZG9uJ3Qgb3ZlcmxvYWQgdG9vIG11Y2ggd29yay5cclxuICAgIC8vIFRPRE86IFRoaXMgbmVlZHMgc29tZSBiZXR0ZXIgc29sdXRpb24gdG8gbGlzdGVuIHRvIGNoYW5nZXMgdG8gdGhlIGJpbmRpbmcgc291cmNlcyBvZiB0aGUgdGVtcGxhdGUuXHJcbiAgICB0aGlzLl9uZ1pvbmVTdWJzY3JpcHRpb24gPSBuZ1pvbmUub25TdGFibGVcclxuICAgICAgLnBpcGUodGhyb3R0bGVUaW1lKFRFTVBMQVRFX0RFVEVDVF9DSEFOR0VTX1RIUk9UVExFX01TLCB1bmRlZmluZWQsIHsgbGVhZGluZzogdHJ1ZSwgdHJhaWxpbmc6IHRydWUgfSkpXHJcbiAgICAgIC5zdWJzY3JpYmUoKCkgPT4ge1xyXG4gICAgICAgIHRoaXMuX2VtYmVkZGVkVmlld1JlZi5kZXRlY3RDaGFuZ2VzKCk7XHJcbiAgICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgY29tcG9uZW50V2lsbFVubW91bnQoKSB7XHJcbiAgICB0aGlzLl9uZ1pvbmVTdWJzY3JpcHRpb24udW5zdWJzY3JpYmUoKTtcclxuXHJcbiAgICBpZiAodGhpcy5fZW1iZWRkZWRWaWV3UmVmKSB7XHJcbiAgICAgIHRoaXMuX2VtYmVkZGVkVmlld1JlZi5kZXN0cm95KCk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICByZW5kZXIoKSB7XHJcbiAgICAvLyBUT0RPOiBTZWUgaWYgd2UgY2FuIGp1c3QgcmVuZGVyIFJlYWN0LkZyYWdtZW50IGFuZCB0aGUgY2hpbGRyZW4gd2l0aGluIGl0LCBoYXZpbmcgbm8gZXh0cmEgRE9NIG5vZGVzLlxyXG4gICAgcmV0dXJuIFJlYWN0LmNyZWF0ZUVsZW1lbnQoJ3JlYWN0LXRlbXBsYXRlJywgIXRoaXMucHJvcHMubGVnYWN5UmVuZGVyTW9kZSAmJiB7IHN0eWxlOiB7IGRpc3BsYXk6ICdub25lJyB9IH0pO1xyXG4gIH1cclxufVxyXG4iXX0=