// Copyright (c) Microsoft Corporation. All rights reserved.
// Licensed under the MIT License.
import * as React from 'react';
import * as ReactDOM from 'react-dom';
import removeUndefinedProperties from '../utils/object/remove-undefined-properties';
import { CHILDREN_TO_APPEND_PROP } from './react-content';
import { getComponentClass } from './registry';
const DEBUG = false;
export function isReactNode(node) {
    return node.setRenderPendingCallback !== undefined;
}
/**
 * Logical representation of everything needed to render a React element in the
 * DOM, with the needed methods to do so.
 */
export class ReactNode {
    constructor(type) {
        this.type = type;
        // Access to these properties are restricted through setters and functions
        // so that the dirty "render pending" state of this object can be properly
        // tracked and all nodes with "render pending" can be flushed at the end
        // of a render operation.
        this._props = {};
        this._children = [];
        this._childrenToAppend = [];
        this._isDestroyPending = false;
        this._isRenderPending = true;
        this.setRenderPendingCallback = () => null;
        this.setRenderPending();
        this._tryResolveTypeIsReactElementClass();
    }
    get domElement() {
        return this._renderedDomElement;
    }
    set parent(parent) {
        this._parent = parent;
        this.setRenderPending();
    }
    get parent() {
        return this._parent;
    }
    get shouldRender() {
        return !this._isNotRenderable;
    }
    get destroyPending() {
        return this._isDestroyPending;
    }
    /**
     * Track all pending render operations internally and set flag on
     * renderer factory so that a flush operation can be scheduled for
     * the "end" of render.
     */
    setRenderPending() {
        this.setRenderPendingCallback();
        this._isRenderPending = true;
    }
    /**
     * Marks the node to be removed from the DOM in the next render cycle.
     */
    destroyNode() {
        this.setRenderPending();
        this._isDestroyPending = true;
    }
    /**
     * Sets an attribute on the node.
     * @note the value can only be a `string`. See `setProperty` for other use-cases.
     * @see `Renderer2#setAttribute`.
     *
     * @param name The attribute name.
     * @param value The new value.
     */
    setAttribute(name, value) {
        this.setAttributes({ [name]: value });
    }
    /**
     * Set attributes on this node.
     * Note that values can only be of type `string`. See `setProperties` for other use-cases.
     * @see `Renderer2#setAttribute`.
     *
     * @param attributes the attributes to set.
     */
    setAttributes(attributes) {
        this.setProperties(attributes);
    }
    /**
     * Sets a prop in the underlying React element.
     * @see `Renderer2#setProperty`.
     *
     * @param name The property name.
     * @param value The new value.
     */
    setProperty(name, value) {
        this.setProperties({ [name]: value });
    }
    /**
     * Like `setProperty` but for multiple props at once.
     *
     * @param properties An object with the props.
     */
    setProperties(properties) {
        this.setRenderPending();
        Object.assign(this._props, removeUndefinedProperties(properties));
    }
    /**
     * Remove a prop or an attribute from the underlying React element.
     * @see `Renderer2#removeAttribute`.
     *
     * @param name The property name.
     * @param childName _Optional_ A property of `name` to remove instead.
     * @returns the deleted property
     */
    removeProperty(name, childName) {
        this.setRenderPending();
        if (childName) {
            return delete this._props[name][childName];
        }
        return delete this._props[name];
    }
    /**
     * Add a direct child of this node.
     * @see `Renderer2#addChild`.
     *
     * @param node The node to add.
     */
    addChild(node) {
        this.setRenderPending();
        this._children.push(node);
    }
    /**
     * Remove a direct child of this node.
     * @see `Renderer2#removeChild`.
     *
     * @param node The node to remove.
     */
    removeChild(node) {
        this.setRenderPending();
        this._children = this._children.filter(child => child !== node);
    }
    /**
     * Cast the node to a comment node.
     * @see `Renderer2#createComment`.
     *
     * @param value the text in the comment to render.
     * @returns itself.
     */
    asComment(value) {
        this.setRenderPending();
        this.type = undefined;
        this._comment = value;
        return this;
    }
    /**
     * Cast the node to a text node.
     * @see `Renderer2#createText`.
     *
     * @param value the text to render.
     * @returns itself.
     */
    asText(value) {
        this.setRenderPending();
        this.type = undefined;
        this._text = value;
        // Skip appending and rendering of empty text nodes. This may cause a bug
        // if a single space is desired...
        if (!value || !value.trim()) {
            this._isNotRenderable = true;
        }
        return this;
    }
    /**
     * Render the node to the DOM, or unmount it, as necessary.
     *
     * @returns itself.
     */
    render() {
        // Only complete render operations for ReactNodes that are parented by HTMLElements.
        // Those that are parented by other ReactNodes will be rendered recursively by their
        // parent.
        if (!isReactNode(this._parent)) {
            if (this._isDestroyPending && this._parent) {
                if (DEBUG) {
                    console.log('ReactNode > render > destroy > node:', this.toString(), 'parent:', this.parent);
                }
                ReactDOM.unmountComponentAtNode(this._parent);
                return this;
            }
            if (this._isRenderPending) {
                if (DEBUG) {
                    console.log('ReactNode > render > node:', this.toString(), 'parent:', this.parent);
                }
                // It is expected that the element will be recreated and re-rendered with each attribute change.
                // See: https://reactjs.org/docs/rendering-elements.html
                ReactDOM.render(this._renderRecursive(), this._parent);
                this._isRenderPending = false;
            }
        }
        return this;
    }
    /**
     * Appends a child.
     *
     * @see `Renderer2#appendChild`.
     * @note This is called by Angular core when projected content is being added.
     *
     * @param projectedContent the content to project.
     */
    appendChild(projectedContent) {
        if (DEBUG) {
            console.error('ReactNode > appendChild > node:', this.toString(), 'projectedContent:', projectedContent.toString().trim());
        }
        this._childrenToAppend.push(projectedContent);
    }
    /**
     * @note for easier debugging.
     */
    toString() {
        if (this._typeName) {
            return `[${this._typeName} ReactNode]`;
        }
        if (this._text) {
            return '[text ReactNode]';
        }
        if (this._comment) {
            return '[comment ReactNode]';
        }
        return '[undefined ReactNode]';
    }
    _renderRecursive(key) {
        const children = this._children
            ? this._children.map((child, index) => child._renderRecursive(index.toString()))
            : [];
        if (this._text) {
            return this._text;
        }
        this._props[CHILDREN_TO_APPEND_PROP] = this._childrenToAppend;
        if (key) {
            this._props['key'] = key;
        }
        // Just having some props on a React element can cause it to
        // behave undesirably, and since the templates are hard-coded to pass
        // all Inputs all the time, they pass `undefined` values too.
        // This ensures these are removed.
        // Additionally, there are some things that Angular templating forbids,
        // and stops at-compile time (with errors), such as `Input`s being prefixed with `on`.
        // Since React does not have the notion of `Output`s as Angular (they are just props of type function, essentially callbacks).
        // To work around this, we, by convention, prefix any PascalCased prop with `on` here, after the template has already been compiled.
        const clearedProps = this._transformProps(removeUndefinedProperties(this._props));
        if (DEBUG) {
            console.warn('ReactNode > renderRecursive > type:', this.toString(), 'props:', this._props, 'children:', children);
        }
        return React.createElement(this.type, clearedProps, children.length > 0 ? children : undefined);
    }
    _transformProps(props) {
        return Object.entries(props).reduce((acc, [key, value]) => {
            const [newKey, newValue] = typeof key !== 'string' ? [key, value] : this._transformProp(key, value);
            return Object.assign(acc, { [newKey]: newValue });
        }, {});
    }
    _transformProp(name, value) {
        // prop name is camelCased already
        const firstLetter = name[0];
        if (firstLetter === firstLetter.toLowerCase()) {
            return [name, value];
        }
        // prop name is PascalCased & is a function - assuming render prop or callback prop that has return value
        // NOTE: Angular doesn't allow passing @Inputs that are prefixed with "on". This is useful for render props and properties representing the "on" state (for example, Toggle).
        // As a convention, any @Input that starts with a capital letter is prefixed with "on" when passed as a prop to the underlying React component.
        return [`on${name}`, value];
    }
    _tryResolveTypeIsReactElementClass() {
        if (this._typeIsReactElementClass === undefined) {
            // Comments and text have no type.
            if (!this.type) {
                return;
            }
            // Store the name of the type for the toString message (debugging).
            this._typeName = this.type;
            // Attempt to resolve the type as a React Element class name/type.
            // Since Angular templates are just strings, we can't include types in them.
            // Therefore, we use the component registry to resolve the type of a component from a string.
            if (typeof this.type === 'string') {
                this.type = getComponentClass(this.type);
            }
            // If type is still a string, then no React Element matches this string.
            this._typeIsReactElementClass = typeof this.type !== 'string';
            if (DEBUG) {
                console.log('ReactNode > tryResolveTypeIsReactElementClass > type:', this._typeName);
            }
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVhY3Qtbm9kZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0Bhbmd1bGFyLXJlYWN0L2NvcmUvIiwic291cmNlcyI6WyJzcmMvbGliL3JlbmRlcmVyL3JlYWN0LW5vZGUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsNERBQTREO0FBQzVELGtDQUFrQztBQUVsQyxPQUFPLEtBQUssS0FBSyxNQUFNLE9BQU8sQ0FBQztBQUMvQixPQUFPLEtBQUssUUFBUSxNQUFNLFdBQVcsQ0FBQztBQUd0QyxPQUFPLHlCQUF5QixNQUFNLDZDQUE2QyxDQUFDO0FBQ3BGLE9BQU8sRUFBRSx1QkFBdUIsRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBQzFELE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLFlBQVksQ0FBQztBQUUvQyxNQUFNLEtBQUssR0FBRyxLQUFLLENBQUM7QUFFcEIsTUFBTSxVQUFVLFdBQVcsQ0FBQyxJQUFTO0lBQ25DLE9BQW1CLElBQUssQ0FBQyx3QkFBd0IsS0FBSyxTQUFTLENBQUM7QUFDbEUsQ0FBQztBQUVEOzs7R0FHRztBQUNILE1BQU0sT0FBTyxTQUFTO0lBdUNwQixZQUFvQixJQUErQjtRQUEvQixTQUFJLEdBQUosSUFBSSxDQUEyQjtRQXRDbkQsMEVBQTBFO1FBQzFFLDBFQUEwRTtRQUMxRSx3RUFBd0U7UUFDeEUseUJBQXlCO1FBQ2pCLFdBQU0sR0FBRyxFQUFFLENBQUM7UUFJWixjQUFTLEdBQXFCLEVBQUUsQ0FBQztRQUVqQyxzQkFBaUIsR0FBdUIsRUFBRSxDQUFDO1FBSTNDLHNCQUFpQixHQUFZLEtBQUssQ0FBQztRQUNuQyxxQkFBZ0IsR0FBRyxJQUFJLENBQUM7UUE0QmhDLDZCQUF3QixHQUFHLEdBQUcsRUFBRSxDQUFDLElBQUksQ0FBQztRQUpwQyxJQUFJLENBQUMsZ0JBQWdCLEVBQUUsQ0FBQztRQUN4QixJQUFJLENBQUMsa0NBQWtDLEVBQUUsQ0FBQztJQUM1QyxDQUFDO0lBeEJELElBQUksVUFBVTtRQUNaLE9BQU8sSUFB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cm9zb2Z0IENvcnBvcmF0aW9uLiBBbGwgcmlnaHRzIHJlc2VydmVkLlxyXG4vLyBMaWNlbnNlZCB1bmRlciB0aGUgTUlUIExpY2Vuc2UuXHJcblxyXG5pbXBvcnQgKiBhcyBSZWFjdCBmcm9tICdyZWFjdCc7XHJcbmltcG9ydCAqIGFzIFJlYWN0RE9NIGZyb20gJ3JlYWN0LWRvbSc7XHJcblxyXG5pbXBvcnQgeyBTdHJpbmdNYXAgfSBmcm9tICcuLi9kZWNsYXJhdGlvbnMvc3RyaW5nLW1hcCc7XHJcbmltcG9ydCByZW1vdmVVbmRlZmluZWRQcm9wZXJ0aWVzIGZyb20gJy4uL3V0aWxzL29iamVjdC9yZW1vdmUtdW5kZWZpbmVkLXByb3BlcnRpZXMnO1xyXG5pbXBvcnQgeyBDSElMRFJFTl9UT19BUFBFTkRfUFJPUCB9IGZyb20gJy4vcmVhY3QtY29udGVudCc7XHJcbmltcG9ydCB7IGdldENvbXBvbmVudENsYXNzIH0gZnJvbSAnLi9yZWdpc3RyeSc7XHJcblxyXG5jb25zdCBERUJVRyA9IGZhbHNlO1xyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGlzUmVhY3ROb2RlKG5vZGU6IGFueSk6IG5vZGUgaXMgUmVhY3ROb2RlIHtcclxuICByZXR1cm4gKDxSZWFjdE5vZGU+bm9kZSkuc2V0UmVuZGVyUGVuZGluZ0NhbGxiYWNrICE9PSB1bmRlZmluZWQ7XHJcbn1cclxuXHJcbi8qKlxyXG4gKiBMb2dpY2FsIHJlcHJlc2VudGF0aW9uIG9mIGV2ZXJ5dGhpbmcgbmVlZGVkIHRvIHJlbmRlciBhIFJlYWN0IGVsZW1lbnQgaW4gdGhlXHJcbiAqIERPTSwgd2l0aCB0aGUgbmVlZGVkIG1ldGhvZHMgdG8gZG8gc28uXHJcbiAqL1xyXG5leHBvcnQgY2xhc3MgUmVhY3ROb2RlIHtcclxuICAvLyBBY2Nlc3MgdG8gdGhlc2UgcHJvcGVydGllcyBhcmUgcmVzdHJpY3RlZCB0aHJvdWdoIHNldHRlcnMgYW5kIGZ1bmN0aW9uc1xyXG4gIC8vIHNvIHRoYXQgdGhlIGRpcnR5IFwicmVuZGVyIHBlbmRpbmdcIiBzdGF0ZSBvZiB0aGlzIG9iamVjdCBjYW4gYmUgcHJvcGVybHlcclxuICAvLyB0cmFja2VkIGFuZCBhbGwgbm9kZXMgd2l0aCBcInJlbmRlciBwZW5kaW5nXCIgY2FuIGJlIGZsdXNoZWQgYXQgdGhlIGVuZFxyXG4gIC8vIG9mIGEgcmVuZGVyIG9wZXJhdGlvbi5cclxuICBwcml2YXRlIF9wcm9wcyA9IHt9O1xyXG4gIHByaXZhdGUgX2NvbW1lbnQ6IHN0cmluZztcclxuICBwcml2YXRlIF90ZXh0OiBzdHJpbmc7XHJcbiAgcHJpdmF0ZSBfdHlwZUlzUmVhY3RFbGVtZW50Q2xhc3M6IGJvb2xlYW4gfCB1bmRlZmluZWQ7XHJcbiAgcHJpdmF0ZSBfY2hpbGRyZW46IEFycmF5PFJlYWN0Tm9kZT4gPSBbXTtcclxuICBwcml2YXRlIF90eXBlTmFtZTogc3RyaW5nO1xyXG4gIHByaXZhdGUgX2NoaWxkcmVuVG9BcHBlbmQ6IEFycmF5PEhUTUxFbGVtZW50PiA9IFtdO1xyXG4gIHByaXZhdGUgX3JlbmRlcmVkRG9tRWxlbWVudDogSFRNTEVsZW1lbnQ7XHJcbiAgcHJpdmF0ZSBfcGFyZW50OiBIVE1MRWxlbWVudCB8IFJlYWN0Tm9kZTtcclxuICBwcml2YXRlIF9pc05vdFJlbmRlcmFibGU6IGJvb2xlYW47XHJcbiAgcHJpdmF0ZSBfaXNEZXN0cm95UGVuZGluZzogYm9vbGVhbiA9IGZhbHNlO1xyXG4gIHByaXZhdGUgX2lzUmVuZGVyUGVuZGluZyA9IHRydWU7XHJcblxyXG4gIGdldCBkb21FbGVtZW50KCkge1xyXG4gICAgcmV0dXJuIHRoaXMuX3JlbmRlcmVkRG9tRWxlbWVudDtcclxuICB9XHJcblxyXG4gIHNldCBwYXJlbnQocGFyZW50OiBIVE1MRWxlbWVudCB8IFJlYWN0Tm9kZSkge1xyXG4gICAgdGhpcy5fcGFyZW50ID0gcGFyZW50O1xyXG4gICAgdGhpcy5zZXRSZW5kZXJQZW5kaW5nKCk7XHJcbiAgfVxyXG5cclxuICBnZXQgcGFyZW50KCk6IEhUTUxFbGVtZW50IHwgUmVhY3ROb2RlIHtcclxuICAgIHJldHVybiB0aGlzLl9wYXJlbnQ7XHJcbiAgfVxyXG5cclxuICBnZXQgc2hvdWxkUmVuZGVyKCkge1xyXG4gICAgcmV0dXJuICF0aGlzLl9pc05vdFJlbmRlcmFibGU7XHJcbiAgfVxyXG5cclxuICBnZXQgZGVzdHJveVBlbmRpbmcoKSB7XHJcbiAgICByZXR1cm4gdGhpcy5faXNEZXN0cm95UGVuZGluZztcclxuICB9XHJcblxyXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgdHlwZT86IFJlYWN0LlJlYWN0VHlwZSB8IHN0cmluZykge1xyXG4gICAgdGhpcy5zZXRSZW5kZXJQZW5kaW5nKCk7XHJcbiAgICB0aGlzLl90cnlSZXNvbHZlVHlwZUlzUmVhY3RFbGVtZW50Q2xhc3MoKTtcclxuICB9XHJcblxyXG4gIHNldFJlbmRlclBlbmRpbmdDYWxsYmFjayA9ICgpID0+IG51bGw7XHJcblxyXG4gIC8qKlxyXG4gICAqIFRyYWNrIGFsbCBwZW5kaW5nIHJlbmRlciBvcGVyYXRpb25zIGludGVybmFsbHkgYW5kIHNldCBmbGFnIG9uXHJcbiAgICogcmVuZGVyZXIgZmFjdG9yeSBzbyB0aGF0IGEgZmx1c2ggb3BlcmF0aW9uIGNhbiBiZSBzY2hlZHVsZWQgZm9yXHJcbiAgICogdGhlIFwiZW5kXCIgb2YgcmVuZGVyLlxyXG4gICAqL1xyXG4gIHNldFJlbmRlclBlbmRpbmcoKSB7XHJcbiAgICB0aGlzLnNldFJlbmRlclBlbmRpbmdDYWxsYmFjaygpO1xyXG4gICAgdGhpcy5faXNSZW5kZXJQZW5kaW5nID0gdHJ1ZTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIE1hcmtzIHRoZSBub2RlIHRvIGJlIHJlbW92ZWQgZnJvbSB0aGUgRE9NIGluIHRoZSBuZXh0IHJlbmRlciBjeWNsZS5cclxuICAgKi9cclxuICBkZXN0cm95Tm9kZSgpIHtcclxuICAgIHRoaXMuc2V0UmVuZGVyUGVuZGluZygpO1xyXG4gICAgdGhpcy5faXNEZXN0cm95UGVuZGluZyA9IHRydWU7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBTZXRzIGFuIGF0dHJpYnV0ZSBvbiB0aGUgbm9kZS5cclxuICAgKiBAbm90ZSB0aGUgdmFsdWUgY2FuIG9ubHkgYmUgYSBgc3RyaW5nYC4gU2VlIGBzZXRQcm9wZXJ0eWAgZm9yIG90aGVyIHVzZS1jYXNlcy5cclxuICAgKiBAc2VlIGBSZW5kZXJlcjIjc2V0QXR0cmlidXRlYC5cclxuICAgKlxyXG4gICAqIEBwYXJhbSBuYW1lIFRoZSBhdHRyaWJ1dGUgbmFtZS5cclxuICAgKiBAcGFyYW0gdmFsdWUgVGhlIG5ldyB2YWx1ZS5cclxuICAgKi9cclxuICBzZXRBdHRyaWJ1dGUobmFtZTogc3RyaW5nLCB2YWx1ZTogc3RyaW5nKSB7XHJcbiAgICB0aGlzLnNldEF0dHJpYnV0ZXMoeyBbbmFtZV06IHZhbHVlIH0pO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogU2V0IGF0dHJpYnV0ZXMgb24gdGhpcyBub2RlLlxyXG4gICAqIE5vdGUgdGhhdCB2YWx1ZXMgY2FuIG9ubHkgYmUgb2YgdHlwZSBgc3RyaW5nYC4gU2VlIGBzZXRQcm9wZXJ0aWVzYCBmb3Igb3RoZXIgdXNlLWNhc2VzLlxyXG4gICAqIEBzZWUgYFJlbmRlcmVyMiNzZXRBdHRyaWJ1dGVgLlxyXG4gICAqXHJcbiAgICogQHBhcmFtIGF0dHJpYnV0ZXMgdGhlIGF0dHJpYnV0ZXMgdG8gc2V0LlxyXG4gICAqL1xyXG4gIHNldEF0dHJpYnV0ZXMoYXR0cmlidXRlczogU3RyaW5nTWFwPHN0cmluZz4pIHtcclxuICAgIHRoaXMuc2V0UHJvcGVydGllcyhhdHRyaWJ1dGVzKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIFNldHMgYSBwcm9wIGluIHRoZSB1bmRlcmx5aW5nIFJlYWN0IGVsZW1lbnQuXHJcbiAgICogQHNlZSBgUmVuZGVyZXIyI3NldFByb3BlcnR5YC5cclxuICAgKlxyXG4gICAqIEBwYXJhbSBuYW1lIFRoZSBwcm9wZXJ0eSBuYW1lLlxyXG4gICAqIEBwYXJhbSB2YWx1ZSBUaGUgbmV3IHZhbHVlLlxyXG4gICAqL1xyXG4gIHNldFByb3BlcnR5KG5hbWU6IHN0cmluZywgdmFsdWU6IGFueSkge1xyXG4gICAgdGhpcy5zZXRQcm9wZXJ0aWVzKHsgW25hbWVdOiB2YWx1ZSB9KTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIExpa2UgYHNldFByb3BlcnR5YCBidXQgZm9yIG11bHRpcGxlIHByb3BzIGF0IG9uY2UuXHJcbiAgICpcclxuICAgKiBAcGFyYW0gcHJvcGVydGllcyBBbiBvYmplY3Qgd2l0aCB0aGUgcHJvcHMuXHJcbiAgICovXHJcbiAgc2V0UHJvcGVydGllcyhwcm9wZXJ0aWVzOiBTdHJpbmdNYXApIHtcclxuICAgIHRoaXMuc2V0UmVuZGVyUGVuZGluZygpO1xyXG4gICAgT2JqZWN0LmFzc2lnbih0aGlzLl9wcm9wcywgcmVtb3ZlVW5kZWZpbmVkUHJvcGVydGllcyhwcm9wZXJ0aWVzKSk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBSZW1vdmUgYSBwcm9wIG9yIGFuIGF0dHJpYnV0ZSBmcm9tIHRoZSB1bmRlcmx5aW5nIFJlYWN0IGVsZW1lbnQuXHJcbiAgICogQHNlZSBgUmVuZGVyZXIyI3JlbW92ZUF0dHJpYnV0ZWAuXHJcbiAgICpcclxuICAgKiBAcGFyYW0gbmFtZSBUaGUgcHJvcGVydHkgbmFtZS5cclxuICAgKiBAcGFyYW0gY2hpbGROYW1lIF9PcHRpb25hbF8gQSBwcm9wZXJ0eSBvZiBgbmFtZWAgdG8gcmVtb3ZlIGluc3RlYWQuXHJcbiAgICogQHJldHVybnMgdGhlIGRlbGV0ZWQgcHJvcGVydHlcclxuICAgKi9cclxuICByZW1vdmVQcm9wZXJ0eShuYW1lOiBzdHJpbmcsIGNoaWxkTmFtZT86IHN0cmluZykge1xyXG4gICAgdGhpcy5zZXRSZW5kZXJQZW5kaW5nKCk7XHJcbiAgICBpZiAoY2hpbGROYW1lKSB7XHJcbiAgICAgIHJldHVybiBkZWxldGUgdGhpcy5fcHJvcHNbbmFtZV1bY2hpbGROYW1lXTtcclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4gZGVsZXRlIHRoaXMuX3Byb3BzW25hbWVdO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogQWRkIGEgZGlyZWN0IGNoaWxkIG9mIHRoaXMgbm9kZS5cclxuICAgKiBAc2VlIGBSZW5kZXJlcjIjYWRkQ2hpbGRgLlxyXG4gICAqXHJcbiAgICogQHBhcmFtIG5vZGUgVGhlIG5vZGUgdG8gYWRkLlxyXG4gICAqL1xyXG4gIGFkZENoaWxkKG5vZGU6IFJlYWN0Tm9kZSkge1xyXG4gICAgdGhpcy5zZXRSZW5kZXJQZW5kaW5nKCk7XHJcbiAgICB0aGlzLl9jaGlsZHJlbi5wdXNoKG5vZGUpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogUmVtb3ZlIGEgZGlyZWN0IGNoaWxkIG9mIHRoaXMgbm9kZS5cclxuICAgKiBAc2VlIGBSZW5kZXJlcjIjcmVtb3ZlQ2hpbGRgLlxyXG4gICAqXHJcbiAgICogQHBhcmFtIG5vZGUgVGhlIG5vZGUgdG8gcmVtb3ZlLlxyXG4gICAqL1xyXG4gIHJlbW92ZUNoaWxkKG5vZGU6IFJlYWN0Tm9kZSkge1xyXG4gICAgdGhpcy5zZXRSZW5kZXJQZW5kaW5nKCk7XHJcbiAgICB0aGlzLl9jaGlsZHJlbiA9IHRoaXMuX2NoaWxkcmVuLmZpbHRlcihjaGlsZCA9PiBjaGlsZCAhPT0gbm9kZSk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBDYXN0IHRoZSBub2RlIHRvIGEgY29tbWVudCBub2RlLlxyXG4gICAqIEBzZWUgYFJlbmRlcmVyMiNjcmVhdGVDb21tZW50YC5cclxuICAgKlxyXG4gICAqIEBwYXJhbSB2YWx1ZSB0aGUgdGV4dCBpbiB0aGUgY29tbWVudCB0byByZW5kZXIuXHJcbiAgICogQHJldHVybnMgaXRzZWxmLlxyXG4gICAqL1xyXG4gIGFzQ29tbWVudCh2YWx1ZTogc3RyaW5nKSB7XHJcbiAgICB0aGlzLnNldFJlbmRlclBlbmRpbmcoKTtcclxuICAgIHRoaXMudHlwZSA9IHVuZGVmaW5lZDtcclxuICAgIHRoaXMuX2NvbW1lbnQgPSB2YWx1ZTtcclxuICAgIHJldHVybiB0aGlzO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogQ2FzdCB0aGUgbm9kZSB0byBhIHRleHQgbm9kZS5cclxuICAgKiBAc2VlIGBSZW5kZXJlcjIjY3JlYXRlVGV4dGAuXHJcbiAgICpcclxuICAgKiBAcGFyYW0gdmFsdWUgdGhlIHRleHQgdG8gcmVuZGVyLlxyXG4gICAqIEByZXR1cm5zIGl0c2VsZi5cclxuICAgKi9cclxuICBhc1RleHQodmFsdWU6IHN0cmluZykge1xyXG4gICAgdGhpcy5zZXRSZW5kZXJQZW5kaW5nKCk7XHJcbiAgICB0aGlzLnR5cGUgPSB1bmRlZmluZWQ7XHJcbiAgICB0aGlzLl90ZXh0ID0gdmFsdWU7XHJcblxyXG4gICAgLy8gU2tpcCBhcHBlbmRpbmcgYW5kIHJlbmRlcmluZyBvZiBlbXB0eSB0ZXh0IG5vZGVzLiBUaGlzIG1heSBjYXVzZSBhIGJ1Z1xyXG4gICAgLy8gaWYgYSBzaW5nbGUgc3BhY2UgaXMgZGVzaXJlZC4uLlxyXG4gICAgaWYgKCF2YWx1ZSB8fCAhdmFsdWUudHJpbSgpKSB7XHJcbiAgICAgIHRoaXMuX2lzTm90UmVuZGVyYWJsZSA9IHRydWU7XHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuIHRoaXM7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBSZW5kZXIgdGhlIG5vZGUgdG8gdGhlIERPTSwgb3IgdW5tb3VudCBpdCwgYXMgbmVjZXNzYXJ5LlxyXG4gICAqXHJcbiAgICogQHJldHVybnMgaXRzZWxmLlxyXG4gICAqL1xyXG4gIHJlbmRlcigpOiBSZWFjdE5vZGUge1xyXG4gICAgLy8gT25seSBjb21wbGV0ZSByZW5kZXIgb3BlcmF0aW9ucyBmb3IgUmVhY3ROb2RlcyB0aGF0IGFyZSBwYXJlbnRlZCBieSBIVE1MRWxlbWVudHMuXHJcbiAgICAvLyBUaG9zZSB0aGF0IGFyZSBwYXJlbnRlZCBieSBvdGhlciBSZWFjdE5vZGVzIHdpbGwgYmUgcmVuZGVyZWQgcmVjdXJzaXZlbHkgYnkgdGhlaXJcclxuICAgIC8vIHBhcmVudC5cclxuICAgIGlmICghaXNSZWFjdE5vZGUodGhpcy5fcGFyZW50KSkge1xyXG4gICAgICBpZiAodGhpcy5faXNEZXN0cm95UGVuZGluZyAmJiB0aGlzLl9wYXJlbnQpIHtcclxuICAgICAgICBpZiAoREVCVUcpIHtcclxuICAgICAgICAgIGNvbnNvbGUubG9nKCdSZWFjdE5vZGUgPiByZW5kZXIgPiBkZXN0cm95ID4gbm9kZTonLCB0aGlzLnRvU3RyaW5nKCksICdwYXJlbnQ6JywgdGhpcy5wYXJlbnQpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBSZWFjdERPTS51bm1vdW50Q29tcG9uZW50QXROb2RlKHRoaXMuX3BhcmVudCk7XHJcbiAgICAgICAgcmV0dXJuIHRoaXM7XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIGlmICh0aGlzLl9pc1JlbmRlclBlbmRpbmcpIHtcclxuICAgICAgICBpZiAoREVCVUcpIHtcclxuICAgICAgICAgIGNvbnNvbGUubG9nKCdSZWFjdE5vZGUgPiByZW5kZXIgPiBub2RlOicsIHRoaXMudG9TdHJpbmcoKSwgJ3BhcmVudDonLCB0aGlzLnBhcmVudCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIC8vIEl0IGlzIGV4cGVjdGVkIHRoYXQgdGhlIGVsZW1lbnQgd2lsbCBiZSByZWNyZWF0ZWQgYW5kIHJlLXJlbmRlcmVkIHdpdGggZWFjaCBhdHRyaWJ1dGUgY2hhbmdlLlxyXG4gICAgICAgIC8vIFNlZTogaHR0cHM6Ly9yZWFjdGpzLm9yZy9kb2NzL3JlbmRlcmluZy1lbGVtZW50cy5odG1sXHJcbiAgICAgICAgUmVhY3RET00ucmVuZGVyKHRoaXMuX3JlbmRlclJlY3Vyc2l2ZSgpIGFzIFJlYWN0LlJlYWN0RWxlbWVudDx7fT4sIHRoaXMuX3BhcmVudCk7XHJcbiAgICAgICAgdGhpcy5faXNSZW5kZXJQZW5kaW5nID0gZmFsc2U7XHJcbiAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4gdGhpcztcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIEFwcGVuZHMgYSBjaGlsZC5cclxuICAgKlxyXG4gICAqIEBzZWUgYFJlbmRlcmVyMiNhcHBlbmRDaGlsZGAuXHJcbiAgICogQG5vdGUgVGhpcyBpcyBjYWxsZWQgYnkgQW5ndWxhciBjb3JlIHdoZW4gcHJvamVjdGVkIGNvbnRlbnQgaXMgYmVpbmcgYWRkZWQuXHJcbiAgICpcclxuICAgKiBAcGFyYW0gcHJvamVjdGVkQ29udGVudCB0aGUgY29udGVudCB0byBwcm9qZWN0LlxyXG4gICAqL1xyXG4gIGFwcGVuZENoaWxkKHByb2plY3RlZENvbnRlbnQ6IEhUTUxFbGVtZW50KSB7XHJcbiAgICBpZiAoREVCVUcpIHtcclxuICAgICAgY29uc29sZS5lcnJvcihcclxuICAgICAgICAnUmVhY3ROb2RlID4gYXBwZW5kQ2hpbGQgPiBub2RlOicsXHJcbiAgICAgICAgdGhpcy50b1N0cmluZygpLFxyXG4gICAgICAgICdwcm9qZWN0ZWRDb250ZW50OicsXHJcbiAgICAgICAgcHJvamVjdGVkQ29udGVudC50b1N0cmluZygpLnRyaW0oKVxyXG4gICAgICApO1xyXG4gICAgfVxyXG4gICAgdGhpcy5fY2hpbGRyZW5Ub0FwcGVuZC5wdXNoKHByb2plY3RlZENvbnRlbnQpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogQG5vdGUgZm9yIGVhc2llciBkZWJ1Z2dpbmcuXHJcbiAgICovXHJcbiAgdG9TdHJpbmcoKTogc3RyaW5nIHtcclxuICAgIGlmICh0aGlzLl90eXBlTmFtZSkge1xyXG4gICAgICByZXR1cm4gYFske3RoaXMuX3R5cGVOYW1lfSBSZWFjdE5vZGVdYDtcclxuICAgIH1cclxuXHJcbiAgICBpZiAodGhpcy5fdGV4dCkge1xyXG4gICAgICByZXR1cm4gJ1t0ZXh0IFJlYWN0Tm9kZV0nO1xyXG4gICAgfVxyXG5cclxuICAgIGlmICh0aGlzLl9jb21tZW50KSB7XHJcbiAgICAgIHJldHVybiAnW2NvbW1lbnQgUmVhY3ROb2RlXSc7XHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuICdbdW5kZWZpbmVkIFJlYWN0Tm9kZV0nO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBfcmVuZGVyUmVjdXJzaXZlKGtleT86IHN0cmluZyk6IFJlYWN0LlJlYWN0RWxlbWVudDx7fT4gfCBzdHJpbmcge1xyXG4gICAgY29uc3QgY2hpbGRyZW4gPSB0aGlzLl9jaGlsZHJlblxyXG4gICAgICA/IHRoaXMuX2NoaWxkcmVuLm1hcCgoY2hpbGQsIGluZGV4KSA9PiBjaGlsZC5fcmVuZGVyUmVjdXJzaXZlKGluZGV4LnRvU3RyaW5nKCkpKVxyXG4gICAgICA6IFtdO1xyXG5cclxuICAgIGlmICh0aGlzLl90ZXh0KSB7XHJcbiAgICAgIHJldHVybiB0aGlzLl90ZXh0O1xyXG4gICAgfVxyXG5cclxuICAgIHRoaXMuX3Byb3BzW0NISUxEUkVOX1RPX0FQUEVORF9QUk9QXSA9IHRoaXMuX2NoaWxkcmVuVG9BcHBlbmQ7XHJcblxyXG4gICAgaWYgKGtleSkge1xyXG4gICAgICB0aGlzLl9wcm9wc1sna2V5J10gPSBrZXk7XHJcbiAgICB9XHJcblxyXG4gICAgLy8gSnVzdCBoYXZpbmcgc29tZSBwcm9wcyBvbiBhIFJlYWN0IGVsZW1lbnQgY2FuIGNhdXNlIGl0IHRvXHJcbiAgICAvLyBiZWhhdmUgdW5kZXNpcmFibHksIGFuZCBzaW5jZSB0aGUgdGVtcGxhdGVzIGFyZSBoYXJkLWNvZGVkIHRvIHBhc3NcclxuICAgIC8vIGFsbCBJbnB1dHMgYWxsIHRoZSB0aW1lLCB0aGV5IHBhc3MgYHVuZGVmaW5lZGAgdmFsdWVzIHRvby5cclxuICAgIC8vIFRoaXMgZW5zdXJlcyB0aGVzZSBhcmUgcmVtb3ZlZC5cclxuICAgIC8vIEFkZGl0aW9uYWxseSwgdGhlcmUgYXJlIHNvbWUgdGhpbmdzIHRoYXQgQW5ndWxhciB0ZW1wbGF0aW5nIGZvcmJpZHMsXHJcbiAgICAvLyBhbmQgc3RvcHMgYXQtY29tcGlsZSB0aW1lICh3aXRoIGVycm9ycyksIHN1Y2ggYXMgYElucHV0YHMgYmVpbmcgcHJlZml4ZWQgd2l0aCBgb25gLlxyXG4gICAgLy8gU2luY2UgUmVhY3QgZG9lcyBub3QgaGF2ZSB0aGUgbm90aW9uIG9mIGBPdXRwdXRgcyBhcyBBbmd1bGFyICh0aGV5IGFyZSBqdXN0IHByb3BzIG9mIHR5cGUgZnVuY3Rpb24sIGVzc2VudGlhbGx5IGNhbGxiYWNrcykuXHJcbiAgICAvLyBUbyB3b3JrIGFyb3VuZCB0aGlzLCB3ZSwgYnkgY29udmVudGlvbiwgcHJlZml4IGFueSBQYXNjYWxDYXNlZCBwcm9wIHdpdGggYG9uYCBoZXJlLCBhZnRlciB0aGUgdGVtcGxhdGUgaGFzIGFscmVhZHkgYmVlbiBjb21waWxlZC5cclxuICAgIGNvbnN0IGNsZWFyZWRQcm9wcyA9IHRoaXMuX3RyYW5zZm9ybVByb3BzKHJlbW92ZVVuZGVmaW5lZFByb3BlcnRpZXModGhpcy5fcHJvcHMpKTtcclxuXHJcbiAgICBpZiAoREVCVUcpIHtcclxuICAgICAgY29uc29sZS53YXJuKFxyXG4gICAgICAgICdSZWFjdE5vZGUgPiByZW5kZXJSZWN1cnNpdmUgPiB0eXBlOicsXHJcbiAgICAgICAgdGhpcy50b1N0cmluZygpLFxyXG4gICAgICAgICdwcm9wczonLFxyXG4gICAgICAgIHRoaXMuX3Byb3BzLFxyXG4gICAgICAgICdjaGlsZHJlbjonLFxyXG4gICAgICAgIGNoaWxkcmVuXHJcbiAgICAgICk7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gUmVhY3QuY3JlYXRlRWxlbWVudCh0aGlzLnR5cGUsIGNsZWFyZWRQcm9wcywgY2hpbGRyZW4ubGVuZ3RoID4gMCA/IGNoaWxkcmVuIDogdW5kZWZpbmVkKTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgX3RyYW5zZm9ybVByb3BzPFRQcm9wcyBleHRlbmRzIG9iamVjdD4ocHJvcHM6IFRQcm9wcykge1xyXG4gICAgcmV0dXJuIE9iamVjdC5lbnRyaWVzKHByb3BzKS5yZWR1Y2UoKGFjYywgW2tleSwgdmFsdWVdKSA9PiB7XHJcbiAgICAgIGNvbnN0IFtuZXdLZXksIG5ld1ZhbHVlXSA9IHR5cGVvZiBrZXkgIT09ICdzdHJpbmcnID8gW2tleSwgdmFsdWVdIDogdGhpcy5fdHJhbnNmb3JtUHJvcChrZXksIHZhbHVlKTtcclxuICAgICAgcmV0dXJuIE9iamVjdC5hc3NpZ24oYWNjLCB7IFtuZXdLZXldOiBuZXdWYWx1ZSB9KTtcclxuICAgIH0sIHt9KTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgX3RyYW5zZm9ybVByb3A8VFZhbHVlID0gYW55PihuYW1lOiBzdHJpbmcsIHZhbHVlOiBUVmFsdWUpOiBbc3RyaW5nLCBUVmFsdWVdIHtcclxuICAgIC8vIHByb3AgbmFtZSBpcyBjYW1lbENhc2VkIGFscmVhZHlcclxuICAgIGNvbnN0IGZpcnN0TGV0dGVyID0gbmFtZVswXTtcclxuICAgIGlmIChmaXJzdExldHRlciA9PT0gZmlyc3RMZXR0ZXIudG9Mb3dlckNhc2UoKSkge1xyXG4gICAgICByZXR1cm4gW25hbWUsIHZhbHVlXTtcclxuICAgIH1cclxuXHJcbiAgICAvLyBwcm9wIG5hbWUgaXMgUGFzY2FsQ2FzZWQgJiBpcyBhIGZ1bmN0aW9uIC0gYXNzdW1pbmcgcmVuZGVyIHByb3Agb3IgY2FsbGJhY2sgcHJvcCB0aGF0IGhhcyByZXR1cm4gdmFsdWVcclxuICAgIC8vIE5PVEU6IEFuZ3VsYXIgZG9lc24ndCBhbGxvdyBwYXNzaW5nIEBJbnB1dHMgdGhhdCBhcmUgcHJlZml4ZWQgd2l0aCBcIm9uXCIuIFRoaXMgaXMgdXNlZnVsIGZvciByZW5kZXIgcHJvcHMgYW5kIHByb3BlcnRpZXMgcmVwcmVzZW50aW5nIHRoZSBcIm9uXCIgc3RhdGUgKGZvciBleGFtcGxlLCBUb2dnbGUpLlxyXG4gICAgLy8gQXMgYSBjb252ZW50aW9uLCBhbnkgQElucHV0IHRoYXQgc3RhcnRzIHdpdGggYSBjYXBpdGFsIGxldHRlciBpcyBwcmVmaXhlZCB3aXRoIFwib25cIiB3aGVuIHBhc3NlZCBhcyBhIHByb3AgdG8gdGhlIHVuZGVybHlpbmcgUmVhY3QgY29tcG9uZW50LlxyXG4gICAgcmV0dXJuIFtgb24ke25hbWV9YCwgdmFsdWVdO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBfdHJ5UmVzb2x2ZVR5cGVJc1JlYWN0RWxlbWVudENsYXNzKCkge1xyXG4gICAgaWYgKHRoaXMuX3R5cGVJc1JlYWN0RWxlbWVudENsYXNzID09PSB1bmRlZmluZWQpIHtcclxuICAgICAgLy8gQ29tbWVudHMgYW5kIHRleHQgaGF2ZSBubyB0eXBlLlxyXG4gICAgICBpZiAoIXRoaXMudHlwZSkge1xyXG4gICAgICAgIHJldHVybjtcclxuICAgICAgfVxyXG5cclxuICAgICAgLy8gU3RvcmUgdGhlIG5hbWUgb2YgdGhlIHR5cGUgZm9yIHRoZSB0b1N0cmluZyBtZXNzYWdlIChkZWJ1Z2dpbmcpLlxyXG4gICAgICB0aGlzLl90eXBlTmFtZSA9IHRoaXMudHlwZSBhcyBzdHJpbmc7XHJcblxyXG4gICAgICAvLyBBdHRlbXB0IHRvIHJlc29sdmUgdGhlIHR5cGUgYXMgYSBSZWFjdCBFbGVtZW50IGNsYXNzIG5hbWUvdHlwZS5cclxuICAgICAgLy8gU2luY2UgQW5ndWxhciB0ZW1wbGF0ZXMgYXJlIGp1c3Qgc3RyaW5ncywgd2UgY2FuJ3QgaW5jbHVkZSB0eXBlcyBpbiB0aGVtLlxyXG4gICAgICAvLyBUaGVyZWZvcmUsIHdlIHVzZSB0aGUgY29tcG9uZW50IHJlZ2lzdHJ5IHRvIHJlc29sdmUgdGhlIHR5cGUgb2YgYSBjb21wb25lbnQgZnJvbSBhIHN0cmluZy5cclxuICAgICAgaWYgKHR5cGVvZiB0aGlzLnR5cGUgPT09ICdzdHJpbmcnKSB7XHJcbiAgICAgICAgdGhpcy50eXBlID0gZ2V0Q29tcG9uZW50Q2xhc3ModGhpcy50eXBlKTtcclxuICAgICAgfVxyXG5cclxuICAgICAgLy8gSWYgdHlwZSBpcyBzdGlsbCBhIHN0cmluZywgdGhlbiBubyBSZWFjdCBFbGVtZW50IG1hdGNoZXMgdGhpcyBzdHJpbmcuXHJcbiAgICAgIHRoaXMuX3R5cGVJc1JlYWN0RWxlbWVudENsYXNzID0gdHlwZW9mIHRoaXMudHlwZSAhPT0gJ3N0cmluZyc7XHJcblxyXG4gICAgICBpZiAoREVCVUcpIHtcclxuICAgICAgICBjb25zb2xlLmxvZygnUmVhY3ROb2RlID4gdHJ5UmVzb2x2ZVR5cGVJc1JlYWN0RWxlbWVudENsYXNzID4gdHlwZTonLCB0aGlzLl90eXBlTmFtZSk7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICB9XHJcbn1cclxuIl19