// Copyright (c) Microsoft Corporation. All rights reserved.
// Licensed under the MIT License.
/// <reference path="../@types/geteventlisteners.d.ts" />
import * as tslib_1 from "tslib";
import { Input, } from '@angular/core';
import classnames from 'classnames';
import toStyle from 'css-to-style';
import stylenames from 'stylenames';
import { isReactNode } from '../renderer/react-node';
import { isReactRendererData } from '../renderer/renderer';
import { toObject } from '../utils/object/to-object';
import { afterRenderFinished } from '../utils/render/render-delay';
import { createInputJsxRenderer, createRenderPropHandler } from './render-props';
// Forbidden attributes are still ignored, since they may be set from the wrapper components themselves (forbidden is only applied for users of the wrapper components)
var ignoredAttributeMatchers = [/^_?ng-?.*/, /^style$/, /^class$/];
var ngClassRegExp = /^ng-/;
var defaultWrapperComponentOptions = {
    setHostDisplay: false,
};
/**
 * Base class for Angular @Components wrapping React Components.
 * Simplifies some of the handling around passing down props and CSS styling on the host component.
 */
// NOTE: TProps is not used at the moment, but a preparation for a potential future change.
var ReactWrapperComponent = /** @class */ (function () {
    /**
     * Creates an instance of ReactWrapperComponent.
     * @param elementRef The host element.
     * @param changeDetectorRef The change detector for the component.
     * @param renderer The Angular renderer.
     */
    function ReactWrapperComponent(elementRef, changeDetectorRef, renderer, _a) {
        var _b = _a === void 0 ? defaultWrapperComponentOptions : _a, setHostDisplay = _b.setHostDisplay, ngZone = _b.ngZone;
        this.elementRef = elementRef;
        this.changeDetectorRef = changeDetectorRef;
        this.renderer = renderer;
        this._ngZone = ngZone;
        this._shouldSetHostDisplay = setHostDisplay;
    }
    Object.defineProperty(ReactWrapperComponent.prototype, "contentClass", {
        get: function () {
            return this._contentClass;
        },
        /**
         * Alternative to `class` and `[ngClass]` using the same syntax.
         *
         * @description Since this is a wrapper component, sticking to the virtual DOM concept, its DOM element shouldn't have any styling of its own.
         * Instead, any value passes to `contentClass` will be passed to the root component's class as `className`.
         */
        set: function (value) {
            this._contentClass = value;
            if (isReactNode(this.reactNodeRef.nativeElement)) {
                this.reactNodeRef.nativeElement.setProperty('className', classnames(value));
                this.markForCheck();
            }
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(ReactWrapperComponent.prototype, "contentStyle", {
        get: function () {
            return this._contentStyle;
        },
        /**
         * Alternative to `style` and `[ngStyle]` using (almost) the same syntax.
         * All syntax supports by `ngStyle` is supported, with the exception of specifying units in the key (`{ 'width.px': 12 }`).
         *
         * @description Since this is a wrapper component, sticking to the virtual DOM concept, this should have any styling of its own.
         * Any value passes to `contentStyle` will be passed to the root component's style.
         */
        set: function (value) {
            this._contentStyle = value;
            if (isReactNode(this.reactNodeRef.nativeElement)) {
                var stringValue = typeof value === 'string' ? value : stylenames(value);
                this.reactNodeRef.nativeElement.setProperty('style', toStyle(stringValue));
                this.markForCheck();
            }
        },
        enumerable: true,
        configurable: true
    });
    ReactWrapperComponent.prototype.ngAfterContentInit = function () {
        this._passAttributesAsProps();
    };
    ReactWrapperComponent.prototype.ngAfterViewInit = function () {
        var _this = this;
        if (this._shouldSetHostDisplay) {
            this._setHostDisplay();
        }
        // NOTE: Workaround/fix for Issue #5 (https://github.com/Microsoft/angular-react/issues/5).
        // The wrapper component isn't added to the root react nodes list when it's inside a `ReactContent` node, we manually add it (note that the root nodes list is a `Set`, so it won't duplicate nodes if already exist).
        // There's potentially a better solution instead of this
        var rendererData = this.renderer.data;
        if (isReactRendererData(rendererData)) {
            afterRenderFinished(function () {
                var nativeElement = _this.reactNodeRef.nativeElement;
                if (isReactNode(nativeElement)) {
                    rendererData.addRootNode(nativeElement);
                }
            });
        }
    };
    ReactWrapperComponent.prototype.ngOnChanges = function (changes) {
        this._passAttributesAsProps();
        this.markForCheck();
    };
    /**
     * Mark the component as one that needed re-rendering on the React side,
     * and mark for change detection on the Angular side.
     */
    ReactWrapperComponent.prototype.markForCheck = function () {
        if (isReactNode(this.reactNodeRef.nativeElement)) {
            this.reactNodeRef.nativeElement.setRenderPending();
        }
        this.changeDetectorRef.markForCheck();
    };
    /**
     * Create an JSX renderer for an `@Input` property.
     * @param input The input property.
     * @param additionalProps optional additional props to pass to the `ReactContent` object that will render the content.
     */
    ReactWrapperComponent.prototype.createInputJsxRenderer = function (input, additionalProps) {
        if (input === undefined) {
            return undefined;
        }
        if (!this._ngZone) {
            throw new Error('To create an input JSX renderer you must pass an NgZone to the constructor.');
        }
        return createInputJsxRenderer(input, this._ngZone, additionalProps);
    };
    /**
     * Create an event handler for a render prop
     * @param renderInputValue the value of the render `@Input` property.
     * @param jsxRenderer an optional renderer to use.
     * @param additionalProps optional additional props to pass to the `ReactContent` object that will render the content.
     */
    ReactWrapperComponent.prototype.createRenderPropHandler = function (renderInputValue, options) {
        return createRenderPropHandler(renderInputValue, this._ngZone, options);
    };
    ReactWrapperComponent.prototype._passAttributesAsProps = function () {
        var _this = this;
        var hostAttributes = Array.from(this.elementRef.nativeElement.attributes);
        if (!this.reactNodeRef || !isReactNode(this.reactNodeRef.nativeElement)) {
            throw new Error('reactNodeRef must hold a reference to a ReactNode');
        }
        // Ensure there are no blacklisted props. Suggest alternative as error if there is any
        hostAttributes.forEach(function (attr) {
            var _a = tslib_1.__read(_this._isForbiddenAttribute(attr), 2), forbidden = _a[0], alternativeAttrName = _a[1];
            if (forbidden) {
                throw new Error("[" + _this.elementRef
                    .nativeElement.tagName.toLowerCase() + "] React wrapper components cannot have the '" + attr.name + "' attribute set. Use the following alternative: " + (alternativeAttrName || ''));
            }
        });
        var whitelistedHostAttributes = hostAttributes.filter(function (attr) { return !_this._isIgnoredAttribute(attr); });
        var props = whitelistedHostAttributes.reduce(function (acc, attr) {
            var _a;
            return (tslib_1.__assign({}, acc, (_a = {}, _a[attr.name] = attr.value, _a)));
        }, {});
        var eventListeners = this.elementRef.nativeElement.getEventListeners();
        var eventHandlersProps = eventListeners && Object.keys(eventListeners).length
            ? toObject(Object.values(eventListeners).map(function (_a) {
                var _b = tslib_1.__read(_a, 1), eventListener = _b[0];
                return [
                    eventListener.type,
                    function (ev) { return eventListener.listener(ev && ev.nativeEvent); },
                ];
            }))
            : {};
        {
        }
        this.reactNodeRef.nativeElement.setProperties(tslib_1.__assign({}, props, eventHandlersProps));
    };
    ReactWrapperComponent.prototype._setHostDisplay = function () {
        var nativeElement = this.elementRef.nativeElement;
        // We want to wait until child elements are rendered
        requestAnimationFrame(function () {
            if (nativeElement.firstElementChild) {
                var rootChildDisplay = getComputedStyle(nativeElement.firstElementChild).display;
                nativeElement.style.display = rootChildDisplay;
            }
        });
    };
    ReactWrapperComponent.prototype._isIgnoredAttribute = function (attr) {
        return ignoredAttributeMatchers.some(function (regExp) { return regExp.test(attr.name); });
    };
    ReactWrapperComponent.prototype._isForbiddenAttribute = function (attr) {
        var name = attr.name, value = attr.value;
        if (name === 'key')
            return [true, undefined];
        if (name === 'class' && value.split(' ').some(function (className) { return !ngClassRegExp.test(className); }))
            return [true, 'contentClass'];
        if (name === 'style') {
            var style = toStyle(value);
            // Only allowing style if it's something that changes the display - setting anything else should be done on the child component directly (via the `styles` attribute in fabric for example)
            if (Object.entries(style).filter(function (_a) {
                var _b = tslib_1.__read(_a, 2), key = _b[0], value = _b[1];
                return value && key !== 'display';
            }).length > 0) {
                return [true, 'contentStyle'];
            }
        }
        return [false, undefined];
    };
    tslib_1.__decorate([
        Input(),
        tslib_1.__metadata("design:type", Object),
        tslib_1.__metadata("design:paramtypes", [Object])
    ], ReactWrapperComponent.prototype, "contentClass", null);
    tslib_1.__decorate([
        Input(),
        tslib_1.__metadata("design:type", Object),
        tslib_1.__metadata("design:paramtypes", [Object])
    ], ReactWrapperComponent.prototype, "contentStyle", null);
    return ReactWrapperComponent;
}());
export { ReactWrapperComponent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoid3JhcHBlci1jb21wb25lbnQuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AYW5ndWxhci1yZWFjdC9jb3JlLyIsInNvdXJjZXMiOlsic3JjL2xpYi9jb21wb25lbnRzL3dyYXBwZXItY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLDREQUE0RDtBQUM1RCxrQ0FBa0M7QUFDbEMseURBQXlEOztBQUV6RCxPQUFPLEVBSUwsS0FBSyxHQU1OLE1BQU0sZUFBZSxDQUFDO0FBQ3ZCLE9BQU8sVUFBVSxNQUFNLFlBQVksQ0FBQztBQUNwQyxPQUFPLE9BQU8sTUFBTSxjQUFjLENBQUM7QUFDbkMsT0FBTyxVQUEyQixNQUFNLFlBQVksQ0FBQztBQUlyRCxPQUFPLEVBQUUsV0FBVyxFQUFFLE1BQU0sd0JBQXdCLENBQUM7QUFDckQsT0FBTyxFQUFFLG1CQUFtQixFQUFFLE1BQU0sc0JBQXNCLENBQUM7QUFDM0QsT0FBTyxFQUFFLFFBQVEsRUFBRSxNQUFNLDJCQUEyQixDQUFDO0FBQ3JELE9BQU8sRUFBRSxtQkFBbUIsRUFBRSxNQUFNLDhCQUE4QixDQUFDO0FBQ25FLE9BQU8sRUFBdUMsc0JBQXNCLEVBQUUsdUJBQXVCLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUV0SCx1S0FBdUs7QUFDdkssSUFBTSx3QkFBd0IsR0FBRyxDQUFDLFdBQVcsRUFBRSxTQUFTLEVBQUUsU0FBUyxDQUFDLENBQUM7QUFFckUsSUFBTSxhQUFhLEdBQUcsTUFBTSxDQUFDO0FBc0I3QixJQUFNLDhCQUE4QixHQUE0QjtJQUM5RCxjQUFjLEVBQUUsS0FBSztDQUN0QixDQUFDO0FBRUY7OztHQUdHO0FBQ0gsMkZBQTJGO0FBQzNGO0lBaURFOzs7OztPQUtHO0lBQ0gsK0JBQ2tCLFVBQW1DLEVBQ2xDLGlCQUFvQyxFQUNwQyxRQUFtQixFQUNwQyxFQUFvRjtZQUFwRix3REFBb0YsRUFBbEYsa0NBQWMsRUFBRSxrQkFBTTtRQUhSLGVBQVUsR0FBVixVQUFVLENBQXlCO1FBQ2xD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O1NBQ0Y7UUFFRCxPQUFPLENBQUMsS0FBSyxFQUFFLFNBQVMsQ0FBQyxDQUFDO0lBQzVCLENBQUM7SUExTUQ7UUFEQyxLQUFLLEVBQUU7Ozs2REFPUDtJQWNEO1FBREMsS0FBSyxFQUFFOzs7NkRBUVA7SUFnTEgsNEJBQUM7Q0FBQSxBQTNORCxJQTJOQztTQTNOcUIscUJBQXFCIiwic291cmNlc0NvbnRlbnQiOlsiLy8gQ29weXJpZ2h0IChjKSBNaWNyb3NvZnQgQ29ycG9yYXRpb24uIEFsbCByaWdodHMgcmVzZXJ2ZWQuXHJcbi8vIExpY2Vuc2VkIHVuZGVyIHRoZSBNSVQgTGljZW5zZS5cclxuLy8vIDxyZWZlcmVuY2UgcGF0aD1cIi4uL0B0eXBlcy9nZXRldmVudGxpc3RlbmVycy5kLnRzXCIgLz5cclxuXHJcbmltcG9ydCB7XHJcbiAgQWZ0ZXJWaWV3SW5pdCxcclxuICBDaGFuZ2VEZXRlY3RvclJlZixcclxuICBFbGVtZW50UmVmLFxyXG4gIElucHV0LFxyXG4gIE5nWm9uZSxcclxuICBPbkNoYW5nZXMsXHJcbiAgUmVuZGVyZXIyLFxyXG4gIFNpbXBsZUNoYW5nZXMsXHJcbiAgQWZ0ZXJDb250ZW50SW5pdCxcclxufSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IGNsYXNzbmFtZXMgZnJvbSAnY2xhc3NuYW1lcyc7XHJcbmltcG9ydCB0b1N0eWxlIGZyb20gJ2Nzcy10by1zdHlsZSc7XHJcbmltcG9ydCBzdHlsZW5hbWVzLCB7IFN0eWxlT2JqZWN0IH0gZnJvbSAnc3R5bGVuYW1lcyc7XHJcblxyXG5pbXBvcnQgeyBNYW55IH0gZnJvbSAnLi4vZGVjbGFyYXRpb25zL21hbnknO1xyXG5pbXBvcnQgeyBSZWFjdENvbnRlbnRQcm9wcyB9IGZyb20gJy4uL3JlbmRlcmVyL3JlYWN0LWNvbnRlbnQnO1xyXG5pbXBvcnQgeyBpc1JlYWN0Tm9kZSB9IGZyb20gJy4uL3JlbmRlcmVyL3JlYWN0LW5vZGUnO1xyXG5pbXBvcnQgeyBpc1JlYWN0UmVuZGVyZXJEYXRhIH0gZnJvbSAnLi4vcmVuZGVyZXIvcmVuZGVyZXInO1xyXG5pbXBvcnQgeyB0b09iamVjdCB9IGZyb20gJy4uL3V0aWxzL29iamVjdC90by1vYmplY3QnO1xyXG5pbXBvcnQgeyBhZnRlclJlbmRlckZpbmlzaGVkIH0gZnJvbSAnLi4vdXRpbHMvcmVuZGVyL3JlbmRlci1kZWxheSc7XHJcbmltcG9ydCB7IElucHV0UmVuZGVyZXJPcHRpb25zLCBKc3hSZW5kZXJGdW5jLCBjcmVhdGVJbnB1dEpzeFJlbmRlcmVyLCBjcmVhdGVSZW5kZXJQcm9wSGFuZGxlciB9IGZyb20gJy4vcmVuZGVyLXByb3BzJztcclxuXHJcbi8vIEZvcmJpZGRlbiBhdHRyaWJ1dGVzIGFyZSBzdGlsbCBpZ25vcmVkLCBzaW5jZSB0aGV5IG1heSBiZSBzZXQgZnJvbSB0aGUgd3JhcHBlciBjb21wb25lbnRzIHRoZW1zZWx2ZXMgKGZvcmJpZGRlbiBpcyBvbmx5IGFwcGxpZWQgZm9yIHVzZXJzIG9mIHRoZSB3cmFwcGVyIGNvbXBvbmVudHMpXHJcbmNvbnN0IGlnbm9yZWRBdHRyaWJ1dGVNYXRjaGVycyA9IFsvXl8/bmctPy4qLywgL15zdHlsZSQvLCAvXmNsYXNzJC9dO1xyXG5cclxuY29uc3QgbmdDbGFzc1JlZ0V4cCA9IC9ebmctLztcclxuXHJcbmV4cG9ydCB0eXBlIENvbnRlbnRDbGFzc1ZhbHVlID0gc3RyaW5nW10gfCBTZXQ8c3RyaW5nPiB8IHsgW2tsYXNzOiBzdHJpbmddOiBhbnkgfTtcclxuZXhwb3J0IHR5cGUgQ29udGVudFN0eWxlVmFsdWUgPSBzdHJpbmcgfCBTdHlsZU9iamVjdDtcclxuXHJcbi8qKlxyXG4gKiBPcHRpb25hbCBvcHRpb25zIHRvIHBhc3MgdG8gYFJlYWN0V3JhcHBlckNvbXBvbmVudGAuXHJcbiAqL1xyXG5leHBvcnQgaW50ZXJmYWNlIFdyYXBwZXJDb21wb25lbnRPcHRpb25zIHtcclxuICAvKipcclxuICAgKiBXaGV0aGVyIHRoZSBob3N0J3MgYGRpc3BsYXlgIHNob3VsZCBiZSBzZXQgdG8gdGhlIHJvb3QgY2hpbGQgbm9kZSdzYGRpc3BsYXlgLlxyXG4gICAqIEBkZWZhdWx0IGBmYWxzZWAuXHJcbiAgICovXHJcbiAgcmVhZG9ubHkgc2V0SG9zdERpc3BsYXk/OiBib29sZWFuO1xyXG5cclxuICAvKipcclxuICAgKiBUaGUgem9uZSB0byB1c2UgdG8gdHJhY2sgY2hhbmdlcyB0byBpbm5lciAoQW5ndWxhcikgdGVtcGxhdGVzICYgY29tcG9uZW50cy5cclxuICAgKiBAZGVmYXVsdCBgdW5kZWZpbmVkYC5cclxuICAgKi9cclxuICByZWFkb25seSBuZ1pvbmU/OiBOZ1pvbmU7XHJcbn1cclxuXHJcbmNvbnN0IGRlZmF1bHRXcmFwcGVyQ29tcG9uZW50T3B0aW9uczogV3JhcHBlckNvbXBvbmVudE9wdGlvbnMgPSB7XHJcbiAgc2V0SG9zdERpc3BsYXk6IGZhbHNlLFxyXG59O1xyXG5cclxuLyoqXHJcbiAqIEJhc2UgY2xhc3MgZm9yIEFuZ3VsYXIgQENvbXBvbmVudHMgd3JhcHBpbmcgUmVhY3QgQ29tcG9uZW50cy5cclxuICogU2ltcGxpZmllcyBzb21lIG9mIHRoZSBoYW5kbGluZyBhcm91bmQgcGFzc2luZyBkb3duIHByb3BzIGFuZCBDU1Mgc3R5bGluZyBvbiB0aGUgaG9zdCBjb21wb25lbnQuXHJcbiAqL1xyXG4vLyBOT1RFOiBUUHJvcHMgaXMgbm90IHVzZWQgYXQgdGhlIG1vbWVudCwgYnV0IGEgcHJlcGFyYXRpb24gZm9yIGEgcG90ZW50aWFsIGZ1dHVyZSBjaGFuZ2UuXHJcbmV4cG9ydCBhYnN0cmFjdCBjbGFzcyBSZWFjdFdyYXBwZXJDb21wb25lbnQ8VFByb3BzIGV4dGVuZHMge30+IGltcGxlbWVudHMgQWZ0ZXJDb250ZW50SW5pdCwgQWZ0ZXJWaWV3SW5pdCwgT25DaGFuZ2VzIHtcclxuICBwcml2YXRlIF9jb250ZW50Q2xhc3M6IE1hbnk8Q29udGVudENsYXNzVmFsdWU+O1xyXG4gIHByaXZhdGUgX2NvbnRlbnRTdHlsZTogQ29udGVudFN0eWxlVmFsdWU7XHJcblxyXG4gIHByaXZhdGUgX25nWm9uZTogTmdab25lO1xyXG4gIHByaXZhdGUgX3Nob3VsZFNldEhvc3REaXNwbGF5OiBib29sZWFuO1xyXG5cclxuICBwcm90ZWN0ZWQgYWJzdHJhY3QgcmVhY3ROb2RlUmVmOiBFbGVtZW50UmVmPEhUTUxFbGVtZW50PjtcclxuXHJcbiAgLyoqXHJcbiAgICogQWx0ZXJuYXRpdmUgdG8gYGNsYXNzYCBhbmQgYFtuZ0NsYXNzXWAgdXNpbmcgdGhlIHNhbWUgc3ludGF4LlxyXG4gICAqXHJcbiAgICogQGRlc2NyaXB0aW9uIFNpbmNlIHRoaXMgaXMgYSB3cmFwcGVyIGNvbXBvbmVudCwgc3RpY2tpbmcgdG8gdGhlIHZpcnR1YWwgRE9NIGNvbmNlcHQsIGl0cyBET00gZWxlbWVudCBzaG91bGRuJ3QgaGF2ZSBhbnkgc3R5bGluZyBvZiBpdHMgb3duLlxyXG4gICAqIEluc3RlYWQsIGFueSB2YWx1ZSBwYXNzZXMgdG8gYGNvbnRlbnRDbGFzc2Agd2lsbCBiZSBwYXNzZWQgdG8gdGhlIHJvb3QgY29tcG9uZW50J3MgY2xhc3MgYXMgYGNsYXNzTmFtZWAuXHJcbiAgICovXHJcbiAgQElucHV0KClcclxuICBzZXQgY29udGVudENsYXNzKHZhbHVlOiBNYW55PENvbnRlbnRDbGFzc1ZhbHVlPikge1xyXG4gICAgdGhpcy5fY29udGVudENsYXNzID0gdmFsdWU7XHJcbiAgICBpZiAoaXNSZWFjdE5vZGUodGhpcy5yZWFjdE5vZGVSZWYubmF0aXZlRWxlbWVudCkpIHtcclxuICAgICAgdGhpcy5yZWFjdE5vZGVSZWYubmF0aXZlRWxlbWVudC5zZXRQcm9wZXJ0eSgnY2xhc3NOYW1lJywgY2xhc3NuYW1lcyh2YWx1ZSkpO1xyXG4gICAgICB0aGlzLm1hcmtGb3JDaGVjaygpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgZ2V0IGNvbnRlbnRDbGFzcygpOiBNYW55PENvbnRlbnRDbGFzc1ZhbHVlPiB7XHJcbiAgICByZXR1cm4gdGhpcy5fY29udGVudENsYXNzO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogQWx0ZXJuYXRpdmUgdG8gYHN0eWxlYCBhbmQgYFtuZ1N0eWxlXWAgdXNpbmcgKGFsbW9zdCkgdGhlIHNhbWUgc3ludGF4LlxyXG4gICAqIEFsbCBzeW50YXggc3VwcG9ydHMgYnkgYG5nU3R5bGVgIGlzIHN1cHBvcnRlZCwgd2l0aCB0aGUgZXhjZXB0aW9uIG9mIHNwZWNpZnlpbmcgdW5pdHMgaW4gdGhlIGtleSAoYHsgJ3dpZHRoLnB4JzogMTIgfWApLlxyXG4gICAqXHJcbiAgICogQGRlc2NyaXB0aW9uIFNpbmNlIHRoaXMgaXMgYSB3cmFwcGVyIGNvbXBvbmVudCwgc3RpY2tpbmcgdG8gdGhlIHZpcnR1YWwgRE9NIGNvbmNlcHQsIHRoaXMgc2hvdWxkIGhhdmUgYW55IHN0eWxpbmcgb2YgaXRzIG93bi5cclxuICAgKiBBbnkgdmFsdWUgcGFzc2VzIHRvIGBjb250ZW50U3R5bGVgIHdpbGwgYmUgcGFzc2VkIHRvIHRoZSByb290IGNvbXBvbmVudCdzIHN0eWxlLlxyXG4gICAqL1xyXG4gIEBJbnB1dCgpXHJcbiAgc2V0IGNvbnRlbnRTdHlsZSh2YWx1ZTogQ29udGVudFN0eWxlVmFsdWUpIHtcclxuICAgIHRoaXMuX2NvbnRlbnRTdHlsZSA9IHZhbHVlO1xyXG4gICAgaWYgKGlzUmVhY3ROb2RlKHRoaXMucmVhY3ROb2RlUmVmLm5hdGl2ZUVsZW1lbnQpKSB7XHJcbiAgICAgIGNvbnN0IHN0cmluZ1ZhbHVlID0gdHlwZW9mIHZhbHVlID09PSAnc3RyaW5nJyA/IHZhbHVlIDogc3R5bGVuYW1lcyh2YWx1ZSk7XHJcbiAgICAgIHRoaXMucmVhY3ROb2RlUmVmLm5hdGl2ZUVsZW1lbnQuc2V0UHJvcGVydHkoJ3N0eWxlJywgdG9TdHlsZShzdHJpbmdWYWx1ZSkpO1xyXG4gICAgICB0aGlzLm1hcmtGb3JDaGVjaygpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgZ2V0IGNvbnRlbnRTdHlsZSgpOiBDb250ZW50U3R5bGVWYWx1ZSB7XHJcbiAgICByZXR1cm4gdGhpcy5fY29udGVudFN0eWxlO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogQ3JlYXRlcyBhbiBpbnN0YW5jZSBvZiBSZWFjdFdyYXBwZXJDb21wb25lbnQuXHJcbiAgICogQHBhcmFtIGVsZW1lbnRSZWYgVGhlIGhvc3QgZWxlbWVudC5cclxuICAgKiBAcGFyYW0gY2hhbmdlRGV0ZWN0b3JSZWYgVGhlIGNoYW5nZSBkZXRlY3RvciBmb3IgdGhlIGNvbXBvbmVudC5cclxuICAgKiBAcGFyYW0gcmVuZGVyZXIgVGhlIEFuZ3VsYXIgcmVuZGVyZXIuXHJcbiAgICovXHJcbiAgY29uc3RydWN0b3IoXHJcbiAgICBwdWJsaWMgcmVhZG9ubHkgZWxlbWVudFJlZjogRWxlbWVudFJlZjxIVE1MRWxlbWVudD4sXHJcbiAgICBwcml2YXRlIHJlYWRvbmx5IGNoYW5nZURldGVjdG9yUmVmOiBDaGFuZ2VEZXRlY3RvclJlZixcclxuICAgIHByaXZhdGUgcmVhZG9ubHkgcmVuZGVyZXI6IFJlbmRlcmVyMixcclxuICAgIHsgc2V0SG9zdERpc3BsYXksIG5nWm9uZSB9OiBXcmFwcGVyQ29tcG9uZW50T3B0aW9ucyA9IGRlZmF1bHRXcmFwcGVyQ29tcG9uZW50T3B0aW9uc1xyXG4gICkge1xyXG4gICAgdGhpcy5fbmdab25lID0gbmdab25lO1xyXG4gICAgdGhpcy5fc2hvdWxkU2V0SG9zdERpc3BsYXkgPSBzZXRIb3N0RGlzcGxheTtcclxuICB9XHJcblxyXG4gIG5nQWZ0ZXJDb250ZW50SW5pdCgpIHtcclxuICAgIHRoaXMuX3Bhc3NBdHRyaWJ1dGVzQXNQcm9wcygpO1xyXG4gIH1cclxuXHJcbiAgbmdBZnRlclZpZXdJbml0KCkge1xyXG4gICAgaWYgKHRoaXMuX3Nob3VsZFNldEhvc3REaXNwbGF5KSB7XHJcbiAgICAgIHRoaXMuX3NldEhvc3REaXNwbGF5KCk7XHJcbiAgICB9XHJcblxyXG4gICAgLy8gTk9URTogV29ya2Fyb3VuZC9maXggZm9yIElzc3VlICM1IChodHRwczovL2dpdGh1Yi5jb20vTWljcm9zb2Z0L2FuZ3VsYXItcmVhY3QvaXNzdWVzLzUpLlxyXG4gICAgLy8gVGhlIHdyYXBwZXIgY29tcG9uZW50IGlzbid0IGFkZGVkIHRvIHRoZSByb290IHJlYWN0IG5vZGVzIGxpc3Qgd2hlbiBpdCdzIGluc2lkZSBhIGBSZWFjdENvbnRlbnRgIG5vZGUsIHdlIG1hbnVhbGx5IGFkZCBpdCAobm90ZSB0aGF0IHRoZSByb290IG5vZGVzIGxpc3QgaXMgYSBgU2V0YCwgc28gaXQgd29uJ3QgZHVwbGljYXRlIG5vZGVzIGlmIGFscmVhZHkgZXhpc3QpLlxyXG4gICAgLy8gVGhlcmUncyBwb3RlbnRpYWxseSBhIGJldHRlciBzb2x1dGlvbiBpbnN0ZWFkIG9mIHRoaXNcclxuICAgIGNvbnN0IHJlbmRlcmVyRGF0YSA9IHRoaXMucmVuZGVyZXIuZGF0YTtcclxuICAgIGlmIChpc1JlYWN0UmVuZGVyZXJEYXRhKHJlbmRlcmVyRGF0YSkpIHtcclxuICAgICAgYWZ0ZXJSZW5kZXJGaW5pc2hlZCgoKSA9PiB7XHJcbiAgICAgICAgY29uc3QgbmF0aXZlRWxlbWVudCA9IHRoaXMucmVhY3ROb2RlUmVmLm5hdGl2ZUVsZW1lbnQ7XHJcbiAgICAgICAgaWYgKGlzUmVhY3ROb2RlKG5hdGl2ZUVsZW1lbnQpKSB7XHJcbiAgICAgICAgICByZW5kZXJlckRhdGEuYWRkUm9vdE5vZGUobmF0aXZlRWxlbWVudCk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9KTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIG5nT25DaGFuZ2VzKGNoYW5nZXM6IFNpbXBsZUNoYW5nZXMpIHtcclxuICAgIHRoaXMuX3Bhc3NBdHRyaWJ1dGVzQXNQcm9wcygpO1xyXG5cclxuICAgIHRoaXMubWFya0ZvckNoZWNrKCk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBNYXJrIHRoZSBjb21wb25lbnQgYXMgb25lIHRoYXQgbmVlZGVkIHJlLXJlbmRlcmluZyBvbiB0aGUgUmVhY3Qgc2lkZSxcclxuICAgKiBhbmQgbWFyayBmb3IgY2hhbmdlIGRldGVjdGlvbiBvbiB0aGUgQW5ndWxhciBzaWRlLlxyXG4gICAqL1xyXG4gIHByb3RlY3RlZCBtYXJrRm9yQ2hlY2soKSB7XHJcbiAgICBpZiAoaXNSZWFjdE5vZGUodGhpcy5yZWFjdE5vZGVSZWYubmF0aXZlRWxlbWVudCkpIHtcclxuICAgICAgdGhpcy5yZWFjdE5vZGVSZWYubmF0aXZlRWxlbWVudC5zZXRSZW5kZXJQZW5kaW5nKCk7XHJcbiAgICB9XHJcblxyXG4gICAgdGhpcy5jaGFuZ2VEZXRlY3RvclJlZi5tYXJrRm9yQ2hlY2soKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIENyZWF0ZSBhbiBKU1ggcmVuZGVyZXIgZm9yIGFuIGBASW5wdXRgIHByb3BlcnR5LlxyXG4gICAqIEBwYXJhbSBpbnB1dCBUaGUgaW5wdXQgcHJvcGVydHkuXHJcbiAgICogQHBhcmFtIGFkZGl0aW9uYWxQcm9wcyBvcHRpb25hbCBhZGRpdGlvbmFsIHByb3BzIHRvIHBhc3MgdG8gdGhlIGBSZWFjdENvbnRlbnRgIG9iamVjdCB0aGF0IHdpbGwgcmVuZGVyIHRoZSBjb250ZW50LlxyXG4gICAqL1xyXG4gIHByb3RlY3RlZCBjcmVhdGVJbnB1dEpzeFJlbmRlcmVyPFRDb250ZXh0IGV4dGVuZHMgb2JqZWN0PihcclxuICAgIGlucHV0OiBJbnB1dFJlbmRlcmVyT3B0aW9uczxUQ29udGV4dD4sXHJcbiAgICBhZGRpdGlvbmFsUHJvcHM/OiBSZWFjdENvbnRlbnRQcm9wc1xyXG4gICk6IEpzeFJlbmRlckZ1bmM8VENvbnRleHQ+IHwgdW5kZWZpbmVkIHtcclxuICAgIGlmIChpbnB1dCA9PT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgIHJldHVybiB1bmRlZmluZWQ7XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKCF0aGlzLl9uZ1pvbmUpIHtcclxuICAgICAgdGhyb3cgbmV3IEVycm9yKCdUbyBjcmVhdGUgYW4gaW5wdXQgSlNYIHJlbmRlcmVyIHlvdSBtdXN0IHBhc3MgYW4gTmdab25lIHRvIHRoZSBjb25zdHJ1Y3Rvci4nKTtcclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4gY3JlYXRlSW5wdXRKc3hSZW5kZXJlcihpbnB1dCwgdGhpcy5fbmdab25lLCBhZGRpdGlvbmFsUHJvcHMpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogQ3JlYXRlIGFuIGV2ZW50IGhhbmRsZXIgZm9yIGEgcmVuZGVyIHByb3BcclxuICAgKiBAcGFyYW0gcmVuZGVySW5wdXRWYWx1ZSB0aGUgdmFsdWUgb2YgdGhlIHJlbmRlciBgQElucHV0YCBwcm9wZXJ0eS5cclxuICAgKiBAcGFyYW0ganN4UmVuZGVyZXIgYW4gb3B0aW9uYWwgcmVuZGVyZXIgdG8gdXNlLlxyXG4gICAqIEBwYXJhbSBhZGRpdGlvbmFsUHJvcHMgb3B0aW9uYWwgYWRkaXRpb25hbCBwcm9wcyB0byBwYXNzIHRvIHRoZSBgUmVhY3RDb250ZW50YCBvYmplY3QgdGhhdCB3aWxsIHJlbmRlciB0aGUgY29udGVudC5cclxuICAgKi9cclxuICBwcm90ZWN0ZWQgY3JlYXRlUmVuZGVyUHJvcEhhbmRsZXI8VFJlbmRlclByb3BzIGV4dGVuZHMgb2JqZWN0PihcclxuICAgIHJlbmRlcklucHV0VmFsdWU6IElucHV0UmVuZGVyZXJPcHRpb25zPFRSZW5kZXJQcm9wcz4sXHJcbiAgICBvcHRpb25zPzoge1xyXG4gICAgICBqc3hSZW5kZXJlcj86IEpzeFJlbmRlckZ1bmM8VFJlbmRlclByb3BzPjtcclxuICAgICAgYWRkaXRpb25hbFByb3BzPzogUmVhY3RDb250ZW50UHJvcHM7XHJcbiAgICB9XHJcbiAgKTogKHByb3BzPzogVFJlbmRlclByb3BzLCBkZWZhdWx0UmVuZGVyPzogSnN4UmVuZGVyRnVuYzxUUmVuZGVyUHJvcHM+KSA9PiBKU1guRWxlbWVudCB8IG51bGwge1xyXG4gICAgcmV0dXJuIGNyZWF0ZVJlbmRlclByb3BIYW5kbGVyKHJlbmRlcklucHV0VmFsdWUsIHRoaXMuX25nWm9uZSwgb3B0aW9ucyk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIF9wYXNzQXR0cmlidXRlc0FzUHJvcHMoKSB7XHJcbiAgICBjb25zdCBob3N0QXR0cmlidXRlcyA9IEFycmF5LmZyb20oKHRoaXMuZWxlbWVudFJlZi5uYXRpdmVFbGVtZW50IGFzIEhUTUxFbGVtZW50KS5hdHRyaWJ1dGVzKTtcclxuXHJcbiAgICBpZiAoIXRoaXMucmVhY3ROb2RlUmVmIHx8ICFpc1JlYWN0Tm9kZSh0aGlzLnJlYWN0Tm9kZVJlZi5uYXRpdmVFbGVtZW50KSkge1xyXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ3JlYWN0Tm9kZVJlZiBtdXN0IGhvbGQgYSByZWZlcmVuY2UgdG8gYSBSZWFjdE5vZGUnKTtcclxuICAgIH1cclxuXHJcbiAgICAvLyBFbnN1cmUgdGhlcmUgYXJlIG5vIGJsYWNrbGlzdGVkIHByb3BzLiBTdWdnZXN0IGFsdGVybmF0aXZlIGFzIGVycm9yIGlmIHRoZXJlIGlzIGFueVxyXG4gICAgaG9zdEF0dHJpYnV0ZXMuZm9yRWFjaChhdHRyID0+IHtcclxuICAgICAgY29uc3QgW2ZvcmJpZGRlbiwgYWx0ZXJuYXRpdmVBdHRyTmFtZV0gPSB0aGlzLl9pc0ZvcmJpZGRlbkF0dHJpYnV0ZShhdHRyKTtcclxuICAgICAgaWYgKGZvcmJpZGRlbikge1xyXG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcclxuICAgICAgICAgIGBbJHsodGhpcy5lbGVtZW50UmVmXHJcbiAgICAgICAgICAgIC5uYXRpdmVFbGVtZW50IGFzIEhUTUxFbGVtZW50KS50YWdOYW1lLnRvTG93ZXJDYXNlKCl9XSBSZWFjdCB3cmFwcGVyIGNvbXBvbmVudHMgY2Fubm90IGhhdmUgdGhlICcke1xyXG4gICAgICAgICAgICBhdHRyLm5hbWVcclxuICAgICAgICAgIH0nIGF0dHJpYnV0ZSBzZXQuIFVzZSB0aGUgZm9sbG93aW5nIGFsdGVybmF0aXZlOiAke2FsdGVybmF0aXZlQXR0ck5hbWUgfHwgJyd9YFxyXG4gICAgICAgICk7XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG5cclxuICAgIGNvbnN0IHdoaXRlbGlzdGVkSG9zdEF0dHJpYnV0ZXMgPSBob3N0QXR0cmlidXRlcy5maWx0ZXIoYXR0ciA9PiAhdGhpcy5faXNJZ25vcmVkQXR0cmlidXRlKGF0dHIpKTtcclxuICAgIGNvbnN0IHByb3BzID0gd2hpdGVsaXN0ZWRIb3N0QXR0cmlidXRlcy5yZWR1Y2UoXHJcbiAgICAgIChhY2MsIGF0dHIpID0+ICh7XHJcbiAgICAgICAgLi4uYWNjLFxyXG4gICAgICAgIFthdHRyLm5hbWVdOiBhdHRyLnZhbHVlLFxyXG4gICAgICB9KSxcclxuICAgICAge31cclxuICAgICk7XHJcblxyXG4gICAgY29uc3QgZXZlbnRMaXN0ZW5lcnMgPSB0aGlzLmVsZW1lbnRSZWYubmF0aXZlRWxlbWVudC5nZXRFdmVudExpc3RlbmVycygpO1xyXG4gICAgY29uc3QgZXZlbnRIYW5kbGVyc1Byb3BzID1cclxuICAgICAgZXZlbnRMaXN0ZW5lcnMgJiYgT2JqZWN0LmtleXMoZXZlbnRMaXN0ZW5lcnMpLmxlbmd0aFxyXG4gICAgICAgID8gdG9PYmplY3QoXHJcbiAgICAgICAgICAgIE9iamVjdC52YWx1ZXMoZXZlbnRMaXN0ZW5lcnMpLm1hcDxbc3RyaW5nLCBSZWFjdC5FdmVudEhhbmRsZXI8UmVhY3QuU3ludGhldGljRXZlbnQ+XT4oKFtldmVudExpc3RlbmVyXSkgPT4gW1xyXG4gICAgICAgICAgICAgIGV2ZW50TGlzdGVuZXIudHlwZSxcclxuICAgICAgICAgICAgICAoZXY6IFJlYWN0LlN5bnRoZXRpY0V2ZW50KSA9PiBldmVudExpc3RlbmVyLmxpc3RlbmVyKGV2ICYmIGV2Lm5hdGl2ZUV2ZW50KSxcclxuICAgICAgICAgICAgXSlcclxuICAgICAgICAgIClcclxuICAgICAgICA6IHt9O1xyXG4gICAge1xyXG4gICAgfVxyXG5cclxuICAgIHRoaXMucmVhY3ROb2RlUmVmLm5hdGl2ZUVsZW1lbnQuc2V0UHJvcGVydGllcyh7IC4uLnByb3BzLCAuLi5ldmVudEhhbmRsZXJzUHJvcHMgfSk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIF9zZXRIb3N0RGlzcGxheSgpIHtcclxuICAgIGNvbnN0IG5hdGl2ZUVsZW1lbnQgPSB0aGlzLmVsZW1lbnRSZWYubmF0aXZlRWxlbWVudDtcclxuXHJcbiAgICAvLyBXZSB3YW50IHRvIHdhaXQgdW50aWwgY2hpbGQgZWxlbWVudHMgYXJlIHJlbmRlcmVkXHJcbiAgICByZXF1ZXN0QW5pbWF0aW9uRnJhbWUoKCkgPT4ge1xyXG4gICAgICBpZiAobmF0aXZlRWxlbWVudC5maXJzdEVsZW1lbnRDaGlsZCkge1xyXG4gICAgICAgIGNvbnN0IHJvb3RDaGlsZERpc3BsYXkgPSBnZXRDb21wdXRlZFN0eWxlKG5hdGl2ZUVsZW1lbnQuZmlyc3RFbGVtZW50Q2hpbGQpLmRpc3BsYXk7XHJcbiAgICAgICAgbmF0aXZlRWxlbWVudC5zdHlsZS5kaXNwbGF5ID0gcm9vdENoaWxkRGlzcGxheTtcclxuICAgICAgfVxyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIF9pc0lnbm9yZWRBdHRyaWJ1dGUoYXR0cjogQXR0cikge1xyXG4gICAgcmV0dXJuIGlnbm9yZWRBdHRyaWJ1dGVNYXRjaGVycy5zb21lKHJlZ0V4cCA9PiByZWdFeHAudGVzdChhdHRyLm5hbWUpKTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgX2lzRm9yYmlkZGVuQXR0cmlidXRlKGF0dHI6IEF0dHIpOiBbYm9vbGVhbiwgc3RyaW5nIHwgdW5kZWZpbmVkXSB7XHJcbiAgICBjb25zdCB7IG5hbWUsIHZhbHVlIH0gPSBhdHRyO1xyXG5cclxuICAgIGlmIChuYW1lID09PSAna2V5JykgcmV0dXJuIFt0cnVlLCB1bmRlZmluZWRdO1xyXG4gICAgaWYgKG5hbWUgPT09ICdjbGFzcycgJiYgdmFsdWUuc3BsaXQoJyAnKS5zb21lKGNsYXNzTmFtZSA9PiAhbmdDbGFzc1JlZ0V4cC50ZXN0KGNsYXNzTmFtZSkpKVxyXG4gICAgICByZXR1cm4gW3RydWUsICdjb250ZW50Q2xhc3MnXTtcclxuICAgIGlmIChuYW1lID09PSAnc3R5bGUnKSB7XHJcbiAgICAgIGNvbnN0IHN0eWxlID0gdG9TdHlsZSh2YWx1ZSk7XHJcbiAgICAgIC8vIE9ubHkgYWxsb3dpbmcgc3R5bGUgaWYgaXQncyBzb21ldGhpbmcgdGhhdCBjaGFuZ2VzIHRoZSBkaXNwbGF5IC0gc2V0dGluZyBhbnl0aGluZyBlbHNlIHNob3VsZCBiZSBkb25lIG9uIHRoZSBjaGlsZCBjb21wb25lbnQgZGlyZWN0bHkgKHZpYSB0aGUgYHN0eWxlc2AgYXR0cmlidXRlIGluIGZhYnJpYyBmb3IgZXhhbXBsZSlcclxuICAgICAgaWYgKE9iamVjdC5lbnRyaWVzKHN0eWxlKS5maWx0ZXIoKFtrZXksIHZhbHVlXSkgPT4gdmFsdWUgJiYga2V5ICE9PSAnZGlzcGxheScpLmxlbmd0aCA+IDApIHtcclxuICAgICAgICByZXR1cm4gW3RydWUsICdjb250ZW50U3R5bGUnXTtcclxuICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHJldHVybiBbZmFsc2UsIHVuZGVmaW5lZF07XHJcbiAgfVxyXG59XHJcbiJdfQ==