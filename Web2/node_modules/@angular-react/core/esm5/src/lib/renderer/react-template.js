// Copyright (c) Microsoft Corporation. All rights reserved.
// Licensed under the MIT License.
import * as tslib_1 from "tslib";
import * as React from 'react';
import * as ReactDOM from 'react-dom';
import { throttleTime } from 'rxjs/operators';
var DEBUG = false;
var TEMPLATE_DETECT_CHANGES_THROTTLE_MS = 250;
/**
 * Creates a new `ReactTemplate` element.
 * @param templateRef The template to render.
 * @param context The context to inject the template.
 * @param ngZone A zone used for tracking changes in the template.
 * @param additionalProps _Optional_. @see `ReactTemplateProps`.
 */
export function createReactTemplateElement(templateRef, context, ngZone, additionalProps) {
    return React.createElement(ReactTemplate, tslib_1.__assign({ ngZone: ngZone, templateRef: templateRef, context: context }, additionalProps));
}
/**
 * Render an `ng-template` as a child of a React component.
 * Supports two rendering modes:
 *  1. `legacy` - append `<react-content>` as the root, and nest the `children-to-append` underneath it.
 *  2. `new` (**default**) - append the `children-to-append` to the parent of this component, and hide the `<react-content>` element.
 *     (similar to how `router-outlet` behaves in Angular).
 */
var ReactTemplate = /** @class */ (function (_super) {
    tslib_1.__extends(ReactTemplate, _super);
    function ReactTemplate() {
        return _super !== null && _super.apply(this, arguments) || this;
    }
    ReactTemplate.prototype.componentDidUpdate = function () {
        // Context has changes, trigger change detection after pushing the new context in
        if (this.props.context != null && this._embeddedViewRef.context != null) {
            Object.assign(this._embeddedViewRef.context, this.props.context);
        }
        this._embeddedViewRef.detectChanges();
    };
    ReactTemplate.prototype.componentDidMount = function () {
        var _this = this;
        var _a = this.props, context = _a.context, ngZone = _a.ngZone, templateRef = _a.templateRef;
        this._embeddedViewRef = templateRef.createEmbeddedView(context);
        var element = ReactDOM.findDOMNode(this);
        if (DEBUG) {
            console.warn('ReactTemplate Component > componentDidMount > childrenToAppend:', {
                rootNodes: this._embeddedViewRef.rootNodes,
            });
        }
        var hostElement = this.props.legacyRenderMode ? element : element.parentElement;
        this._embeddedViewRef.rootNodes.forEach(function (child) { return hostElement.appendChild(child); });
        // Detect the first cycle's changes, and then subscribe for subsequent ones.
        this._embeddedViewRef.detectChanges();
        // Throttling the detect changes to an empirically selected value so we don't overload too much work.
        // TODO: This needs some better solution to listen to changes to the binding sources of the template.
        this._ngZoneSubscription = ngZone.onStable
            .pipe(throttleTime(TEMPLATE_DETECT_CHANGES_THROTTLE_MS, undefined, { leading: true, trailing: true }))
            .subscribe(function () {
            _this._embeddedViewRef.detectChanges();
        });
    };
    ReactTemplate.prototype.componentWillUnmount = function () {
        this._ngZoneSubscription.unsubscribe();
        if (this._embeddedViewRef) {
            this._embeddedViewRef.destroy();
        }
    };
    ReactTemplate.prototype.render = function () {
        // TODO: See if we can just render React.Fragment and the children within it, having no extra DOM nodes.
        return React.createElement('react-template', !this.props.legacyRenderMode && { style: { display: 'none' } });
    };
    return ReactTemplate;
}(React.Component));
export { ReactTemplate };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVhY3QtdGVtcGxhdGUuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AYW5ndWxhci1yZWFjdC9jb3JlLyIsInNvdXJjZXMiOlsic3JjL2xpYi9yZW5kZXJlci9yZWFjdC10ZW1wbGF0ZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSw0REFBNEQ7QUFDNUQsa0NBQWtDOztBQUdsQyxPQUFPLEtBQUssS0FBSyxNQUFNLE9BQU8sQ0FBQztBQUMvQixPQUFPLEtBQUssUUFBUSxNQUFNLFdBQVcsQ0FBQztBQUV0QyxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFFOUMsSUFBTSxLQUFLLEdBQUcsS0FBSyxDQUFDO0FBQ3BCLElBQU0sbUNBQW1DLEdBQUcsR0FBRyxDQUFDO0FBZ0JoRDs7Ozs7O0dBTUc7QUFDSCxNQUFNLFVBQVUsMEJBQTBCLENBQ3hDLFdBQWtDLEVBQ2xDLE9BQWlCLEVBQ2pCLE1BQWMsRUFDZCxlQUFvQztJQUVwQyxPQUFPLEtBQUssQ0FBQyxhQUFhLENBQUMsYUFBYSxxQkFBSSxNQUFNLFFBQUEsRUFBRSxXQUFXLGFBQUEsRUFBRSxPQUFPLFNBQUEsSUFBSyxlQUFlLEVBQUcsQ0FBQztBQUNsRyxDQUFDO0FBV0Q7Ozs7OztHQU1HO0FBQ0g7SUFBbUUseUNBRWxFO0lBRkQ7O0lBcURBLENBQUM7SUEvQ0MsMENBQWtCLEdBQWxCO1FBQ0UsaUZBQWlGO1FBQ2pGLElBQUksSUFBSSxDQUFDLEtBQUssQ0FBQyxPQUFPLElBQUksSUFBSSxJQUFJLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxPQUFPLElBQUksSUFBSSxFQUFFO1lBQ3ZFLE1BQU0sQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLGdCQUFnQixDQUFDLE9BQU8sRUFBRSxJQUFJLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxDQUFDO1NBQ2xFO1FBQ0QsSUFBSSxDQUFDLGdCQUFnQixDQUFDLGFBQWEsRUFBRSxDQUFDO0lBQ3hDLENBQUM7SUFFRCx5Q0FBaUIsR0FBakI7UUFBQSxpQkF5QkM7UUF4Qk8sSUFBQSxlQUE2QyxFQUEzQyxvQkFBTyxFQUFFLGtCQUFNLEVBQUUsNEJBQTBCLENBQUM7UUFFcEQsSUFBSSxDQUFDLGdCQUFnQixHQUFHLFdBQVcsQ0FBQyxrQkFBa0IsQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUNoRSxJQUFNLE9BQU8sR0FBRyxRQUFRLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQzNDLElBQUksS0FBSyxFQUFFO1lBQ1QsT0FBTyxDQUFDLElBQUksQ0FBQyxpRUFBaUUsRUFBRTtnQkFDOUUsU0FBUyxFQUFFLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxTQUFTO2FBQzNDLENBQUMsQ0FBQztTQUNKO1FBRUQsSUFBTSxXQUFXLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsYUFBYSxDQUFDO1FBRWxGLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxTQUFTLENBQUMsT0FBTyxDQUFDLFVBQUEsS0FBSyxJQUFJLE9BQUEsV0FBVyxDQUFDLFdBQVcsQ0FBQyxLQUFLLENBQUMsRUFBOUIsQ0FBOEIsQ0FBQyxDQUFDO1FBRWpGLDRFQUE0RTtRQUM1RSxJQUFJLENBQUMsZ0JBQWdCLENBQUMsYUFBYSxFQUFFLENBQUM7UUFFdEMscUdBQXFHO1FBQ3JHLHFHQUFxRztRQUNyRyxJQUFJLENBQUMsbUJBQW1CLEdBQUcsTUFBTSxDQUFDLFFBQVE7YUFDdkMsSUFBSSxDQUFDLFlBQVksQ0FBQyxtQ0FBbUMsRUFBRSxTQUFTLEVBQUUsRUFBRSxPQUFPLEVBQUUsSUFBSSxFQUFFLFFBQVEsRUFBRSxJQUFJLEVBQUUsQ0FBQyxDQUFDO2FBQ3JHLFNBQVMsQ0FBQztZQUNULEtBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxhQUFhLEVBQUUsQ0FBQztRQUN4QyxDQUFDLENBQUMsQ0FBQztJQUNQLENBQUM7SUFFRCw0Q0FBb0IsR0FBcEI7UUFDRSxJQUFJLENBQUMsbUJBQW1CLENBQUMsV0FBVyxFQUFFLENBQUM7UUFFdkMsSUFBSSxJQUFJLENBQUMsZ0JBQWdCLEVBQUU7WUFDekIsSUFBSSxDQUFDLGdCQUFnQixDQUFDLE9BQU8sRUFBRSxDQUFDO1NBQ2pDO0lBQ0gsQ0FBQztJQUVELDhCQUFNLEdBQU47UUFDRSx3R0FBd0c7UUFDeEcsT0FBTyxLQUFLLENBQUMsYUFBYSxDQUFDLGdCQUFnQixFQUFFLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxnQkFBZ0IsSUFBSSxFQUFFLEtBQUssRUFBRSxFQUFFLE9BQU8sRUFBRSxNQUFNLEVBQUUsRUFBRSxDQUFDLENBQUM7SUFDL0csQ0FBQztJQUNILG9CQUFDO0FBQUQsQ0FBQyxBQXJERCxDQUFtRSxLQUFLLENBQUMsU0FBUyxHQXFEakYiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBDb3B5cmlnaHQgKGMpIE1pY3Jvc29mdCBDb3Jwb3JhdGlvbi4gQWxsIHJpZ2h0cyByZXNlcnZlZC5cclxuLy8gTGljZW5zZWQgdW5kZXIgdGhlIE1JVCBMaWNlbnNlLlxyXG5cclxuaW1wb3J0IHsgRW1iZWRkZWRWaWV3UmVmLCBOZ1pvbmUsIFRlbXBsYXRlUmVmIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCAqIGFzIFJlYWN0IGZyb20gJ3JlYWN0JztcclxuaW1wb3J0ICogYXMgUmVhY3RET00gZnJvbSAncmVhY3QtZG9tJztcclxuaW1wb3J0IHsgU3Vic2NyaXB0aW9uIH0gZnJvbSAncnhqcyc7XHJcbmltcG9ydCB7IHRocm90dGxlVGltZSB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcclxuXHJcbmNvbnN0IERFQlVHID0gZmFsc2U7XHJcbmNvbnN0IFRFTVBMQVRFX0RFVEVDVF9DSEFOR0VTX1RIUk9UVExFX01TID0gMjUwO1xyXG5cclxuLyoqXHJcbiAqIEBpbnRlcm5hbFxyXG4gKi9cclxuZXhwb3J0IGludGVyZmFjZSBSZWFjdFRlbXBsYXRlUHJvcHMge1xyXG4gIC8qKlxyXG4gICAqIFVzZSB0aGUgbGVnYWN5IHJlbmRlcmluZyBtb2RlLlxyXG4gICAqXHJcbiAgICogVXNlcyBhIHNpbWlsYXIgYXBwcm9hY2ggdG8gYHJvdXRlci1vdXRsZXRgLCB3aGVyZSB0aGUgY2hpbGQgZWxlbWVudHMgYXJlIGFkZGVkIHRvIHRoZSBwYXJlbnQsIGluc3RlYWQgb2YgdGhpcyBub2RlLCBhbmQgdGhpcyBpcyBoaWRkZW4uXHJcbiAgICpcclxuICAgKiBAZGVmYXVsdCBmYWxzZVxyXG4gICAqL1xyXG4gIGxlZ2FjeVJlbmRlck1vZGU/OiBib29sZWFuO1xyXG59XHJcblxyXG4vKipcclxuICogQ3JlYXRlcyBhIG5ldyBgUmVhY3RUZW1wbGF0ZWAgZWxlbWVudC5cclxuICogQHBhcmFtIHRlbXBsYXRlUmVmIFRoZSB0ZW1wbGF0ZSB0byByZW5kZXIuXHJcbiAqIEBwYXJhbSBjb250ZXh0IFRoZSBjb250ZXh0IHRvIGluamVjdCB0aGUgdGVtcGxhdGUuXHJcbiAqIEBwYXJhbSBuZ1pvbmUgQSB6b25lIHVzZWQgZm9yIHRyYWNraW5nIGNoYW5nZXMgaW4gdGhlIHRlbXBsYXRlLlxyXG4gKiBAcGFyYW0gYWRkaXRpb25hbFByb3BzIF9PcHRpb25hbF8uIEBzZWUgYFJlYWN0VGVtcGxhdGVQcm9wc2AuXHJcbiAqL1xyXG5leHBvcnQgZnVuY3Rpb24gY3JlYXRlUmVhY3RUZW1wbGF0ZUVsZW1lbnQ8VENvbnRleHQgZXh0ZW5kcyBvYmplY3QgfCB2b2lkPihcclxuICB0ZW1wbGF0ZVJlZjogVGVtcGxhdGVSZWY8VENvbnRleHQ+LFxyXG4gIGNvbnRleHQ6IFRDb250ZXh0LFxyXG4gIG5nWm9uZTogTmdab25lLFxyXG4gIGFkZGl0aW9uYWxQcm9wcz86IFJlYWN0VGVtcGxhdGVQcm9wc1xyXG4pIHtcclxuICByZXR1cm4gUmVhY3QuY3JlYXRlRWxlbWVudChSZWFjdFRlbXBsYXRlLCB7IG5nWm9uZSwgdGVtcGxhdGVSZWYsIGNvbnRleHQsIC4uLmFkZGl0aW9uYWxQcm9wcyB9KTtcclxufVxyXG5cclxuLyoqXHJcbiAqIEBpbnRlcm5hbFxyXG4gKi9cclxuaW50ZXJmYWNlIEludGVybmFsUmVhY3RUZW1wbGF0ZVByb3BzPFRDb250ZXh0IGV4dGVuZHMgb2JqZWN0IHwgdm9pZD4gZXh0ZW5kcyBSZWFjdFRlbXBsYXRlUHJvcHMge1xyXG4gIG5nWm9uZTogTmdab25lO1xyXG4gIHRlbXBsYXRlUmVmOiBUZW1wbGF0ZVJlZjxUQ29udGV4dD47XHJcbiAgY29udGV4dDogVENvbnRleHQ7XHJcbn1cclxuXHJcbi8qKlxyXG4gKiBSZW5kZXIgYW4gYG5nLXRlbXBsYXRlYCBhcyBhIGNoaWxkIG9mIGEgUmVhY3QgY29tcG9uZW50LlxyXG4gKiBTdXBwb3J0cyB0d28gcmVuZGVyaW5nIG1vZGVzOlxyXG4gKiAgMS4gYGxlZ2FjeWAgLSBhcHBlbmQgYDxyZWFjdC1jb250ZW50PmAgYXMgdGhlIHJvb3QsIGFuZCBuZXN0IHRoZSBgY2hpbGRyZW4tdG8tYXBwZW5kYCB1bmRlcm5lYXRoIGl0LlxyXG4gKiAgMi4gYG5ld2AgKCoqZGVmYXVsdCoqKSAtIGFwcGVuZCB0aGUgYGNoaWxkcmVuLXRvLWFwcGVuZGAgdG8gdGhlIHBhcmVudCBvZiB0aGlzIGNvbXBvbmVudCwgYW5kIGhpZGUgdGhlIGA8cmVhY3QtY29udGVudD5gIGVsZW1lbnQuXHJcbiAqICAgICAoc2ltaWxhciB0byBob3cgYHJvdXRlci1vdXRsZXRgIGJlaGF2ZXMgaW4gQW5ndWxhcikuXHJcbiAqL1xyXG5leHBvcnQgY2xhc3MgUmVhY3RUZW1wbGF0ZTxUQ29udGV4dCBleHRlbmRzIG9iamVjdCB8IHZvaWQ+IGV4dGVuZHMgUmVhY3QuQ29tcG9uZW50PFxyXG4gIEludGVybmFsUmVhY3RUZW1wbGF0ZVByb3BzPFRDb250ZXh0PlxyXG4+IHtcclxuICBwcml2YXRlIF9lbWJlZGRlZFZpZXdSZWY6IEVtYmVkZGVkVmlld1JlZjxUQ29udGV4dD47XHJcbiAgcHJpdmF0ZSBfbmdab25lU3Vic2NyaXB0aW9uOiBTdWJzY3JpcHRpb247XHJcblxyXG4gIGNvbXBvbmVudERpZFVwZGF0ZSgpIHtcclxuICAgIC8vIENvbnRleHQgaGFzIGNoYW5nZXMsIHRyaWdnZXIgY2hhbmdlIGRldGVjdGlvbiBhZnRlciBwdXNoaW5nIHRoZSBuZXcgY29udGV4dCBpblxyXG4gICAgaWYgKHRoaXMucHJvcHMuY29udGV4dCAhPSBudWxsICYmIHRoaXMuX2VtYmVkZGVkVmlld1JlZi5jb250ZXh0ICE9IG51bGwpIHtcclxuICAgICAgT2JqZWN0LmFzc2lnbih0aGlzLl9lbWJlZGRlZFZpZXdSZWYuY29udGV4dCwgdGhpcy5wcm9wcy5jb250ZXh0KTtcclxuICAgIH1cclxuICAgIHRoaXMuX2VtYmVkZGVkVmlld1JlZi5kZXRlY3RDaGFuZ2VzKCk7XHJcbiAgfVxyXG5cclxuICBjb21wb25lbnREaWRNb3VudCgpIHtcclxuICAgIGNvbnN0IHsgY29udGV4dCwgbmdab25lLCB0ZW1wbGF0ZVJlZiB9ID0gdGhpcy5wcm9wcztcclxuXHJcbiAgICB0aGlzLl9lbWJlZGRlZFZpZXdSZWYgPSB0ZW1wbGF0ZVJlZi5jcmVhdGVFbWJlZGRlZFZpZXcoY29udGV4dCk7XHJcbiAgICBjb25zdCBlbGVtZW50ID0gUmVhY3RET00uZmluZERPTU5vZGUodGhpcyk7XHJcbiAgICBpZiAoREVCVUcpIHtcclxuICAgICAgY29uc29sZS53YXJuKCdSZWFjdFRlbXBsYXRlIENvbXBvbmVudCA+IGNvbXBvbmVudERpZE1vdW50ID4gY2hpbGRyZW5Ub0FwcGVuZDonLCB7XHJcbiAgICAgICAgcm9vdE5vZGVzOiB0aGlzLl9lbWJlZGRlZFZpZXdSZWYucm9vdE5vZGVzLFxyXG4gICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICBjb25zdCBob3N0RWxlbWVudCA9IHRoaXMucHJvcHMubGVnYWN5UmVuZGVyTW9kZSA/IGVsZW1lbnQgOiBlbGVtZW50LnBhcmVudEVsZW1lbnQ7XHJcblxyXG4gICAgdGhpcy5fZW1iZWRkZWRWaWV3UmVmLnJvb3ROb2Rlcy5mb3JFYWNoKGNoaWxkID0+IGhvc3RFbGVtZW50LmFwcGVuZENoaWxkKGNoaWxkKSk7XHJcblxyXG4gICAgLy8gRGV0ZWN0IHRoZSBmaXJzdCBjeWNsZSdzIGNoYW5nZXMsIGFuZCB0aGVuIHN1YnNjcmliZSBmb3Igc3Vic2VxdWVudCBvbmVzLlxyXG4gICAgdGhpcy5fZW1iZWRkZWRWaWV3UmVmLmRldGVjdENoYW5nZXMoKTtcclxuXHJcbiAgICAvLyBUaHJvdHRsaW5nIHRoZSBkZXRlY3QgY2hhbmdlcyB0byBhbiBlbXBpcmljYWxseSBzZWxlY3RlZCB2YWx1ZSBzbyB3ZSBkb24ndCBvdmVybG9hZCB0b28gbXVjaCB3b3JrLlxyXG4gICAgLy8gVE9ETzogVGhpcyBuZWVkcyBzb21lIGJldHRlciBzb2x1dGlvbiB0byBsaXN0ZW4gdG8gY2hhbmdlcyB0byB0aGUgYmluZGluZyBzb3VyY2VzIG9mIHRoZSB0ZW1wbGF0ZS5cclxuICAgIHRoaXMuX25nWm9uZVN1YnNjcmlwdGlvbiA9IG5nWm9uZS5vblN0YWJsZVxyXG4gICAgICAucGlwZSh0aHJvdHRsZVRpbWUoVEVNUExBVEVfREVURUNUX0NIQU5HRVNfVEhST1RUTEVfTVMsIHVuZGVmaW5lZCwgeyBsZWFkaW5nOiB0cnVlLCB0cmFpbGluZzogdHJ1ZSB9KSlcclxuICAgICAgLnN1YnNjcmliZSgoKSA9PiB7XHJcbiAgICAgICAgdGhpcy5fZW1iZWRkZWRWaWV3UmVmLmRldGVjdENoYW5nZXMoKTtcclxuICAgICAgfSk7XHJcbiAgfVxyXG5cclxuICBjb21wb25lbnRXaWxsVW5tb3VudCgpIHtcclxuICAgIHRoaXMuX25nWm9uZVN1YnNjcmlwdGlvbi51bnN1YnNjcmliZSgpO1xyXG5cclxuICAgIGlmICh0aGlzLl9lbWJlZGRlZFZpZXdSZWYpIHtcclxuICAgICAgdGhpcy5fZW1iZWRkZWRWaWV3UmVmLmRlc3Ryb3koKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHJlbmRlcigpIHtcclxuICAgIC8vIFRPRE86IFNlZSBpZiB3ZSBjYW4ganVzdCByZW5kZXIgUmVhY3QuRnJhZ21lbnQgYW5kIHRoZSBjaGlsZHJlbiB3aXRoaW4gaXQsIGhhdmluZyBubyBleHRyYSBET00gbm9kZXMuXHJcbiAgICByZXR1cm4gUmVhY3QuY3JlYXRlRWxlbWVudCgncmVhY3QtdGVtcGxhdGUnLCAhdGhpcy5wcm9wcy5sZWdhY3lSZW5kZXJNb2RlICYmIHsgc3R5bGU6IHsgZGlzcGxheTogJ25vbmUnIH0gfSk7XHJcbiAgfVxyXG59XHJcbiJdfQ==