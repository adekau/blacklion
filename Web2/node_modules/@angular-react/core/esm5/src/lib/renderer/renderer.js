// Copyright (c) Microsoft Corporation. All rights reserved.
// Licensed under the MIT License.
import * as tslib_1 from "tslib";
import { Injectable, RendererStyleFlags2 } from '@angular/core';
import { EventManager, ɵDomRendererFactory2, ɵDomSharedStylesHost } from '@angular/platform-browser';
import { Disguise } from './components/Disguise';
import { ReactContent } from './react-content';
import { isReactNode, ReactNode } from './react-node';
import { registerElement } from './registry';
import './geteventlisteners';
var DEBUG = false;
var AngularReactRendererFactory = /** @class */ (function (_super) {
    tslib_1.__extends(AngularReactRendererFactory, _super);
    function AngularReactRendererFactory(eventManager, sharedStylesHost) {
        var _this = _super.call(this, eventManager, sharedStylesHost, 'app-id') || this;
        // Collection of ReactNodes that can be evaluated and flushed at the
        // end of Render.  This is necessary as the flow of element creation
        // and update goes from "create" > "insert" > "update" property/attribute.
        // React elements cannot be "inserted" and later have their props
        // updated, so the "insert", or React.Render, can only be done once the
        // element has been fully defined.  Only the topmost [root] nodes are added here.
        _this.reactRootNodes = new Set();
        // This flag can only be set to true from outside.  It can only be reset
        // to false from inside.  This value is reset on "end" when the pending
        // renders are flushed.
        _this.setRenderPendingCallback = function () {
            _this.isRenderPending = true;
        };
        // tslint:disable-next-line: no-use-before-declare
        _this.defaultReactRenderer = new ReactRenderer(_this);
        return _this;
    }
    AngularReactRendererFactory.prototype.createRenderer = function (element, type) {
        if (type && type.styles.length && type.styles[0] === 'react-renderer') {
            return this.defaultReactRenderer;
        }
        return _super.prototype.createRenderer.call(this, element, type);
    };
    AngularReactRendererFactory.prototype.begin = function () { };
    AngularReactRendererFactory.prototype.end = function () {
        if (DEBUG) {
            console.log('RootRenderer > end > isRenderPending:', this.isRenderPending, 'reactRootNodes:', this.reactRootNodes);
        }
        // Flush any pending React element render updates.  This cannot be done
        // earlier (as is done for DOM elements) because React element props
        // are ReadOnly.
        if (this.isRenderPending) {
            // Remove root nodes that are pending destroy after render.
            this.reactRootNodes = new Set(Array.from(this.reactRootNodes).filter(function (node) { return !node.render().destroyPending; }));
            this.isRenderPending = false;
        }
    };
    AngularReactRendererFactory = tslib_1.__decorate([
        Injectable(),
        tslib_1.__metadata("design:paramtypes", [EventManager, ɵDomSharedStylesHost])
    ], AngularReactRendererFactory);
    return AngularReactRendererFactory;
}(ɵDomRendererFactory2));
export { AngularReactRendererFactory };
export var isReactRendererData = function (data) {
    return data && typeof data.addRootNode === 'function';
};
var ReactRenderer = /** @class */ (function () {
    function ReactRenderer(rootRenderer) {
        var _this = this;
        this.rootRenderer = rootRenderer;
        this.data = {
            addRootNode: function (node) {
                _this.rootRenderer.reactRootNodes.add(node);
            },
        };
        // These two elements are essential for the whole experience to be smooth for the user - register them from the get-go.
        registerElement('ReactContent', function () { return ReactContent; });
        registerElement('Disguise', function () { return Disguise; });
    }
    ReactRenderer.prototype.destroy = function () { };
    ReactRenderer.prototype.destroyNode = function (node) {
        if (DEBUG) {
            console.error('Renderer > destroyNode > node:', node.toString());
        }
        node.destroyNode();
    };
    ReactRenderer.prototype.createElement = function (name, namespace) {
        if (DEBUG) {
            console.error('Renderer > createElement > name:', name, namespace ? 'namespace:' : '', namespace);
        }
        return new ReactNode(name);
    };
    ReactRenderer.prototype.createComment = function (value) {
        if (DEBUG) {
            console.error('Renderer > createComment > value:', value.trim());
        }
        return new ReactNode().asComment(value);
    };
    ReactRenderer.prototype.createText = function (value) {
        if (DEBUG) {
            console.error('Renderer > createText > value:', value.trim());
        }
        return new ReactNode().asText(value);
    };
    ReactRenderer.prototype.appendChild = function (parent, node) {
        // Only append a child if there is a child to append.
        if (!node) {
            return;
        }
        // Don't append empty text nodes.
        if (!node.shouldRender) {
            return;
        }
        // Provide a parent element reference to the ReactNode.  This will be used later
        // once the ReactNode is fully defined and it is subsequently rendered.
        if (!isReactNode(parent)) {
            if (DEBUG) {
                console.warn('Renderer > appendChild > asDOM > parent:', parent.toString(), 'node:', node.toString());
            }
            node.setRenderPendingCallback = this.rootRenderer.setRenderPendingCallback;
            this.rootRenderer.reactRootNodes.add(node);
            node.parent = parent;
            return;
        }
        if (DEBUG) {
            console.warn('Renderer > appendChild > asReact > parent:', parent.toString(), 'node:', node.toString());
        }
        node.setRenderPendingCallback = function () { return parent.setRenderPending(); };
        parent.addChild(node);
        node.parent = parent;
    };
    ReactRenderer.prototype.insertBefore = function (parent, node, refChild) {
        // Only insert a child if there is a parent.
        if (!parent) {
            return;
        }
        // Provide a parent element reference to the ReactNode.  This will be used later
        // once the ReactNode is fully defined and it is subsequently rendered.  In this
        // case, React cannot "insertBefore".  Instead, we have to create a target element
        // where the ReactNode can be rendered later.
        if (DEBUG) {
            console.warn('Renderer > insertBefore > asDOM > parent:', parent.toString(), 'node:', node.toString(), 'refChild:', refChild.toString());
        }
        var target = document.createElement('div');
        parent.insertBefore(target, refChild);
        node.parent = target;
        node.setRenderPendingCallback = this.rootRenderer.setRenderPendingCallback;
    };
    ReactRenderer.prototype.removeChild = function (parent, node) {
        // Only insert a child if there is a parent.
        if (!parent) {
            return;
        }
        // Remove a parent element reference from the ReactNode.  This will be later
        // result in the ReactNode unloading itself.
        if (!isReactNode(parent)) {
            if (DEBUG) {
                console.warn('Renderer > removeChild > asDOM > parent:', parent.toString(), 'node:', node.toString());
            }
            node.parent = null;
            return;
        }
        if (DEBUG) {
            console.warn('Renderer > removeChild > asReact > parent:', parent.toString(), 'node:', node.toString());
        }
        parent.removeChild(node);
    };
    ReactRenderer.prototype.selectRootElement = function (selectorOrNode) {
        if (DEBUG) {
            console.log('NOT IMPLEMENTED - Renderer > selectRootElement > selectorOrNode:', selectorOrNode);
        }
    };
    ReactRenderer.prototype.parentNode = function (node) {
        if (DEBUG) {
            console.log('NOT IMPLEMENTED - Renderer > parentNode > node:', node.toString());
        }
    };
    ReactRenderer.prototype.nextSibling = function (node) {
        if (DEBUG) {
            console.log('NOT IMPLEMENTED - Renderer > nextSibling > node:', node.toString());
        }
    };
    ReactRenderer.prototype.setAttribute = function (node, name, value, namespace) {
        if (DEBUG) {
            console.log('Renderer > setAttribute > node:', node.toString(), 'name:', name, 'value:', value, namespace ? 'namespace:' : '', namespace);
        }
        node.setProperty(name, value);
    };
    ReactRenderer.prototype.removeAttribute = function (node, name, namespace) {
        if (DEBUG) {
            console.log('Renderer > removeAttribute > node:', node.toString(), 'name:', name, namespace ? 'namespace:' : '', namespace);
        }
        node.removeProperty(name);
    };
    ReactRenderer.prototype.addClass = function (node, name) {
        if (DEBUG) {
            console.log('Renderer > addClass > node:', node.toString(), 'name:', name);
        }
        // Update the virtual node.
        // TODO: This may only support a single class name, but might work if property name is a single
        //       comma-delimited list of classes...
        node.setProperty('className', name);
    };
    ReactRenderer.prototype.removeClass = function (node, name) {
        if (DEBUG) {
            console.log('Renderer > removeClass > node:', node.toString(), 'name:', name);
        }
        // Update the virtual node.
        // TODO: This may not work correctly to remove a single name from a comma-delimited list.
        node.removeProperty('className');
    };
    ReactRenderer.prototype.setStyle = function (node, style, value, flags) {
        // if (DEBUG) { console.log('Renderer > setStyle > node: ', node.toString(), 'style:', style, 'value:', value, 'flags:', flags); }
        if (flags & RendererStyleFlags2.DashCase) {
            node.setProperty('style', { style: value + !!(flags & RendererStyleFlags2.Important) ? ' !important' : '' });
        }
        else {
            node.setProperty('style', { style: value });
        }
    };
    ReactRenderer.prototype.removeStyle = function (node, style, flags) {
        if (DEBUG) {
            console.log('Renderer > removeStyle > node:', node.toString(), 'style:', style, 'flags:', flags);
        }
        node.removeProperty('style', style);
    };
    ReactRenderer.prototype.setProperty = function (node, name, value) {
        if (DEBUG) {
            console.log('Renderer > setProperty > node:', node.toString(), 'name:', name, 'value:', value);
        }
        node.setProperty(name, value);
    };
    ReactRenderer.prototype.setValue = function (node, value) {
        if (DEBUG) {
            console.log('Renderer > setValue > node:', node.toString(), 'value:', value);
        }
        node.setProperty('value', value);
    };
    ReactRenderer.prototype.listen = function (target, event, callback) {
        if (DEBUG) {
            console.log('Renderer > listen > target:', target, 'event:', event);
        }
        target.setProperty(event, callback);
        // TODO: NEEDS WORK: Implement prevent default callback behavior.
        // return <() => void>this.eventManager.addEventListener(
        //            target, event, decoratePreventDefault(callback)) as() => void;
        // tslint:disable-next-line:no-unused-expression
        return function () { return null; };
    };
    return ReactRenderer;
}());
export { ReactRenderer };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVuZGVyZXIuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AYW5ndWxhci1yZWFjdC9jb3JlLyIsInNvdXJjZXMiOlsic3JjL2xpYi9yZW5kZXJlci9yZW5kZXJlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSw0REFBNEQ7QUFDNUQsa0NBQWtDOztBQUVsQyxPQUFPLEVBQUUsVUFBVSxFQUFhLG1CQUFtQixFQUFpQixNQUFNLGVBQWUsQ0FBQztBQUMxRixPQUFPLEVBQUUsWUFBWSxFQUFFLG9CQUFvQixFQUFFLG9CQUFvQixFQUFFLE1BQU0sMkJBQTJCLENBQUM7QUFFckcsT0FBTyxFQUFFLFFBQVEsRUFBRSxNQUFNLHVCQUF1QixDQUFDO0FBQ2pELE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUMvQyxPQUFPLEVBQUUsV0FBVyxFQUFFLFNBQVMsRUFBRSxNQUFNLGNBQWMsQ0FBQztBQUN0RCxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sWUFBWSxDQUFDO0FBQzdDLE9BQU8scUJBQXFCLENBQUM7QUFFN0IsSUFBTSxLQUFLLEdBQUcsS0FBSyxDQUFDO0FBR3BCO0lBQWlELHVEQUFvQjtJQW9CbkUscUNBQVksWUFBMEIsRUFBRSxnQkFBc0M7UUFBOUUsWUFDRSxrQkFBTSxZQUFZLEVBQUUsZ0JBQWdCLEVBQUUsUUFBUSxDQUFDLFNBSWhEO1FBdEJELG9FQUFvRTtRQUNwRSxvRUFBb0U7UUFDcEUsMEVBQTBFO1FBQzFFLGlFQUFpRTtRQUNqRSx1RUFBdUU7UUFDdkUsaUZBQWlGO1FBQzFFLG9CQUFjLEdBQW1CLElBQUksR0FBRyxFQUFFLENBQUM7UUFJbEQsd0VBQXdFO1FBQ3hFLHVFQUF1RTtRQUN2RSx1QkFBdUI7UUFDUCw4QkFBd0IsR0FBRztZQUN6QyxLQUFJLENBQUMsZUFBZSxHQUFHLElBQUksQ0FBQztRQUM5QixDQUFDLENBQUM7UUFLQSxrREFBa0Q7UUFDbEQsS0FBSSxDQUFDLG9CQUFvQixHQUFHLElBQUksYUFBYSxD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QUUsS0FBYTtRQUNyQyxJQUFJLEtBQUssRUFBRTtZQUNULE9BQU8sQ0FBQyxHQUFHLENBQUMsNkJBQTZCLEVBQUUsSUFBSSxDQUFDLFFBQVEsRUFBRSxFQUFFLFFBQVEsRUFBRSxLQUFLLENBQUMsQ0FBQztTQUM5RTtRQUNELElBQUksQ0FBQyxXQUFXLENBQUMsT0FBTyxFQUFFLEtBQUssQ0FBQyxDQUFDO0lBQ25DLENBQUM7SUFFRCw4QkFBTSxHQUFOLFVBQU8sTUFBaUIsRUFBRSxLQUFhLEVBQUUsUUFBaUM7UUFDeEUsSUFBSSxLQUFLLEVBQUU7WUFDVCxPQUFPLENBQUMsR0FBRyxDQUFDLDZCQUE2QixFQUFFLE1BQU0sRUFBRSxRQUFRLEVBQUUsS0FBSyxDQUFDLENBQUM7U0FDckU7UUFDRCxNQUFNLENBQUMsV0FBVyxDQUFDLEtBQUssRUFBRSxRQUFRLENBQUMsQ0FBQztRQUVwQyxpRUFBaUU7UUFDakUseURBQXlEO1FBQ3pELDRFQUE0RTtRQUU1RSxnREFBZ0Q7UUFDaEQsT0FBTyxjQUFNLE9BQUEsSUFBSSxFQUFKLENBQUksQ0FBQztJQUNwQixDQUFDO0lBQ0gsb0JBQUM7QUFBRCxDQUFDLEFBNU9ELElBNE9DIiwic291cmNlc0NvbnRlbnQiOlsiLy8gQ29weXJpZ2h0IChjKSBNaWNyb3NvZnQgQ29ycG9yYXRpb24uIEFsbCByaWdodHMgcmVzZXJ2ZWQuXHJcbi8vIExpY2Vuc2VkIHVuZGVyIHRoZSBNSVQgTGljZW5zZS5cclxuXHJcbmltcG9ydCB7IEluamVjdGFibGUsIFJlbmRlcmVyMiwgUmVuZGVyZXJTdHlsZUZsYWdzMiwgUmVuZGVyZXJUeXBlMiB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBFdmVudE1hbmFnZXIsIMm1RG9tUmVuZGVyZXJGYWN0b3J5MiwgybVEb21TaGFyZWRTdHlsZXNIb3N0IH0gZnJvbSAnQGFuZ3VsYXIvcGxhdGZvcm0tYnJvd3Nlcic7XHJcbmltcG9ydCB7IFN0cmluZ01hcCB9IGZyb20gJy4uL2RlY2xhcmF0aW9ucy9zdHJpbmctbWFwJztcclxuaW1wb3J0IHsgRGlzZ3Vpc2UgfSBmcm9tICcuL2NvbXBvbmVudHMvRGlzZ3Vpc2UnO1xyXG5pbXBvcnQgeyBSZWFjdENvbnRlbnQgfSBmcm9tICcuL3JlYWN0LWNvbnRlbnQnO1xyXG5pbXBvcnQgeyBpc1JlYWN0Tm9kZSwgUmVhY3ROb2RlIH0gZnJvbSAnLi9yZWFjdC1ub2RlJztcclxuaW1wb3J0IHsgcmVnaXN0ZXJFbGVtZW50IH0gZnJvbSAnLi9yZWdpc3RyeSc7XHJcbmltcG9ydCAnLi9nZXRldmVudGxpc3RlbmVycyc7XHJcblxyXG5jb25zdCBERUJVRyA9IGZhbHNlO1xyXG5cclxuQEluamVjdGFibGUoKVxyXG5leHBvcnQgY2xhc3MgQW5ndWxhclJlYWN0UmVuZGVyZXJGYWN0b3J5IGV4dGVuZHMgybVEb21SZW5kZXJlckZhY3RvcnkyIHtcclxuICBwcml2YXRlIHJlYWRvbmx5IGRlZmF1bHRSZWFjdFJlbmRlcmVyOiBSZWFjdFJlbmRlcmVyO1xyXG5cclxuICAvLyBDb2xsZWN0aW9uIG9mIFJlYWN0Tm9kZXMgdGhhdCBjYW4gYmUgZXZhbHVhdGVkIGFuZCBmbHVzaGVkIGF0IHRoZVxyXG4gIC8vIGVuZCBvZiBSZW5kZXIuICBUaGlzIGlzIG5lY2Vzc2FyeSBhcyB0aGUgZmxvdyBvZiBlbGVtZW50IGNyZWF0aW9uXHJcbiAgLy8gYW5kIHVwZGF0ZSBnb2VzIGZyb20gXCJjcmVhdGVcIiA+IFwiaW5zZXJ0XCIgPiBcInVwZGF0ZVwiIHByb3BlcnR5L2F0dHJpYnV0ZS5cclxuICAvLyBSZWFjdCBlbGVtZW50cyBjYW5ub3QgYmUgXCJpbnNlcnRlZFwiIGFuZCBsYXRlciBoYXZlIHRoZWlyIHByb3BzXHJcbiAgLy8gdXBkYXRlZCwgc28gdGhlIFwiaW5zZXJ0XCIsIG9yIFJlYWN0LlJlbmRlciwgY2FuIG9ubHkgYmUgZG9uZSBvbmNlIHRoZVxyXG4gIC8vIGVsZW1lbnQgaGFzIGJlZW4gZnVsbHkgZGVmaW5lZC4gIE9ubHkgdGhlIHRvcG1vc3QgW3Jvb3RdIG5vZGVzIGFyZSBhZGRlZCBoZXJlLlxyXG4gIHB1YmxpYyByZWFjdFJvb3ROb2RlczogU2V0PFJlYWN0Tm9kZT4gPSBuZXcgU2V0KCk7XHJcblxyXG4gIHByaXZhdGUgaXNSZW5kZXJQZW5kaW5nOiBib29sZWFuO1xyXG5cclxuICAvLyBUaGlzIGZsYWcgY2FuIG9ubHkgYmUgc2V0IHRvIHRydWUgZnJvbSBvdXRzaWRlLiAgSXQgY2FuIG9ubHkgYmUgcmVzZXRcclxuICAvLyB0byBmYWxzZSBmcm9tIGluc2lkZS4gIFRoaXMgdmFsdWUgaXMgcmVzZXQgb24gXCJlbmRcIiB3aGVuIHRoZSBwZW5kaW5nXHJcbiAgLy8gcmVuZGVycyBhcmUgZmx1c2hlZC5cclxuICBwdWJsaWMgcmVhZG9ubHkgc2V0UmVuZGVyUGVuZGluZ0NhbGxiYWNrID0gKCkgPT4ge1xyXG4gICAgdGhpcy5pc1JlbmRlclBlbmRpbmcgPSB0cnVlO1xyXG4gIH07XHJcblxyXG4gIGNvbnN0cnVjdG9yKGV2ZW50TWFuYWdlcjogRXZlbnRNYW5hZ2VyLCBzaGFyZWRTdHlsZXNIb3N0OiDJtURvbVNoYXJlZFN0eWxlc0hvc3QpIHtcclxuICAgIHN1cGVyKGV2ZW50TWFuYWdlciwgc2hhcmVkU3R5bGVzSG9zdCwgJ2FwcC1pZCcpO1xyXG5cclxuICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTogbm8tdXNlLWJlZm9yZS1kZWNsYXJlXHJcbiAgICB0aGlzLmRlZmF1bHRSZWFjdFJlbmRlcmVyID0gbmV3IFJlYWN0UmVuZGVyZXIodGhpcyk7XHJcbiAgfVxyXG5cclxuICBjcmVhdGVSZW5kZXJlcihlbGVtZW50OiBhbnksIHR5cGU6IFJlbmRlcmVyVHlwZTIgfCBudWxsKTogUmVuZGVyZXIyIHtcclxuICAgIGlmICh0eXBlICYmIHR5cGUuc3R5bGVzLmxlbmd0aCAmJiB0eXBlLnN0eWxlc1swXSA9PT0gJ3JlYWN0LXJlbmRlcmVyJykge1xyXG4gICAgICByZXR1cm4gdGhpcy5kZWZhdWx0UmVhY3RSZW5kZXJlcjtcclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4gc3VwZXIuY3JlYXRlUmVuZGVyZXIoZWxlbWVudCwgdHlwZSk7XHJcbiAgfVxyXG5cclxuICBiZWdpbigpIHt9XHJcblxyXG4gIGVuZCgpIHtcclxuICAgIGlmIChERUJVRykge1xyXG4gICAgICBjb25zb2xlLmxvZyhcclxuICAgICAgICAnUm9vdFJlbmRlcmVyID4gZW5kID4gaXNSZW5kZXJQZW5kaW5nOicsXHJcbiAgICAgICAgdGhpcy5pc1JlbmRlclBlbmRpbmcsXHJcbiAgICAgICAgJ3JlYWN0Um9vdE5vZGVzOicsXHJcbiAgICAgICAgdGhpcy5yZWFjdFJvb3ROb2Rlc1xyXG4gICAgICApO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIEZsdXNoIGFueSBwZW5kaW5nIFJlYWN0IGVsZW1lbnQgcmVuZGVyIHVwZGF0ZXMuICBUaGlzIGNhbm5vdCBiZSBkb25lXHJcbiAgICAvLyBlYXJsaWVyIChhcyBpcyBkb25lIGZvciBET00gZWxlbWVudHMpIGJlY2F1c2UgUmVhY3QgZWxlbWVudCBwcm9wc1xyXG4gICAgLy8gYXJlIFJlYWRPbmx5LlxyXG5cclxuICAgIGlmICh0aGlzLmlzUmVuZGVyUGVuZGluZykge1xyXG4gICAgICAvLyBSZW1vdmUgcm9vdCBub2RlcyB0aGF0IGFyZSBwZW5kaW5nIGRlc3Ryb3kgYWZ0ZXIgcmVuZGVyLlxyXG4gICAgICB0aGlzLnJlYWN0Um9vdE5vZGVzID0gbmV3IFNldChBcnJheS5mcm9tKHRoaXMucmVhY3RSb290Tm9kZXMpLmZpbHRlcihub2RlID0+ICFub2RlLnJlbmRlcigpLmRlc3Ryb3lQZW5kaW5nKSk7XHJcbiAgICAgIHRoaXMuaXNSZW5kZXJQZW5kaW5nID0gZmFsc2U7XHJcbiAgICB9XHJcbiAgfVxyXG59XHJcblxyXG5leHBvcnQgY29uc3QgaXNSZWFjdFJlbmRlcmVyRGF0YSA9IChkYXRhOiBTdHJpbmdNYXApOiBkYXRhIGlzIFJlYWN0UmVuZGVyZXJEYXRhID0+XHJcbiAgZGF0YSAmJiB0eXBlb2YgKGRhdGEgYXMgUmVhY3RSZW5kZXJlckRhdGEpLmFkZFJvb3ROb2RlID09PSAnZnVuY3Rpb24nO1xyXG5cclxuZXhwb3J0IGludGVyZmFjZSBSZWFjdFJlbmRlcmVyRGF0YSB7XHJcbiAgcmVhZG9ubHkgYWRkUm9vdE5vZGU6IChub2RlOiBSZWFjdE5vZGUpID0+IHZvaWQ7XHJcbn1cclxuXHJcbmV4cG9ydCBjbGFzcyBSZWFjdFJlbmRlcmVyIGltcGxlbWVudHMgUmVuZGVyZXIyIHtcclxuICByZWFkb25seSBkYXRhOiBSZWFjdFJlbmRlcmVyRGF0YSA9IHtcclxuICAgIGFkZFJvb3ROb2RlOiAobm9kZTogUmVhY3ROb2RlKSA9PiB7XHJcbiAgICAgIHRoaXMucm9vdFJlbmRlcmVyLnJlYWN0Um9vdE5vZGVzLmFkZChub2RlKTtcclxuICAgIH0sXHJcbiAgfTtcclxuXHJcbiAgY29uc3RydWN0b3IocHVibGljIHJlYWRvbmx5IHJvb3RSZW5kZXJlcjogQW5ndWxhclJlYWN0UmVuZGVyZXJGYWN0b3J5KSB7XHJcbiAgICAvLyBUaGVzZSB0d28gZWxlbWVudHMgYXJlIGVzc2VudGlhbCBmb3IgdGhlIHdob2xlIGV4cGVyaWVuY2UgdG8gYmUgc21vb3RoIGZvciB0aGUgdXNlciAtIHJlZ2lzdGVyIHRoZW0gZnJvbSB0aGUgZ2V0LWdvLlxyXG4gICAgcmVnaXN0ZXJFbGVtZW50KCdSZWFjdENvbnRlbnQnLCAoKSA9PiBSZWFjdENvbnRlbnQpO1xyXG4gICAgcmVnaXN0ZXJFbGVtZW50KCdEaXNndWlzZScsICgpID0+IERpc2d1aXNlKTtcclxuICB9XHJcblxyXG4gIGRlc3Ryb3koKTogdm9pZCB7fVxyXG5cclxuICBkZXN0cm95Tm9kZShub2RlOiBSZWFjdE5vZGUpOiB2b2lkIHtcclxuICAgIGlmIChERUJVRykge1xyXG4gICAgICBjb25zb2xlLmVycm9yKCdSZW5kZXJlciA+IGRlc3Ryb3lOb2RlID4gbm9kZTonLCBub2RlLnRvU3RyaW5nKCkpO1xyXG4gICAgfVxyXG4gICAgbm9kZS5kZXN0cm95Tm9kZSgpO1xyXG4gIH1cclxuXHJcbiAgY3JlYXRlRWxlbWVudChuYW1lOiBzdHJpbmcsIG5hbWVzcGFjZT86IHN0cmluZyk6IFJlYWN0Tm9kZSB7XHJcbiAgICBpZiAoREVCVUcpIHtcclxuICAgICAgY29uc29sZS5lcnJvcignUmVuZGVyZXIgPiBjcmVhdGVFbGVtZW50ID4gbmFtZTonLCBuYW1lLCBuYW1lc3BhY2UgPyAnbmFtZXNwYWNlOicgOiAnJywgbmFtZXNwYWNlKTtcclxuICAgIH1cclxuICAgIHJldHVybiBuZXcgUmVhY3ROb2RlKG5hbWUpO1xyXG4gIH1cclxuXHJcbiAgY3JlYXRlQ29tbWVudCh2YWx1ZTogc3RyaW5nKTogUmVhY3ROb2RlIHtcclxuICAgIGlmIChERUJVRykge1xyXG4gICAgICBjb25zb2xlLmVycm9yKCdSZW5kZXJlciA+IGNyZWF0ZUNvbW1lbnQgPiB2YWx1ZTonLCB2YWx1ZS50cmltKCkpO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIG5ldyBSZWFjdE5vZGUoKS5hc0NvbW1lbnQodmFsdWUpO1xyXG4gIH1cclxuXHJcbiAgY3JlYXRlVGV4dCh2YWx1ZTogc3RyaW5nKTogUmVhY3ROb2RlIHtcclxuICAgIGlmIChERUJVRykge1xyXG4gICAgICBjb25zb2xlLmVycm9yKCdSZW5kZXJlciA+IGNyZWF0ZVRleHQgPiB2YWx1ZTonLCB2YWx1ZS50cmltKCkpO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIG5ldyBSZWFjdE5vZGUoKS5hc1RleHQodmFsdWUpO1xyXG4gIH1cclxuXHJcbiAgYXBwZW5kQ2hpbGQocGFyZW50OiBIVE1MRWxlbWVudCB8IFJlYWN0Tm9kZSwgbm9kZTogUmVhY3ROb2RlKTogdm9pZCB7XHJcbiAgICAvLyBPbmx5IGFwcGVuZCBhIGNoaWxkIGlmIHRoZXJlIGlzIGEgY2hpbGQgdG8gYXBwZW5kLlxyXG4gICAgaWYgKCFub2RlKSB7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuXHJcbiAgICAvLyBEb24ndCBhcHBlbmQgZW1wdHkgdGV4dCBub2Rlcy5cclxuICAgIGlmICghbm9kZS5zaG91bGRSZW5kZXIpIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIFByb3ZpZGUgYSBwYXJlbnQgZWxlbWVudCByZWZlcmVuY2UgdG8gdGhlIFJlYWN0Tm9kZS4gIFRoaXMgd2lsbCBiZSB1c2VkIGxhdGVyXHJcbiAgICAvLyBvbmNlIHRoZSBSZWFjdE5vZGUgaXMgZnVsbHkgZGVmaW5lZCBhbmQgaXQgaXMgc3Vic2VxdWVudGx5IHJlbmRlcmVkLlxyXG4gICAgaWYgKCFpc1JlYWN0Tm9kZShwYXJlbnQpKSB7XHJcbiAgICAgIGlmIChERUJVRykge1xyXG4gICAgICAgIGNvbnNvbGUud2FybignUmVuZGVyZXIgPiBhcHBlbmRDaGlsZCA+IGFzRE9NID4gcGFyZW50OicsIHBhcmVudC50b1N0cmluZygpLCAnbm9kZTonLCBub2RlLnRvU3RyaW5nKCkpO1xyXG4gICAgICB9XHJcbiAgICAgIG5vZGUuc2V0UmVuZGVyUGVuZGluZ0NhbGxiYWNrID0gdGhpcy5yb290UmVuZGVyZXIuc2V0UmVuZGVyUGVuZGluZ0NhbGxiYWNrO1xyXG5cclxuICAgICAgdGhpcy5yb290UmVuZGVyZXIucmVhY3RSb290Tm9kZXMuYWRkKG5vZGUpO1xyXG4gICAgICBub2RlLnBhcmVudCA9IHBhcmVudDtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG5cclxuICAgIGlmIChERUJVRykge1xyXG4gICAgICBjb25zb2xlLndhcm4oJ1JlbmRlcmVyID4gYXBwZW5kQ2hpbGQgPiBhc1JlYWN0ID4gcGFyZW50OicsIHBhcmVudC50b1N0cmluZygpLCAnbm9kZTonLCBub2RlLnRvU3RyaW5nKCkpO1xyXG4gICAgfVxyXG5cclxuICAgIG5vZGUuc2V0UmVuZGVyUGVuZGluZ0NhbGxiYWNrID0gKCkgPT4gcGFyZW50LnNldFJlbmRlclBlbmRpbmcoKTtcclxuICAgIHBhcmVudC5hZGRDaGlsZChub2RlKTtcclxuICAgIG5vZGUucGFyZW50ID0gcGFyZW50O1xyXG4gIH1cclxuXHJcbiAgaW5zZXJ0QmVmb3JlKHBhcmVudDogSFRNTEVsZW1lbnQgfCB2b2lkLCBub2RlOiBSZWFjdE5vZGUsIHJlZkNoaWxkOiBhbnkpOiB2b2lkIHtcclxuICAgIC8vIE9ubHkgaW5zZXJ0IGEgY2hpbGQgaWYgdGhlcmUgaXMgYSBwYXJlbnQuXHJcbiAgICBpZiAoIXBhcmVudCkge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcblxyXG4gICAgLy8gUHJvdmlkZSBhIHBhcmVudCBlbGVtZW50IHJlZmVyZW5jZSB0byB0aGUgUmVhY3ROb2RlLiAgVGhpcyB3aWxsIGJlIHVzZWQgbGF0ZXJcclxuICAgIC8vIG9uY2UgdGhlIFJlYWN0Tm9kZSBpcyBmdWxseSBkZWZpbmVkIGFuZCBpdCBpcyBzdWJzZXF1ZW50bHkgcmVuZGVyZWQuICBJbiB0aGlzXHJcbiAgICAvLyBjYXNlLCBSZWFjdCBjYW5ub3QgXCJpbnNlcnRCZWZvcmVcIi4gIEluc3RlYWQsIHdlIGhhdmUgdG8gY3JlYXRlIGEgdGFyZ2V0IGVsZW1lbnRcclxuICAgIC8vIHdoZXJlIHRoZSBSZWFjdE5vZGUgY2FuIGJlIHJlbmRlcmVkIGxhdGVyLlxyXG4gICAgaWYgKERFQlVHKSB7XHJcbiAgICAgIGNvbnNvbGUud2FybihcclxuICAgICAgICAnUmVuZGVyZXIgPiBpbnNlcnRCZWZvcmUgPiBhc0RPTSA+IHBhcmVudDonLFxyXG4gICAgICAgIHBhcmVudC50b1N0cmluZygpLFxyXG4gICAgICAgICdub2RlOicsXHJcbiAgICAgICAgbm9kZS50b1N0cmluZygpLFxyXG4gICAgICAgICdyZWZDaGlsZDonLFxyXG4gICAgICAgIHJlZkNoaWxkLnRvU3RyaW5nKClcclxuICAgICAgKTtcclxuICAgIH1cclxuICAgIGNvbnN0IHRhcmdldCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpO1xyXG4gICAgcGFyZW50Lmluc2VydEJlZm9yZSh0YXJnZXQsIHJlZkNoaWxkKTtcclxuICAgIG5vZGUucGFyZW50ID0gdGFyZ2V0O1xyXG4gICAgbm9kZS5zZXRSZW5kZXJQZW5kaW5nQ2FsbGJhY2sgPSB0aGlzLnJvb3RSZW5kZXJlci5zZXRSZW5kZXJQZW5kaW5nQ2FsbGJhY2s7XHJcbiAgfVxyXG5cclxuICByZW1vdmVDaGlsZChwYXJlbnQ6IEhUTUxFbGVtZW50IHwgUmVhY3ROb2RlIHwgdm9pZCwgbm9kZTogUmVhY3ROb2RlKTogdm9pZCB7XHJcbiAgICAvLyBPbmx5IGluc2VydCBhIGNoaWxkIGlmIHRoZXJlIGlzIGEgcGFyZW50LlxyXG4gICAgaWYgKCFwYXJlbnQpIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIFJlbW92ZSBhIHBhcmVudCBlbGVtZW50IHJlZmVyZW5jZSBmcm9tIHRoZSBSZWFjdE5vZGUuICBUaGlzIHdpbGwgYmUgbGF0ZXJcclxuICAgIC8vIHJlc3VsdCBpbiB0aGUgUmVhY3ROb2RlIHVubG9hZGluZyBpdHNlbGYuXHJcbiAgICBpZiAoIWlzUmVhY3ROb2RlKHBhcmVudCkpIHtcclxuICAgICAgaWYgKERFQlVHKSB7XHJcbiAgICAgICAgY29uc29sZS53YXJuKCdSZW5kZXJlciA+IHJlbW92ZUNoaWxkID4gYXNET00gPiBwYXJlbnQ6JywgcGFyZW50LnRvU3RyaW5nKCksICdub2RlOicsIG5vZGUudG9TdHJpbmcoKSk7XHJcbiAgICAgIH1cclxuICAgICAgbm9kZS5wYXJlbnQgPSBudWxsO1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKERFQlVHKSB7XHJcbiAgICAgIGNvbnNvbGUud2FybignUmVuZGVyZXIgPiByZW1vdmVDaGlsZCA+IGFzUmVhY3QgPiBwYXJlbnQ6JywgcGFyZW50LnRvU3RyaW5nKCksICdub2RlOicsIG5vZGUudG9TdHJpbmcoKSk7XHJcbiAgICB9XHJcbiAgICBwYXJlbnQucmVtb3ZlQ2hpbGQobm9kZSk7XHJcbiAgfVxyXG5cclxuICBzZWxlY3RSb290RWxlbWVudChzZWxlY3Rvck9yTm9kZTogc3RyaW5nIHwgYW55KTogYW55IHtcclxuICAgIGlmIChERUJVRykge1xyXG4gICAgICBjb25zb2xlLmxvZygnTk9UIElNUExFTUVOVEVEIC0gUmVuZGVyZXIgPiBzZWxlY3RSb290RWxlbWVudCA+IHNlbGVjdG9yT3JOb2RlOicsIHNlbGVjdG9yT3JOb2RlKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHBhcmVudE5vZGUobm9kZTogUmVhY3ROb2RlKTogYW55IHtcclxuICAgIGlmIChERUJVRykge1xyXG4gICAgICBjb25zb2xlLmxvZygnTk9UIElNUExFTUVOVEVEIC0gUmVuZGVyZXIgPiBwYXJlbnROb2RlID4gbm9kZTonLCBub2RlLnRvU3RyaW5nKCkpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgbmV4dFNpYmxpbmcobm9kZTogYW55KTogYW55IHtcclxuICAgIGlmIChERUJVRykge1xyXG4gICAgICBjb25zb2xlLmxvZygnTk9UIElNUExFTUVOVEVEIC0gUmVuZGVyZXIgPiBuZXh0U2libGluZyA+IG5vZGU6Jywgbm9kZS50b1N0cmluZygpKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHNldEF0dHJpYnV0ZShub2RlOiBSZWFjdE5vZGUsIG5hbWU6IHN0cmluZywgdmFsdWU6IHN0cmluZywgbmFtZXNwYWNlPzogc3RyaW5nKTogdm9pZCB7XHJcbiAgICBpZiAoREVCVUcpIHtcclxuICAgICAgY29uc29sZS5sb2coXHJcbiAgICAgICAgJ1JlbmRlcmVyID4gc2V0QXR0cmlidXRlID4gbm9kZTonLFxyXG4gICAgICAgIG5vZGUudG9TdHJpbmcoKSxcclxuICAgICAgICAnbmFtZTonLFxyXG4gICAgICAgIG5hbWUsXHJcbiAgICAgICAgJ3ZhbHVlOicsXHJcbiAgICAgICAgdmFsdWUsXHJcbiAgICAgICAgbmFtZXNwYWNlID8gJ25hbWVzcGFjZTonIDogJycsXHJcbiAgICAgICAgbmFtZXNwYWNlXHJcbiAgICAgICk7XHJcbiAgICB9XHJcbiAgICBub2RlLnNldFByb3BlcnR5KG5hbWUsIHZhbHVlKTtcclxuICB9XHJcblxyXG4gIHJlbW92ZUF0dHJpYnV0ZShub2RlOiBSZWFjdE5vZGUsIG5hbWU6IHN0cmluZywgbmFtZXNwYWNlPzogc3RyaW5nKTogdm9pZCB7XHJcbiAgICBpZiAoREVCVUcpIHtcclxuICAgICAgY29uc29sZS5sb2coXHJcbiAgICAgICAgJ1JlbmRlcmVyID4gcmVtb3ZlQXR0cmlidXRlID4gbm9kZTonLFxyXG4gICAgICAgIG5vZGUudG9TdHJpbmcoKSxcclxuICAgICAgICAnbmFtZTonLFxyXG4gICAgICAgIG5hbWUsXHJcbiAgICAgICAgbmFtZXNwYWNlID8gJ25hbWVzcGFjZTonIDogJycsXHJcbiAgICAgICAgbmFtZXNwYWNlXHJcbiAgICAgICk7XHJcbiAgICB9XHJcbiAgICBub2RlLnJlbW92ZVByb3BlcnR5KG5hbWUpO1xyXG4gIH1cclxuXHJcbiAgYWRkQ2xhc3Mobm9kZTogUmVhY3ROb2RlLCBuYW1lOiBzdHJpbmcpOiB2b2lkIHtcclxuICAgIGlmIChERUJVRykge1xyXG4gICAgICBjb25zb2xlLmxvZygnUmVuZGVyZXIgPiBhZGRDbGFzcyA+IG5vZGU6Jywgbm9kZS50b1N0cmluZygpLCAnbmFtZTonLCBuYW1lKTtcclxuICAgIH1cclxuXHJcbiAgICAvLyBVcGRhdGUgdGhlIHZpcnR1YWwgbm9kZS5cclxuICAgIC8vIFRPRE86IFRoaXMgbWF5IG9ubHkgc3VwcG9ydCBhIHNpbmdsZSBjbGFzcyBuYW1lLCBidXQgbWlnaHQgd29yayBpZiBwcm9wZXJ0eSBuYW1lIGlzIGEgc2luZ2xlXHJcbiAgICAvLyAgICAgICBjb21tYS1kZWxpbWl0ZWQgbGlzdCBvZiBjbGFzc2VzLi4uXHJcbiAgICBub2RlLnNldFByb3BlcnR5KCdjbGFzc05hbWUnLCBuYW1lKTtcclxuICB9XHJcblxyXG4gIHJlbW92ZUNsYXNzKG5vZGU6IFJlYWN0Tm9kZSwgbmFtZTogc3RyaW5nKTogdm9pZCB7XHJcbiAgICBpZiAoREVCVUcpIHtcclxuICAgICAgY29uc29sZS5sb2coJ1JlbmRlcmVyID4gcmVtb3ZlQ2xhc3MgPiBub2RlOicsIG5vZGUudG9TdHJpbmcoKSwgJ25hbWU6JywgbmFtZSk7XHJcbiAgICB9XHJcblxyXG4gICAgLy8gVXBkYXRlIHRoZSB2aXJ0dWFsIG5vZGUuXHJcbiAgICAvLyBUT0RPOiBUaGlzIG1heSBub3Qgd29yayBjb3JyZWN0bHkgdG8gcmVtb3ZlIGEgc2luZ2xlIG5hbWUgZnJvbSBhIGNvbW1hLWRlbGltaXRlZCBsaXN0LlxyXG4gICAgbm9kZS5yZW1vdmVQcm9wZXJ0eSgnY2xhc3NOYW1lJyk7XHJcbiAgfVxyXG5cclxuICBzZXRTdHlsZShub2RlOiBSZWFjdE5vZGUsIHN0eWxlOiBzdHJpbmcsIHZhbHVlOiBhbnksIGZsYWdzOiBSZW5kZXJlclN0eWxlRmxhZ3MyKTogdm9pZCB7XHJcbiAgICAvLyBpZiAoREVCVUcpIHsgY29uc29sZS5sb2coJ1JlbmRlcmVyID4gc2V0U3R5bGUgPiBub2RlOiAnLCBub2RlLnRvU3RyaW5nKCksICdzdHlsZTonLCBzdHlsZSwgJ3ZhbHVlOicsIHZhbHVlLCAnZmxhZ3M6JywgZmxhZ3MpOyB9XHJcbiAgICBpZiAoZmxhZ3MgJiBSZW5kZXJlclN0eWxlRmxhZ3MyLkRhc2hDYXNlKSB7XHJcbiAgICAgIG5vZGUuc2V0UHJvcGVydHkoJ3N0eWxlJywgeyBzdHlsZTogdmFsdWUgKyAhIShmbGFncyAmIFJlbmRlcmVyU3R5bGVGbGFnczIuSW1wb3J0YW50KSA/ICcgIWltcG9ydGFudCcgOiAnJyB9KTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIG5vZGUuc2V0UHJvcGVydHkoJ3N0eWxlJywgeyBzdHlsZTogdmFsdWUgfSk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICByZW1vdmVTdHlsZShub2RlOiBSZWFjdE5vZGUsIHN0eWxlOiBzdHJpbmcsIGZsYWdzOiBSZW5kZXJlclN0eWxlRmxhZ3MyKTogdm9pZCB7XHJcbiAgICBpZiAoREVCVUcpIHtcclxuICAgICAgY29uc29sZS5sb2coJ1JlbmRlcmVyID4gcmVtb3ZlU3R5bGUgPiBub2RlOicsIG5vZGUudG9TdHJpbmcoKSwgJ3N0eWxlOicsIHN0eWxlLCAnZmxhZ3M6JywgZmxhZ3MpO1xyXG4gICAgfVxyXG4gICAgbm9kZS5yZW1vdmVQcm9wZXJ0eSgnc3R5bGUnLCBzdHlsZSk7XHJcbiAgfVxyXG5cclxuICBzZXRQcm9wZXJ0eShub2RlOiBSZWFjdE5vZGUsIG5hbWU6IHN0cmluZywgdmFsdWU6IGFueSk6IHZvaWQge1xyXG4gICAgaWYgKERFQlVHKSB7XHJcbiAgICAgIGNvbnNvbGUubG9nKCdSZW5kZXJlciA+IHNldFByb3BlcnR5ID4gbm9kZTonLCBub2RlLnRvU3RyaW5nKCksICduYW1lOicsIG5hbWUsICd2YWx1ZTonLCB2YWx1ZSk7XHJcbiAgICB9XHJcbiAgICBub2RlLnNldFByb3BlcnR5KG5hbWUsIHZhbHVlKTtcclxuICB9XHJcblxyXG4gIHNldFZhbHVlKG5vZGU6IFJlYWN0Tm9kZSwgdmFsdWU6IHN0cmluZyk6IHZvaWQge1xyXG4gICAgaWYgKERFQlVHKSB7XHJcbiAgICAgIGNvbnNvbGUubG9nKCdSZW5kZXJlciA+IHNldFZhbHVlID4gbm9kZTonLCBub2RlLnRvU3RyaW5nKCksICd2YWx1ZTonLCB2YWx1ZSk7XHJcbiAgICB9XHJcbiAgICBub2RlLnNldFByb3BlcnR5KCd2YWx1ZScsIHZhbHVlKTtcclxuICB9XHJcblxyXG4gIGxpc3Rlbih0YXJnZXQ6IFJlYWN0Tm9kZSwgZXZlbnQ6IHN0cmluZywgY2FsbGJhY2s6IChldmVudDogYW55KSA9PiBib29sZWFuKTogKCkgPT4gdm9pZCB7XHJcbiAgICBpZiAoREVCVUcpIHtcclxuICAgICAgY29uc29sZS5sb2coJ1JlbmRlcmVyID4gbGlzdGVuID4gdGFyZ2V0OicsIHRhcmdldCwgJ2V2ZW50OicsIGV2ZW50KTtcclxuICAgIH1cclxuICAgIHRhcmdldC5zZXRQcm9wZXJ0eShldmVudCwgY2FsbGJhY2spO1xyXG5cclxuICAgIC8vIFRPRE86IE5FRURTIFdPUks6IEltcGxlbWVudCBwcmV2ZW50IGRlZmF1bHQgY2FsbGJhY2sgYmVoYXZpb3IuXHJcbiAgICAvLyByZXR1cm4gPCgpID0+IHZvaWQ+dGhpcy5ldmVudE1hbmFnZXIuYWRkRXZlbnRMaXN0ZW5lcihcclxuICAgIC8vICAgICAgICAgICAgdGFyZ2V0LCBldmVudCwgZGVjb3JhdGVQcmV2ZW50RGVmYXVsdChjYWxsYmFjaykpIGFzKCkgPT4gdm9pZDtcclxuXHJcbiAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bm8tdW51c2VkLWV4cHJlc3Npb25cclxuICAgIHJldHVybiAoKSA9PiBudWxsO1xyXG4gIH1cclxufVxyXG4iXX0=