/*
Deployment script for BlackLion

This code was generated by a tool.
Changes to this file may cause incorrect behavior and will be lost if
the code is regenerated.
*/

GO
SET ANSI_NULLS, ANSI_PADDING, ANSI_WARNINGS, ARITHABORT, CONCAT_NULL_YIELDS_NULL, QUOTED_IDENTIFIER ON;

SET NUMERIC_ROUNDABORT OFF;


GO
:setvar DatabaseName "BlackLion"
:setvar DefaultFilePrefix "BlackLion"
:setvar DefaultDataPath "E:\SQLServer2017\MSSQL14.MSSQLSERVER\MSSQL\DATA\"
:setvar DefaultLogPath "E:\SQLServer2017\MSSQL14.MSSQLSERVER\MSSQL\DATA\"

GO
:on error exit
GO
/*
Detect SQLCMD mode and disable script execution if SQLCMD mode is not supported.
To re-enable the script after enabling SQLCMD mode, execute the following:
SET NOEXEC OFF; 
*/
:setvar __IsSqlCmdEnabled "True"
GO
IF N'$(__IsSqlCmdEnabled)' NOT LIKE N'True'
    BEGIN
        PRINT N'SQLCMD mode must be enabled to successfully execute this script.';
        SET NOEXEC ON;
    END


GO
USE [$(DatabaseName)];


GO
/*
The column [Items].[ArmorDetail].[InfusionSlots] is being dropped, data loss could occur.
*/

IF EXISTS (select top 1 1 from [Items].[ArmorDetail])
    RAISERROR (N'Rows were detected. The schema update is terminating because data loss might occur.', 16, 127) WITH NOWAIT

GO
PRINT N'Altering [Items].[ArmorDetail]...';


GO
ALTER TABLE [Items].[ArmorDetail] DROP COLUMN [InfusionSlots];


GO
PRINT N'Altering [Items].[Detail]...';


GO
ALTER TABLE [Items].[Detail]
    ADD [BagDetailId]           INT NULL,
        [ConsumableDetailId]    INT NULL,
        [ContainerDetailId]     INT NULL,
        [GatheringToolDetailId] INT NULL;


GO
PRINT N'Creating [Items].[BackItemDetail]...';


GO
CREATE TABLE [Items].[BackItemDetail] (
    [Id]                    INT           IDENTITY (1, 1) NOT NULL,
    [InfixUpgradeId]        INT           NULL,
    [SuffixItemId]          INT           NULL,
    [SecondarySuffixItemId] INT           NULL,
    [StatChoices]           VARCHAR (MAX) NULL,
    CONSTRAINT [PK_Items_BackItemDetail] PRIMARY KEY CLUSTERED ([Id] ASC)
);


GO
PRINT N'Creating [Items].[BagDetail]...';


GO
CREATE TABLE [Items].[BagDetail] (
    [Id]           INT IDENTITY (1, 1) NOT NULL,
    [Size]         INT NOT NULL,
    [NoSellOrSort] BIT NOT NULL,
    CONSTRAINT [PK_Items_BagDetail] PRIMARY KEY CLUSTERED ([Id] ASC)
);


GO
PRINT N'Creating [Items].[ConsumableDetail]...';


GO
CREATE TABLE [Items].[ConsumableDetail] (
    [Id]             INT           IDENTITY (1, 1) NOT NULL,
    [Type]           VARCHAR (100) NOT NULL,
    [Description]    VARCHAR (MAX) NULL,
    [DurationMs]     INT           NULL,
    [UnlockType]     VARCHAR (100) NULL,
    [ColorId]        INT           NULL,
    [RecipeId]       INT           NULL,
    [ExtraRecipeIds] VARCHAR (MAX) NULL,
    [GuildUpgradeId] INT           NULL,
    [ApplyCount]     INT           NULL,
    [Name]           VARCHAR (100) NULL,
    [Icon]           VARCHAR (255) NULL,
    [SkinIds]        VARCHAR (MAX) NULL,
    CONSTRAINT [PK_Items_ConsumableDetail] PRIMARY KEY CLUSTERED ([Id] ASC)
);


GO
PRINT N'Creating [Items].[ContainerDetail]...';


GO
CREATE TABLE [Items].[ContainerDetail] (
    [Id]   INT           IDENTITY (1, 1) NOT NULL,
    [Type] VARCHAR (100) NOT NULL,
    CONSTRAINT [PK_Items_ContainerDetail] PRIMARY KEY CLUSTERED ([Id] ASC)
);


GO
PRINT N'Creating [Items].[GatheringToolDetail]...';


GO
CREATE TABLE [Items].[GatheringToolDetail] (
    [Id]   INT           IDENTITY (1, 1) NOT NULL,
    [Type] VARCHAR (100) NOT NULL,
    CONSTRAINT [PK_Items_GatheringToolDetail] PRIMARY KEY CLUSTERED ([Id] ASC)
);


GO
PRINT N'Creating [Items].[InfusionSlot]...';


GO
CREATE TABLE [Items].[InfusionSlot] (
    [Id]            INT IDENTITY (1, 1) NOT NULL,
    [ArmorDetailId] INT NULL,
    CONSTRAINT [PK_Items_InfusionSlot] PRIMARY KEY CLUSTERED ([Id] ASC)
);


GO
PRINT N'Creating [Items].[FK_BackItemDetail_InfixUpgrade]...';


GO
ALTER TABLE [Items].[BackItemDetail] WITH NOCHECK
    ADD CONSTRAINT [FK_BackItemDetail_InfixUpgrade] FOREIGN KEY ([InfixUpgradeId]) REFERENCES [Items].[InfixUpgrade] ([Id]);


GO
PRINT N'Creating [Items].[FK_Detail_BackItemDetail]...';


GO
ALTER TABLE [Items].[Detail] WITH NOCHECK
    ADD CONSTRAINT [FK_Detail_BackItemDetail] FOREIGN KEY ([BackItemDetailId]) REFERENCES [Items].[BackItemDetail] ([Id]);


GO
PRINT N'Creating [Items].[FK_Detail_BagDetail]...';


GO
ALTER TABLE [Items].[Detail] WITH NOCHECK
    ADD CONSTRAINT [FK_Detail_BagDetail] FOREIGN KEY ([BagDetailId]) REFERENCES [Items].[BagDetail] ([Id]);


GO
PRINT N'Creating [Items].[FK_Detail_ConsumableDetail]...';


GO
ALTER TABLE [Items].[Detail] WITH NOCHECK
    ADD CONSTRAINT [FK_Detail_ConsumableDetail] FOREIGN KEY ([ConsumableDetailId]) REFERENCES [Items].[ConsumableDetail] ([Id]);


GO
PRINT N'Creating [Items].[FK_Detail_ContainerDetail]...';


GO
ALTER TABLE [Items].[Detail] WITH NOCHECK
    ADD CONSTRAINT [FK_Detail_ContainerDetail] FOREIGN KEY ([ContainerDetailId]) REFERENCES [Items].[ContainerDetail] ([Id]);


GO
PRINT N'Creating [Items].[FK_Detail_GatheringToolDetail]...';


GO
ALTER TABLE [Items].[Detail] WITH NOCHECK
    ADD CONSTRAINT [FK_Detail_GatheringToolDetail] FOREIGN KEY ([GatheringToolDetailId]) REFERENCES [Items].[GatheringToolDetail] ([Id]);


GO
PRINT N'Checking existing data against newly created constraints';


GO
USE [$(DatabaseName)];


GO
ALTER TABLE [Items].[BackItemDetail] WITH CHECK CHECK CONSTRAINT [FK_BackItemDetail_InfixUpgrade];

ALTER TABLE [Items].[Detail] WITH CHECK CHECK CONSTRAINT [FK_Detail_BackItemDetail];

ALTER TABLE [Items].[Detail] WITH CHECK CHECK CONSTRAINT [FK_Detail_BagDetail];

ALTER TABLE [Items].[Detail] WITH CHECK CHECK CONSTRAINT [FK_Detail_ConsumableDetail];

ALTER TABLE [Items].[Detail] WITH CHECK CHECK CONSTRAINT [FK_Detail_ContainerDetail];

ALTER TABLE [Items].[Detail] WITH CHECK CHECK CONSTRAINT [FK_Detail_GatheringToolDetail];


GO
PRINT N'Update complete.';


GO
